// =============================================================================
// SCHOLARLY PLATFORM - PRODUCTION DATABASE SCHEMA
// =============================================================================
// 
// This schema supports:
// - Early Years (Little Explorers): Ages 3-7, phonics, numeracy
// - Language Learning (LinguaFlow): 6 languages, CEFR A1-C2, heritage pathways
//
// Design Principles:
// - Multi-tenant isolation via tenantId on all tables
// - Soft deletes where appropriate (deletedAt)
// - Full audit trail (createdAt, updatedAt, createdBy, updatedBy)
// - Optimized indexes for common query patterns
// - Referential integrity with appropriate cascade rules
//
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// PART 1: CORE INFRASTRUCTURE
// =============================================================================

/// Multi-tenant organization
model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  
  // Configuration
  settings  Json     @default("{}")
  features  String[] @default([])
  
  // Subscription
  subscriptionTier   String   @default("free") @map("subscription_tier")
  subscriptionStatus String   @default("active") @map("subscription_status")
  subscriptionEndsAt DateTime? @map("subscription_ends_at")
  
  // Limits
  maxUsers           Int      @default(10) @map("max_users")
  maxChildren        Int      @default(20) @map("max_children")
  
  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relations
  users              User[]
  earlyYearsFamilies EarlyYearsFamily[]
  
  @@index([slug])
  @@index([subscriptionStatus])
  @@map("tenants")
}

/// User account (parent, teacher, admin, tutor)
model User {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Identity
  email        String
  passwordHash String @map("password_hash")
  
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  phone     String?
  avatarUrl String? @map("avatar_url")
  
  // Role & Permissions
  role        String   @default("parent") // parent, teacher, admin, tutor
  permissions String[] @default([])
  
  // Verification
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  
  // Safeguarding (for tutors/teachers)
  wwccNumber    String?   @map("wwcc_number")
  wwccVerified  Boolean   @default(false) @map("wwcc_verified")
  wwccExpiresAt DateTime? @map("wwcc_expires_at")
  
  // Preferences
  timezone String @default("Australia/Sydney")
  locale   String @default("en-AU")
  
  // Status
  status      String    @default("active") // active, suspended, deleted
  lastLoginAt DateTime? @map("last_login_at")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil DateTime? @map("locked_until")
  
  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relations
  earlyYearsFamilies      EarlyYearsFamily[]
  languageLearnerProfiles LanguageLearnerProfile[]
  refreshTokens           RefreshToken[]
  auditLogs               AuditLog[]               @relation("AuditLogUser")
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@map("users")
}

/// Refresh token for JWT authentication
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session identification
  sessionId String   @map("session_id")
  tokenHash String   @map("token_hash")
  
  expiresAt DateTime @map("expires_at")
  
  // Device tracking
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")
  
  // Status
  revokedAt DateTime? @map("revoked_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([userId, sessionId])
  @@index([userId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

/// Audit log for compliance and debugging
model AuditLog {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  
  // Actor
  userId    String? @map("user_id")
  user      User?   @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")
  
  // Action
  action     String // create, read, update, delete, login, logout, etc.
  resource   String // user, family, child, session, etc.
  resourceId String? @map("resource_id")
  
  // Details
  oldValue Json? @map("old_value")
  newValue Json? @map("new_value")
  metadata Json  @default("{}")
  
  // Result
  success Boolean @default(true)
  errorMessage String? @map("error_message")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([action, resource])
  @@index([resourceId])
  @@map("audit_logs")
}

// =============================================================================
// PART 2: EARLY YEARS (LITTLE EXPLORERS)
// =============================================================================

/// Family unit enrolled in Little Explorers
model EarlyYearsFamily {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Primary account holder
  primaryUserId String @map("primary_user_id")
  primaryUser   User   @relation(fields: [primaryUserId], references: [id], onDelete: Cascade)
  
  // Identity
  familyName String? @map("family_name")
  
  // Language & Culture
  primaryLanguage String   @default("en") @map("primary_language")
  homeLanguages   String[] @default([]) @map("home_languages")
  timezone        String   @default("Australia/Sydney")
  
  // Subscription
  subscriptionTier      String    @default("free") @map("subscription_tier")
  subscriptionStatus    String    @default("active") @map("subscription_status")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  
  // Engagement Metrics
  totalLearningMinutes Int       @default(0) @map("total_learning_minutes")
  lastActiveAt         DateTime? @map("last_active_at")
  
  // Compliance (COPPA/GDPR-K)
  dataProcessingConsent Boolean   @default(false) @map("data_processing_consent")
  consentRecordedAt     DateTime? @map("consent_recorded_at")
  consentIpAddress      String?   @map("consent_ip_address")
  
  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relations
  children EarlyYearsChild[]
  
  @@unique([tenantId, primaryUserId])
  @@index([tenantId])
  @@index([subscriptionStatus])
  @@map("early_years_families")
}

/// Child profile (ages 3-7)
model EarlyYearsChild {
  id       String           @id @default(cuid())
  tenantId String           @map("tenant_id")
  familyId String           @map("family_id")
  family   EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Identity (minimal for child privacy)
  firstName     String   @map("first_name")
  preferredName String?  @map("preferred_name")
  dateOfBirth   DateTime @map("date_of_birth")
  avatarId      String?  @map("avatar_id")
  
  // Current State
  currentWorld  String @default("sound_discovery") @map("current_world")
  currentMentor String @default("mimo_owl") @map("current_mentor")
  
  // Engagement
  totalTreasures       Int @default(0) @map("total_treasures")
  totalStars           Int @default(0) @map("total_stars")
  totalLearningMinutes Int @default(0) @map("total_learning_minutes")
  currentStreak        Int @default(0) @map("current_streak")
  longestStreak        Int @default(0) @map("longest_streak")
  lastActiveAt         DateTime? @map("last_active_at")
  
  // Status
  status     String   @default("active")
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  
  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relations
  picturePassword  EarlyYearsPicturePassword?
  phonicsProgress  EarlyYearsPhonicsProgress?
  numeracyProgress EarlyYearsNumeracyProgress?
  sessions         EarlyYearsSession[]
  
  @@index([tenantId, familyId])
  @@index([dateOfBirth])
  @@index([status])
  @@map("early_years_children")
}

/// Picture password for pre-literate authentication
model EarlyYearsPicturePassword {
  id      String          @id @default(cuid())
  childId String          @unique @map("child_id")
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Security (bcrypt hash of image sequence)
  sequenceHash   String @map("sequence_hash")
  sequenceLength Int    @map("sequence_length")
  
  // Brute force protection
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")
  lastAttemptAt  DateTime? @map("last_attempt_at")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("early_years_picture_passwords")
}

/// Phonics progress (Systematic Synthetic Phonics)
model EarlyYearsPhonicsProgress {
  id      String          @id @default(cuid())
  childId String          @unique @map("child_id")
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Phase tracking (1-6)
  currentPhase Int @default(1) @map("current_phase")
  
  // Grapheme mastery
  masteredGraphemes    String[] @default([]) @map("mastered_graphemes")
  introducedGraphemes  String[] @default([]) @map("introduced_graphemes")
  strugglingGraphemes  String[] @default([]) @map("struggling_graphemes")
  
  // Skill metrics (0.0 - 1.0)
  blendingAccuracy   Float @default(0) @map("blending_accuracy")
  segmentingAccuracy Float @default(0) @map("segmenting_accuracy")
  
  // Sight words
  sightWordsMastered   String[] @default([]) @map("sight_words_mastered")
  sightWordsIntroduced String[] @default([]) @map("sight_words_introduced")
  
  // Detailed progress (JSON for flexibility)
  graphemeHistory Json @default("[]") @map("grapheme_history")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("early_years_phonics_progress")
}

/// Numeracy progress (Concrete-Pictorial-Abstract)
model EarlyYearsNumeracyProgress {
  id      String          @id @default(cuid())
  childId String          @unique @map("child_id")
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Level tracking
  currentLevel String @default("foundations") @map("current_level")
  
  // Number sense
  reliableCountingRange Int @default(5) @map("reliable_counting_range")
  workingNumberRange    Int @default(10) @map("working_number_range")
  
  // Skill metrics (0.0 - 1.0)
  subitizingAccuracy   Float @default(0) @map("subitizing_accuracy")
  additionAccuracy     Float @default(0) @map("addition_accuracy")
  subtractionAccuracy  Float @default(0) @map("subtraction_accuracy")
  
  // Numeral recognition
  numeralsRecognized Int[] @default([]) @map("numerals_recognized")
  
  // Detailed progress
  operationHistory Json @default("[]") @map("operation_history")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("early_years_numeracy_progress")
}

/// Learning session
model EarlyYearsSession {
  id       String          @id @default(cuid())
  tenantId String          @map("tenant_id")
  childId  String          @map("child_id")
  child    EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Session info
  sessionType String @default("learning") @map("session_type")
  world       String
  mentor      String
  
  // Timing
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationMinutes Int       @default(0) @map("duration_minutes")
  
  // Activity tracking
  totalActivities      Int @default(0) @map("total_activities")
  activitiesCompleted  Int @default(0) @map("activities_completed")
  
  // Skills practiced
  graphemesPracticed String[] @default([]) @map("graphemes_practiced")
  numbersPracticed   Int[]    @default([]) @map("numbers_practiced")
  
  // Rewards
  treasuresEarned Int @default(0) @map("treasures_earned")
  starsEarned     Int @default(0) @map("stars_earned")
  
  // Engagement
  averageFocusScore Float? @map("average_focus_score")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  activities EarlyYearsActivity[]
  
  @@index([tenantId, childId])
  @@index([startedAt])
  @@index([childId, startedAt])
  @@map("early_years_sessions")
}

/// Individual activity within a session
model EarlyYearsActivity {
  id        String            @id @default(cuid())
  sessionId String            @map("session_id")
  session   EarlyYearsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Activity details
  activityType  String   @map("activity_type")
  targetContent String[] @map("target_content")
  difficulty    Int      @default(1)
  
  // Timing
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationSeconds Int?      @map("duration_seconds")
  
  // Results
  score           Float?
  attempts        Int     @default(1)
  hintsUsed       Int     @default(0) @map("hints_used")
  errorsCommitted Int     @default(0) @map("errors_committed")
  
  // Response data (for analysis)
  responseData Json @default("{}") @map("response_data")
  
  // Reward
  treasureAwarded Boolean @default(false) @map("treasure_awarded")
  
  @@index([sessionId])
  @@index([activityType])
  @@map("early_years_activities")
}

// =============================================================================
// PART 3: LANGUAGE LEARNING (LINGUAFLOW)
// =============================================================================

/// Language learner profile
model LanguageLearnerProfile {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Target language (ISO 639-3)
  targetLanguage String @map("target_language") // fra, cmn, ind, spa, ita, deu
  
  // Native language
  nativeLanguage      String   @map("native_language")
  additionalLanguages String[] @default([]) @map("additional_languages")
  
  // CEFR levels (A1, A2, B1, B2, C1, C2)
  overallLevel   String @default("A1") @map("overall_level")
  listeningLevel String @default("A1") @map("listening_level")
  speakingLevel  String @default("A1") @map("speaking_level")
  readingLevel   String @default("A1") @map("reading_level")
  writingLevel   String @default("A1") @map("writing_level")
  
  // Heritage speaker
  isHeritageSpeaker        Boolean @default(false) @map("is_heritage_speaker")
  heritageProfile          String? @map("heritage_profile")
  heritageOralProficiency  String? @map("heritage_oral_proficiency")
  heritageAcademicLiteracy String? @map("heritage_academic_literacy")
  
  // Curriculum
  curriculumFramework String  @default("ACARA") @map("curriculum_framework")
  yearLevel           String? @map("year_level")
  ibProgramme         String? @map("ib_programme") // PYP, MYP, DP
  ibPhaseOrLevel      String? @map("ib_phase_or_level")
  
  // Gamification
  currentLevel  Int @default(1) @map("current_level")
  totalXp       Int @default(0) @map("total_xp")
  currentStreak Int @default(0) @map("current_streak")
  longestStreak Int @default(0) @map("longest_streak")
  
  // Engagement
  totalLearningMinutes Int       @default(0) @map("total_learning_minutes")
  totalSpeakingMinutes Int       @default(0) @map("total_speaking_minutes")
  lastActiveAt         DateTime? @map("last_active_at")
  
  // Offline
  lastSyncedAt       DateTime? @map("last_synced_at")
  offlineDataVersion Int       @default(0) @map("offline_data_version")
  
  // Status
  status     String   @default("active")
  enrolledAt DateTime @default(now()) @map("enrolled_at")
  
  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relations
  vocabularyProgress LanguageVocabularyProgress?
  heritagePathway    LanguageHeritagePathway?
  conversations      LanguageConversation[]
  achievements       LanguageLearnerAchievement[]
  offlinePackages    LanguageOfflinePackage[]
  
  @@unique([tenantId, userId, targetLanguage])
  @@index([tenantId, targetLanguage])
  @@index([userId])
  @@index([overallLevel])
  @@index([status])
  @@map("language_learner_profiles")
}

/// Vocabulary progress with SRS tracking
model LanguageVocabularyProgress {
  id        String                 @id @default(cuid())
  profileId String                 @unique @map("profile_id")
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Counts
  totalWordsExposed  Int @default(0) @map("total_words_exposed")
  totalWordsMastered Int @default(0) @map("total_words_mastered")
  totalWordsLearning Int @default(0) @map("total_words_learning")
  
  // Coverage tracking
  cefrCoverage  Json @default("{}") @map("cefr_coverage")
  topicCoverage Json @default("{}") @map("topic_coverage")
  
  // Review scheduling
  dueForReview Int       @default(0) @map("due_for_review")
  nextReviewAt DateTime? @map("next_review_at")
  
  // Metrics
  averageRetentionRate Float @default(0) @map("average_retention_rate")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  items LanguageVocabularyItem[]
  
  @@map("language_vocabulary_progress")
}

/// Individual vocabulary item with SM-2 SRS
model LanguageVocabularyItem {
  id         String                     @id @default(cuid())
  progressId String                     @map("progress_id")
  progress   LanguageVocabularyProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  // Word data
  wordId      String @map("word_id")
  word        String
  translation String
  cefrLevel   String @default("A1") @map("cefr_level")
  partOfSpeech String? @map("part_of_speech")
  exampleSentence String? @map("example_sentence")
  audioUrl    String? @map("audio_url")
  
  // Mastery
  masteryLevel String @default("new") @map("mastery_level") // new, learning, reviewing, mastered
  
  // SM-2 SRS fields
  easeFactor   Float     @default(2.5) @map("ease_factor")
  interval     Int       @default(0)
  repetitions  Int       @default(0)
  nextReviewAt DateTime? @map("next_review_at")
  
  // Accuracy tracking
  timesCorrect       Int      @default(0) @map("times_correct")
  timesIncorrect     Int      @default(0) @map("times_incorrect")
  lastAttemptCorrect Boolean? @map("last_attempt_correct")
  
  // Timestamps
  firstEncounteredAt DateTime  @default(now()) @map("first_encountered_at")
  lastPracticedAt    DateTime? @map("last_practiced_at")
  masteredAt         DateTime? @map("mastered_at")
  
  // Pronunciation
  pronunciationScore Float? @map("pronunciation_score")
  
  // Offline
  availableOffline Boolean @default(false) @map("available_offline")
  
  @@unique([progressId, wordId])
  @@index([progressId, nextReviewAt])
  @@index([progressId, masteryLevel])
  @@index([cefrLevel])
  @@map("language_vocabulary_items")
}

/// Heritage speaker pathway
model LanguageHeritagePathway {
  id        String                 @id @default(cuid())
  profileId String                 @unique @map("profile_id")
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Pathway type
  pathwayType String @map("pathway_type")
  // literacy_launch, academic_register, standard_variety, cultural_deepening, accelerated
  
  // Assessment
  assessmentDate DateTime @map("assessment_date")
  
  // Proficiency levels
  oralProficiency       String   @map("oral_proficiency")
  literacyLevel         String   @map("literacy_level")
  academicRegisterLevel String   @map("academic_register_level")
  dialectFeatures       String[] @default([]) @map("dialect_features")
  
  // Curriculum customization
  focusAreas        String[] @default([]) @map("focus_areas")
  skipAreas         String[] @default([]) @map("skip_areas")
  acceleratedTopics String[] @default([]) @map("accelerated_topics")
  
  // Progress
  literacyMilestones Json  @default("{}") @map("literacy_milestones")
  registerProgress   Float @default(0) @map("register_progress")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("language_heritage_pathways")
}

/// AI conversation session
model LanguageConversation {
  id        String                 @id @default(cuid())
  profileId String                 @map("profile_id")
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Conversation setup
  mode      String // role_play, free_conversation, topic_discussion, targeted_practice, ib_oral_practice
  language  String
  cefrLevel String @map("cefr_level")
  
  // AI configuration
  aiRole    String @map("ai_role")
  aiPersona String @map("ai_persona")
  
  // Scenario
  scenarioId    String? @map("scenario_id")
  scenarioTitle String? @map("scenario_title")
  
  // Targets
  targetVocabulary String[] @default([]) @map("target_vocabulary")
  targetStructures String[] @default([]) @map("target_structures")
  
  // Timing
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationMinutes Int       @default(0) @map("duration_minutes")
  
  // Transcript (JSON array of messages)
  messages Json @default("[]")
  
  // Assessment scores (0.0 - 1.0)
  fluencyScore  Float? @map("fluency_score")
  accuracyScore Float? @map("accuracy_score")
  overallScore  Float? @map("overall_score")
  
  // Feedback
  strengths        String[] @default([])
  areasToImprove   String[] @default([]) @map("areas_to_improve")
  vocabularyUsed   String[] @default([]) @map("vocabulary_used")
  errorsNoted      Json     @default("[]") @map("errors_noted")
  
  // Rewards
  xpEarned Int @default(0) @map("xp_earned")
  
  // Flags
  isHeritageVariant Boolean @default(false) @map("is_heritage_variant")
  
  @@index([profileId, startedAt])
  @@index([profileId, mode])
  @@map("language_conversations")
}

/// Achievement definition
model LanguageAchievement {
  id String @id @default(cuid())
  
  // Identity
  code        String @unique
  name        String
  description String
  
  // Categorization
  category String // streak, vocabulary, speaking, listening, reading, writing, grammar, cultural, heritage, milestone
  
  // Display
  iconUrl  String @map("icon_url")
  badgeUrl String @map("badge_url")
  
  // Criteria
  criteriaType  String @map("criteria_type") // count, streak, score, time, level
  criteriaValue Int    @map("criteria_value")
  
  // Reward
  xpReward Int    @default(0) @map("xp_reward")
  rarity   String @default("common") // common, uncommon, rare, epic, legendary
  
  // Flags
  isHidden Boolean @default(false) @map("is_hidden")
  isActive Boolean @default(true) @map("is_active")
  
  // Language-specific (null = all languages)
  language String?
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  learnerAchievements LanguageLearnerAchievement[]
  
  @@index([category])
  @@index([isActive])
  @@map("language_achievements")
}

/// Learner's earned achievement
model LanguageLearnerAchievement {
  id            String                 @id @default(cuid())
  profileId     String                 @map("profile_id")
  profile       LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  achievementId String                 @map("achievement_id")
  achievement   LanguageAchievement    @relation(fields: [achievementId], references: [id])
  
  // Progress
  earnedAt        DateTime @default(now()) @map("earned_at")
  currentProgress Int      @default(0) @map("current_progress")
  targetProgress  Int?     @map("target_progress")
  
  // Display
  celebrationShown Boolean @default(false) @map("celebration_shown")
  
  @@unique([profileId, achievementId])
  @@index([profileId, earnedAt])
  @@map("language_learner_achievements")
}

/// Offline content package
model LanguageOfflinePackage {
  id        String                 @id @default(cuid())
  profileId String                 @map("profile_id")
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Package type
  packageType String @map("package_type")
  // vocabulary_review, lesson_unit, conversation_scenarios, practice_tests, full_sync
  
  // Content
  contentSelection Json @map("content_selection")
  
  // Size
  totalItems              Int   @map("total_items")
  estimatedSizeMb         Float @map("estimated_size_mb")
  estimatedOfflineMinutes Int   @map("estimated_offline_minutes")
  
  // Status
  downloadStatus String    @default("pending") @map("download_status") // pending, downloading, ready, expired, error
  downloadedAt   DateTime? @map("downloaded_at")
  expiresAt      DateTime? @map("expires_at")
  
  // Versioning
  packageVersion Int @default(1) @map("package_version")
  
  // Offline progress (synced on reconnect)
  offlineProgressData   Json      @default("{}") @map("offline_progress_data")
  lastOfflineActivityAt DateTime? @map("last_offline_activity_at")
  pendingSyncItems      Int       @default(0) @map("pending_sync_items")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([profileId, downloadStatus])
  @@index([expiresAt])
  @@map("language_offline_packages")
}

// =============================================================================
// PART 4: ANALYTICS & EVENTS
// =============================================================================

/// Learning event for analytics pipeline
model LearningEvent {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  
  // Event identification
  eventType   String @map("event_type")
  eventSource String @map("event_source") // early_years, linguaflow
  
  // Context
  learnerId String? @map("learner_id")
  sessionId String? @map("session_id")
  
  // Payload
  payload Json
  
  // Timestamps
  occurredAt  DateTime  @default(now()) @map("occurred_at")
  processedAt DateTime? @map("processed_at")
  
  @@index([tenantId, eventType])
  @@index([tenantId, occurredAt])
  @@index([learnerId])
  @@index([processedAt])
  @@map("learning_events")
}

/// ML prediction cache
model MLPrediction {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  
  // Model info
  modelId      String @map("model_id")
  modelVersion String @map("model_version")
  
  // Target
  learnerId      String @map("learner_id")
  predictionType String @map("prediction_type") // at_risk, engagement, proficiency, recommendation
  
  // Result
  prediction Json
  confidence Float
  
  // Lifecycle
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")
  
  @@index([tenantId, learnerId])
  @@index([predictionType])
  @@index([expiresAt])
  @@map("ml_predictions")
}
