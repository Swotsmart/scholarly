// ============================================================================
// PRISMA SCHEMA ADDITIONS FOR PHASE 1: SSI/VC
// ============================================================================
// Add these models to your existing schema.prisma file
// ============================================================================

// ----------------------------------------------------------------------------
// DECENTRALIZED IDENTIFIERS (DIDs)
// ----------------------------------------------------------------------------

/// Decentralized Identifier record
/// Stores DIDs created by users following W3C DID Core 1.0
model DecentralizedIdentifier {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  userId          String   @map("user_id")
  
  /// Full DID string (e.g., did:key:z6Mk...)
  did             String   @unique
  
  /// DID method (web, key, ethr)
  method          String
  
  /// Method-specific identifier portion
  methodSpecificId String  @map("method_specific_id")
  
  /// Controller DID (usually self)
  controller      String
  
  /// Whether this is the user's primary DID
  isPrimary       Boolean  @default(false) @map("is_primary")
  
  /// DID status
  status          DIDStatus @default(ACTIVE)
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deactivatedAt   DateTime? @map("deactivated_at")
  
  /// Relations
  keyPairs        KeyPair[]
  wallet          DigitalWallet? @relation(fields: [walletId], references: [id])
  walletId        String?  @map("wallet_id")
  credentials     VerifiableCredentialRecord[] @relation("CredentialSubject")
  issuedCredentials VerifiableCredentialRecord[] @relation("CredentialIssuer")
  
  @@index([tenantId, userId])
  @@index([tenantId, did])
  @@index([tenantId, isPrimary])
  @@map("decentralized_identifiers")
}

enum DIDStatus {
  ACTIVE
  DEACTIVATED
  REVOKED
}

/// DID Document storage
/// Caches resolved DID documents for performance
model DIDDocument {
  id              String   @id @default(cuid())
  
  /// The DID this document describes
  did             String   @unique
  
  /// JSON-serialized DID document
  document        Json
  
  /// Document version/hash for caching
  documentHash    String   @map("document_hash")
  
  /// When the document was last fetched/updated
  fetchedAt       DateTime @default(now()) @map("fetched_at")
  
  /// TTL for cache invalidation
  expiresAt       DateTime @map("expires_at")
  
  @@map("did_documents")
}

// ----------------------------------------------------------------------------
// KEY MANAGEMENT
// ----------------------------------------------------------------------------

/// Cryptographic key pair associated with a DID
model KeyPair {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Associated DID
  did             String
  didRecord       DecentralizedIdentifier @relation(fields: [did], references: [did])
  
  /// Key type (Ed25519, secp256k1, P-256)
  keyType         KeyType  @map("key_type")
  
  /// Public key (base64url encoded)
  publicKey       String   @map("public_key")
  
  /// Encrypted private key (JSON with ciphertext, iv, tag, salt)
  encryptedPrivateKey String @map("encrypted_private_key") @db.Text
  
  /// Encryption algorithm used
  privateKeyEncryption String @default("AES-256-GCM") @map("private_key_encryption")
  
  /// Key derivation function
  kdf             String   @default("Argon2id")
  
  /// Purposes this key can be used for (JSON array)
  purposes        Json
  
  /// Whether this is the primary key for the DID
  isPrimary       Boolean  @default(false) @map("is_primary")
  
  /// Key status
  status          KeyStatus @default(ACTIVE)
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  expiresAt       DateTime? @map("expires_at")
  revokedAt       DateTime? @map("revoked_at")
  rotatedAt       DateTime? @map("rotated_at")
  
  /// If rotated, reference to the new key
  rotatedToKeyId  String?  @map("rotated_to_key_id")
  
  @@index([tenantId, did])
  @@index([did, isPrimary])
  @@map("key_pairs")
}

enum KeyType {
  Ed25519
  secp256k1
  P256
}

enum KeyStatus {
  ACTIVE
  ROTATED
  REVOKED
  EXPIRED
}

/// Key rotation audit log
model KeyRotationLog {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// DID the key belongs to
  did             String
  
  /// Previous key ID
  previousKeyId   String   @map("previous_key_id")
  
  /// New key ID
  newKeyId        String   @map("new_key_id")
  
  /// Reason for rotation
  reason          KeyRotationReason
  
  /// Who initiated the rotation
  rotatedBy       String   @map("rotated_by")
  
  /// Timestamp
  rotatedAt       DateTime @default(now()) @map("rotated_at")
  
  /// Additional metadata
  metadata        Json?
  
  @@index([tenantId, did])
  @@map("key_rotation_logs")
}

enum KeyRotationReason {
  SCHEDULED
  COMPROMISE_SUSPECTED
  USER_REQUESTED
  POLICY
}

// ----------------------------------------------------------------------------
// DIGITAL WALLETS
// ----------------------------------------------------------------------------

/// User's digital identity wallet
model DigitalWallet {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  userId          String   @unique @map("user_id")
  
  /// Primary DID for this wallet
  primaryDid      String   @map("primary_did")
  
  /// DIDs in this wallet
  dids            DecentralizedIdentifier[]
  
  /// Credentials held in wallet
  credentials     VerifiableCredentialRecord[]
  
  /// Recovery configuration (JSON)
  recoveryConfig  Json     @map("recovery_config")
  
  /// Encryption key identifier
  encryptionKeyId String   @map("encryption_key_id")
  
  /// Wallet status
  status          WalletStatus @default(ACTIVE)
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  lastAccessedAt  DateTime @default(now()) @map("last_accessed_at")
  lockedAt        DateTime? @map("locked_at")
  deactivatedAt   DateTime? @map("deactivated_at")
  
  /// Backups
  backups         WalletBackup[]
  
  @@index([tenantId, userId])
  @@index([tenantId, primaryDid])
  @@map("digital_wallets")
}

enum WalletStatus {
  ACTIVE
  LOCKED
  RECOVERING
  DEACTIVATED
}

/// Encrypted wallet backup
model WalletBackup {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Wallet this backup belongs to
  walletId        String   @map("wallet_id")
  wallet          DigitalWallet @relation(fields: [walletId], references: [id])
  
  /// Backup version
  version         String
  
  /// Encrypted payload (contains full wallet data)
  encryptedPayload String  @map("encrypted_payload") @db.Text
  
  /// Encryption parameters (JSON)
  encryptionParams Json    @map("encryption_params")
  
  /// Integrity checksum
  checksum        String
  
  /// Timestamp
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, walletId])
  @@map("wallet_backups")
}

// ----------------------------------------------------------------------------
// VERIFIABLE CREDENTIALS
// ----------------------------------------------------------------------------

/// Verifiable Credential storage
model VerifiableCredentialRecord {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Credential ID (from the VC itself)
  credentialId    String   @unique @map("credential_id")
  
  /// Credential type(s) (JSON array)
  types           Json
  
  /// Issuer DID
  issuerDid       String   @map("issuer_did")
  issuer          DecentralizedIdentifier @relation("CredentialIssuer", fields: [issuerDid], references: [did])
  
  /// Subject DID (holder)
  subjectDid      String   @map("subject_did")
  subject         DecentralizedIdentifier @relation("CredentialSubject", fields: [subjectDid], references: [did])
  
  /// Wallet holding this credential
  walletId        String?  @map("wallet_id")
  wallet          DigitalWallet? @relation(fields: [walletId], references: [id])
  
  /// Full credential JSON (W3C VC format)
  credential      Json
  
  /// Credential subject data (denormalized for querying)
  subjectData     Json     @map("subject_data")
  
  /// Status list index for revocation
  statusListIndex Int?     @map("status_list_index")
  
  /// Issuance and expiration dates
  issuanceDate    DateTime @map("issuance_date")
  expirationDate  DateTime? @map("expiration_date")
  
  /// Revocation status
  isRevoked       Boolean  @default(false) @map("is_revoked")
  revokedAt       DateTime? @map("revoked_at")
  revocationReason String?  @map("revocation_reason")
  revokedBy       String?  @map("revoked_by")
  
  /// Schema reference
  schemaId        String?  @map("schema_id")
  schema          CredentialSchema? @relation(fields: [schemaId], references: [id])
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, subjectDid])
  @@index([tenantId, issuerDid])
  @@index([tenantId, isRevoked])
  @@index([credentialId])
  @@map("verifiable_credentials")
}

/// Credential schema definitions
model CredentialSchema {
  id              String   @id @default(cuid())
  
  /// Schema name
  name            String
  
  /// Schema version
  version         String
  
  /// Credential type this schema is for
  credentialType  String   @map("credential_type")
  
  /// JSON Schema definition
  schema          Json
  
  /// Author/creator
  author          String
  
  /// Whether this is the default for this type
  isDefault       Boolean  @default(false) @map("is_default")
  
  /// Valid jurisdictions (JSON array, null = all)
  validJurisdictions Json? @map("valid_jurisdictions")
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  /// Credentials using this schema
  credentials     VerifiableCredentialRecord[]
  
  @@unique([credentialType, version])
  @@index([credentialType, isDefault])
  @@map("credential_schemas")
}

/// Status list for credential revocation (Status List 2021)
model CredentialStatusList {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Status list identifier
  statusListId    String   @unique @map("status_list_id")
  
  /// Purpose (revocation or suspension)
  purpose         StatusListPurpose
  
  /// Encoded status list (bitstring)
  encodedList     String   @map("encoded_list") @db.Text
  
  /// Current index (next available slot)
  currentIndex    Int      @default(0) @map("current_index")
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId])
  @@map("credential_status_lists")
}

enum StatusListPurpose {
  REVOCATION
  SUSPENSION
}

// ----------------------------------------------------------------------------
// VERIFIABLE PRESENTATIONS
// ----------------------------------------------------------------------------

/// Verifiable Presentation records
model VerifiablePresentationRecord {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Presentation ID
  presentationId  String   @unique @map("presentation_id")
  
  /// Holder DID
  holderDid       String   @map("holder_did")
  
  /// Full presentation JSON
  presentation    Json
  
  /// Credential IDs included (JSON array)
  credentialIds   Json     @map("credential_ids")
  
  /// Challenge used (for replay protection)
  challenge       String?
  
  /// Domain used
  domain          String?
  
  /// Verification result
  verified        Boolean?
  verifiedAt      DateTime? @map("verified_at")
  
  /// Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, holderDid])
  @@map("verifiable_presentations")
}

// ----------------------------------------------------------------------------
// SSI EVENTS & AUDIT
// ----------------------------------------------------------------------------

/// SSI event audit log
model SSIEventLog {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  /// Event type
  eventType       String   @map("event_type")
  
  /// Actor (user who triggered the event)
  actorId         String   @map("actor_id")
  
  /// Related DID (if applicable)
  did             String?
  
  /// Related credential ID (if applicable)
  credentialId    String?  @map("credential_id")
  
  /// Related wallet ID (if applicable)
  walletId        String?  @map("wallet_id")
  
  /// Event payload (JSON)
  payload         Json
  
  /// Request metadata
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  requestId       String?  @map("request_id")
  
  /// Timestamp
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, eventType])
  @@index([tenantId, actorId])
  @@index([tenantId, did])
  @@index([tenantId, createdAt])
  @@map("ssi_event_logs")
}
