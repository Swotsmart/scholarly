// ============================================================================
// Prisma Schema - Intelligence Mesh v1.5.0
// Assessment & Gradebook Module
// 
// This schema extends the base Scholarly schema with Assessment and Gradebook
// entities. All tables include tenant_id for multi-tenant isolation.
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ASSESSMENT MODULE
// ============================================================================

model AssessmentDefinition {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  schoolId              String   @map("school_id")
  code                  String
  title                 String
  description           String   @db.Text
  purpose               AssessmentPurpose
  format                AssessmentFormat
  
  yearLevels            String[] @map("year_levels")
  subjects              String[]
  curriculumCodes       String[] @map("curriculum_codes")
  learningObjectives    String[] @map("learning_objectives")
  
  totalMarks            Int      @map("total_marks")
  passingMarks          Int?     @map("passing_marks")
  weightInGradebook     Float?   @map("weight_in_gradebook")
  
  duration              Int?     // minutes
  availableFrom         DateTime? @map("available_from")
  availableTo           DateTime? @map("available_to")
  lateSubmissionPolicy  Json?    @map("late_submission_policy")
  
  sections              Json?    // AssessmentSection[]
  rubricId              String?  @map("rubric_id")
  
  aiPolicy              AIPolicy @map("ai_policy")
  aiPolicyExplanation   String?  @map("ai_policy_explanation") @db.Text
  integritySettings     Json     @map("integrity_settings")
  
  allowedAccommodations String[] @map("allowed_accommodations")
  
  peerReviewSettings    Json?    @map("peer_review_settings")
  
  moderationRequired    Boolean  @default(false) @map("moderation_required")
  moderators            String[]
  
  status                AssessmentStatus @default(DRAFT)
  publishedAt           DateTime? @map("published_at")
  publishedBy           String?   @map("published_by")
  
  version               Int      @default(1)
  previousVersionId     String?  @map("previous_version_id")
  
  // Relations
  rubric                RubricDefinition? @relation(fields: [rubricId], references: [id])
  attempts              AssessmentAttempt[]
  analytics             AssessmentAnalytics[]
  peerReviews           PeerReviewAssignment[]
  gradebookItems        GradebookItem[]
  
  @@unique([tenantId, code])
  @@index([tenantId, schoolId])
  @@index([tenantId, status])
  @@index([tenantId, purpose])
  @@map("assessment_definitions")
}

model RubricDefinition {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  schoolId              String   @map("school_id")
  title                 String
  description           String?  @db.Text
  scoringMethod         ScoringMethod @map("scoring_method")
  criteria              Json     // RubricCriterion[]
  maxScore              Int      @map("max_score")
  gradeBoundaries       Json?    @map("grade_boundaries")
  isShared              Boolean  @default(false) @map("is_shared")
  sharedWith            String[] @map("shared_with")
  
  // Relations
  assessments           AssessmentDefinition[]
  
  @@index([tenantId, schoolId])
  @@index([tenantId, isShared])
  @@map("rubric_definitions")
}

model AssessmentAttempt {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  assessmentId          String   @map("assessment_id")
  studentId             String   @map("student_id")
  studentName           String   @map("student_name")
  
  status                AttemptStatus
  attemptNumber         Int      @map("attempt_number")
  
  startedAt             DateTime? @map("started_at")
  lastActivityAt        DateTime? @map("last_activity_at")
  submittedAt           DateTime? @map("submitted_at")
  
  accommodations        String[]
  timeExtension         Int?     @map("time_extension")
  adjustedDuration      Int?     @map("adjusted_duration")
  
  responses             Json     // QuestionResponse[]
  
  submissionMethod      String?  @map("submission_method")
  lateSubmission        Boolean  @default(false) @map("late_submission")
  latePenalty           Float?   @map("late_penalty")
  
  questionsAnswered     Int      @default(0) @map("questions_answered")
  totalQuestions        Int      @map("total_questions")
  sectionsComplete      String[] @map("sections_complete")
  
  processData           Json?    @map("process_data")
  integrityFlags        Json?    @map("integrity_flags")
  
  score                 Float?
  percentageScore       Float?   @map("percentage_score")
  adjustedScore         Float?   @map("adjusted_score")
  masteryEstimate       Float?   @map("mastery_estimate")
  
  overallFeedback       String?  @map("overall_feedback") @db.Text
  teacherComments       String?  @map("teacher_comments") @db.Text
  
  markedAt              DateTime? @map("marked_at")
  markedBy              String?   @map("marked_by")
  reviewedAt            DateTime? @map("reviewed_at")
  reviewedBy            String?   @map("reviewed_by")
  
  appealStatus          String?  @map("appeal_status")
  appealReason          String?  @map("appeal_reason") @db.Text
  appealResolution      String?  @map("appeal_resolution") @db.Text
  
  // Relations
  assessment            AssessmentDefinition @relation(fields: [assessmentId], references: [id])
  peerReviews           PeerReviewAssignment[]
  
  @@unique([tenantId, assessmentId, studentId, attemptNumber])
  @@index([tenantId, studentId])
  @@index([tenantId, assessmentId])
  @@index([tenantId, status])
  @@map("assessment_attempts")
}

model PeerReviewAssignment {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  assessmentId          String   @map("assessment_id")
  attemptId             String   @map("attempt_id")
  
  reviewerId            String   @map("reviewer_id")
  reviewerName          String   @map("reviewer_name")
  authorId              String   @map("author_id")
  
  status                PeerReviewStatus
  
  rubricScores          Json?    @map("rubric_scores")
  overallFeedback       String?  @map("overall_feedback") @db.Text
  strengths             String[]
  improvements          String[]
  
  feedbackQuality       Json?    @map("feedback_quality")
  
  aiSuggestedFeedback   String[] @map("ai_suggested_feedback")
  aiUsedForFeedback     Boolean  @default(false) @map("ai_used_for_feedback")
  
  assignedAt            DateTime @map("assigned_at")
  dueAt                 DateTime @map("due_at")
  startedAt             DateTime? @map("started_at")
  submittedAt           DateTime? @map("submitted_at")
  
  calibrationStatus     String?  @map("calibration_status")
  calibrationAttempts   Int?     @map("calibration_attempts")
  
  // Relations
  assessment            AssessmentDefinition @relation(fields: [assessmentId], references: [id])
  attempt               AssessmentAttempt @relation(fields: [attemptId], references: [id])
  
  @@index([tenantId, reviewerId])
  @@index([tenantId, assessmentId])
  @@index([tenantId, status])
  @@map("peer_review_assignments")
}

model AssessmentAnalytics {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  assessmentId          String   @map("assessment_id")
  classId               String?  @map("class_id")
  generatedAt           DateTime @map("generated_at")
  
  participation         Json     // ParticipationStats
  scoreDistribution     Json     @map("score_distribution") // ScoreDistribution
  gradeDistribution     Json     @map("grade_distribution")
  questionAnalysis      Json     @map("question_analysis")
  curriculumInsights    Json     @map("curriculum_insights")
  comparison            Json?
  concerns              Json
  recommendations       Json
  
  // Relations
  assessment            AssessmentDefinition @relation(fields: [assessmentId], references: [id])
  
  @@unique([tenantId, assessmentId, classId])
  @@index([tenantId, assessmentId])
  @@map("assessment_analytics")
}

model StudentAssessmentProfile {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  studentId             String   @map("student_id")
  
  overallStats          Json     @map("overall_stats")
  subjectPerformance    Json     @map("subject_performance")
  formatPerformance     Json     @map("format_performance")
  learningPatterns      Json     @map("learning_patterns")
  recentAttempts        Json     @map("recent_attempts")
  curriculumMastery     Json     @map("curriculum_mastery")
  recommendations       Json
  
  lastUpdated           DateTime @map("last_updated")
  
  @@unique([tenantId, studentId])
  @@index([tenantId, studentId])
  @@map("student_assessment_profiles")
}

// ============================================================================
// GRADEBOOK MODULE
// ============================================================================

model Gradebook {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  schoolId              String   @map("school_id")
  classId               String   @map("class_id")
  className             String   @map("class_name")
  subject               String
  
  teacherId             String   @map("teacher_id")
  teacherName           String   @map("teacher_name")
  
  periodId              String   @map("period_id")
  periodName            String   @map("period_name")
  periodStart           DateTime @map("period_start")
  periodEnd             DateTime @map("period_end")
  
  gradingPolicyId       String   @map("grading_policy_id")
  categories            Json     // GradebookCategory[]
  studentIds            String[] @map("student_ids")
  
  statistics            Json?
  
  isLocked              Boolean  @default(false) @map("is_locked")
  lockedAt              DateTime? @map("locked_at")
  lockedBy              String?   @map("locked_by")
  
  // Relations
  gradingPolicy         GradingPolicy @relation(fields: [gradingPolicyId], references: [id])
  items                 GradebookItem[]
  
  @@unique([tenantId, classId, periodId])
  @@index([tenantId, teacherId])
  @@index([tenantId, schoolId])
  @@map("gradebooks")
}

model GradingPolicy {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  schoolId              String   @map("school_id")
  name                  String
  description           String?  @db.Text
  
  gradingSystem         GradingSystem @map("grading_system")
  gradeScale            Json     @map("grade_scale") // GradeScaleEntry[]
  
  calculationMethod     CalculationMethod @map("calculation_method")
  categoryWeights       Json     @map("category_weights")
  
  dropLowestEnabled     Boolean  @default(false) @map("drop_lowest_enabled")
  dropLowestCount       Int?     @map("drop_lowest_count")
  
  lateWorkPolicy        Json     @map("late_work_policy")
  missingWorkPolicy     Json     @map("missing_work_policy")
  
  standardsBasedSettings Json?   @map("standards_based_settings")
  
  isDefault             Boolean  @default(false) @map("is_default")
  yearLevels            String[] @map("year_levels")
  subjects              String[]
  
  effectiveFrom         DateTime @map("effective_from")
  effectiveTo           DateTime? @map("effective_to")
  
  // Relations
  gradebooks            Gradebook[]
  
  @@index([tenantId, schoolId])
  @@index([tenantId, isDefault])
  @@map("grading_policies")
}

model GradebookItem {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  gradebookId           String   @map("gradebook_id")
  categoryId            String   @map("category_id")
  
  title                 String
  description           String?  @db.Text
  
  sourceType            String   @map("source_type") // 'manual' | 'assessment' | 'external'
  sourceId              String?  @map("source_id")
  
  maxPoints             Float    @map("max_points")
  curriculumCodes       String[] @map("curriculum_codes")
  
  dueDate               DateTime? @map("due_date")
  
  isExtraCredit         Boolean  @default(false) @map("is_extra_credit")
  countsTowardFinal     Boolean  @default(true) @map("counts_toward_final")
  showToStudents        Boolean  @default(true) @map("show_to_students")
  showToParents         Boolean  @default(true) @map("show_to_parents")
  
  scores                Json     // StudentScore[]
  statistics            Json?
  
  // Relations
  gradebook             Gradebook @relation(fields: [gradebookId], references: [id])
  assessment            AssessmentDefinition? @relation(fields: [sourceId], references: [id])
  
  @@index([tenantId, gradebookId])
  @@index([tenantId, categoryId])
  @@index([tenantId, dueDate])
  @@map("gradebook_items")
}

model ReportCardTemplate {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  schoolId              String   @map("school_id")
  name                  String
  description           String?  @db.Text
  
  yearLevels            String[] @map("year_levels")
  
  headerConfig          Json     @map("header_config")
  gradeTableConfig      Json     @map("grade_table_config")
  narrativeSettings     Json     @map("narrative_settings")
  attendanceSummary     Boolean  @default(true) @map("attendance_summary")
  
  customSections        Json?    @map("custom_sections")
  signatureConfig       Json     @map("signature_config")
  
  isDefault             Boolean  @default(false) @map("is_default")
  isActive              Boolean  @default(true) @map("is_active")
  
  // Relations
  reports               ReportCard[]
  
  @@index([tenantId, schoolId])
  @@index([tenantId, isDefault])
  @@map("report_card_templates")
}

model ReportCard {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")
  updatedBy             String   @map("updated_by")
  
  studentId             String   @map("student_id")
  studentName           String   @map("student_name")
  
  periodId              String   @map("period_id")
  periodName            String   @map("period_name")
  yearLevel             String   @map("year_level")
  
  templateId            String   @map("template_id")
  
  status                ReportStatus
  workflow              Json     // WorkflowStep[]
  
  subjectGrades         Json     @map("subject_grades")
  narratives            Json     // ReportNarrative[]
  
  attendanceSummary     Json?    @map("attendance_summary")
  teacherSignature      Json?    @map("teacher_signature")
  coordinatorSignature  Json?    @map("coordinator_signature")
  principalSignature    Json?    @map("principal_signature")
  parentAcknowledgment  Json?    @map("parent_acknowledgment")
  
  publishedAt           DateTime? @map("published_at")
  
  // Relations
  template              ReportCardTemplate @relation(fields: [templateId], references: [id])
  
  @@unique([tenantId, studentId, periodId])
  @@index([tenantId, studentId])
  @@index([tenantId, periodId])
  @@index([tenantId, status])
  @@map("report_cards")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AssessmentPurpose {
  DIAGNOSTIC
  FORMATIVE
  SUMMATIVE
  BENCHMARK
  REFLECTIVE
  PEER_REVIEW
}

enum AssessmentFormat {
  OBJECTIVE
  CONSTRUCTED_SHORT
  CONSTRUCTED_EXTENDED
  PERFORMANCE
  PROJECT
  PRESENTATION
  PORTFOLIO
  OBSERVATION
  MIXED
}

enum AIPolicy {
  ENCOURAGED
  RESEARCH_ONLY
  GRAMMAR_ONLY
  PROHIBITED
  CITE_REQUIRED
}

enum AssessmentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  PAUSED
  SUBMITTED
  AUTO_SUBMITTED
  MARKING
  AI_MARKED
  TEACHER_REVIEWED
  RETURNED
  RESUBMIT_REQUESTED
  VOIDED
}

enum ScoringMethod {
  ANALYTIC
  HOLISTIC
  CHECKLIST
  STANDARDS_BASED
  PRIMARY_TRAIT
}

enum PeerReviewStatus {
  PENDING_ASSIGNMENT
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  CALIBRATION_NEEDED
  COMPLETE
}

enum GradingSystem {
  PERCENTAGE
  LETTER_GRADE
  STANDARDS_BASED
  PASS_FAIL
  GPA
  CUSTOM
}

enum CalculationMethod {
  MEAN
  WEIGHTED_MEAN
  WEIGHTED_RECENT
  MODE
  HIGHEST_CONSISTENT
  MANUAL
  DECAYING_AVERAGE
}

enum ReportStatus {
  DRAFT
  TEACHER_COMPLETE
  COORDINATOR_REVIEW
  PRINCIPAL_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}
