// ============================================================================
// SCHOLARLY - EARLY YEARS MODULE SCHEMA
// Little Explorers: Complete Data Architecture
// ============================================================================
//
// This schema implements the full Early Years learning platform including:
// - Family & child management with multilingual support
// - Secure authentication for toddlers (Picture Password, etc.)
// - Adaptive phonics, numeracy, and writing engines
// - Affective-responsive AI tracking
// - Parent engagement & quest system
// - Real-time translation infrastructure
// - COPPA/GDPR-K compliance built-in
//
// Design Principles:
// - Privacy-first: Minimal data collection, maximum encryption
// - Child-safe: Age-appropriate access controls throughout
// - Family-centric: Multiple caregivers, cultural adaptation
// - Trust-first: Complete audit trail, parental visibility
//
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto, pgvector(map: "vector")]
}

// ============================================================================
// PART 1: FAMILY & IDENTITY
// ============================================================================

/// Represents a family unit enrolled in Little Explorers
/// A family may have multiple children and multiple caregivers
model EarlyYearsFamily {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  
  // Primary account holder (verified adult)
  primaryAccountUserId    String   @map("primary_account_user_id")
  
  // Family identity
  familyName              String?  @map("family_name")
  
  // Language & cultural settings
  primaryLanguage         String   @default("en") @map("primary_language")
  homeLanguages           String[] @default([]) @map("home_languages")
  preferredAppLanguage    String   @default("en-AU") @map("preferred_app_language")
  culturalBackground      String?  @map("cultural_background")
  culturalPreferences     Json     @default("{}") @map("cultural_preferences")
  timezone                String   @default("Australia/Sydney")
  
  // Subscription & access
  subscriptionTier        String   @default("free") @map("subscription_tier")
  subscriptionStatus      String   @default("active") @map("subscription_status")
  subscriptionExpiresAt   DateTime? @map("subscription_expires_at")
  
  // Physical kit
  kitShippingAddress      Json?    @map("kit_shipping_address")
  kitShipped              Boolean  @default(false) @map("kit_shipped")
  kitShippedAt            DateTime? @map("kit_shipped_at")
  kitTrackingNumber       String?  @map("kit_tracking_number")
  
  // Engagement metrics
  engagementScore         Float    @default(0) @map("engagement_score")
  totalQuestsCompleted    Int      @default(0) @map("total_quests_completed")
  totalLearningMinutes    Int      @default(0) @map("total_learning_minutes")
  lastActiveAt            DateTime? @map("last_active_at")
  
  // Compliance
  dataProcessingConsent   Boolean  @default(false) @map("data_processing_consent")
  marketingConsent        Boolean  @default(false) @map("marketing_consent")
  consentRecordedAt       DateTime? @map("consent_recorded_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  deletedAt               DateTime? @map("deleted_at")
  
  // Relations
  children                EarlyYearsChild[]
  caregivers              FamilyCaregiver[]
  devices                 DeviceTrust[]
  consents                ParentalConsent[]
  securityLogs            SecurityAuditLog[]
  recoveryKey             RecoveryKey?
  familyAchievements      FamilyAchievement[]
  
  @@unique([tenantId, primaryAccountUserId])
  @@index([tenantId])
  @@index([primaryAccountUserId])
  @@index([subscriptionStatus])
  @@map("early_years_families")
}

/// A caregiver who can interact with the child's learning
/// May be parent, grandparent, nanny, aunt/uncle, etc.
model FamilyCaregiver {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Link to Scholarly user (if they have account)
  userId                  String?  @map("user_id")
  
  // Identity
  firstName               String   @map("first_name")
  lastName                String?  @map("last_name")
  relationship            String   // parent, grandparent, guardian, aunt, uncle, nanny, other
  isPrimary               Boolean  @default(false) @map("is_primary")
  
  // Contact
  email                   String?
  phoneNumber             String?  @map("phone_number")
  phoneVerified           Boolean  @default(false) @map("phone_verified")
  preferredContactMethod  String   @default("app") @map("preferred_contact_method") // app, sms, whatsapp, call, email
  
  // Language & accessibility
  primaryLanguage         String   @default("en") @map("primary_language")
  literacyLevel           String   @default("high") @map("literacy_level") // high, moderate, limited, none
  preferredContentMode    String   @default("text") @map("preferred_content_mode") // text, voice, video, visual
  
  // Accessibility needs
  accessibilityNeeds      Json     @default("{}") @map("accessibility_needs")
  // { visualImpairment: bool, hearingImpairment: bool, motorImpairment: bool, 
  //   screenReaderUser: bool, signLanguage: string?, highContrast: bool }
  
  // Communication preferences
  notificationPreferences Json     @default("{}") @map("notification_preferences")
  quietHoursStart         String?  @map("quiet_hours_start") // HH:MM
  quietHoursEnd           String?  @map("quiet_hours_end")
  
  // Quest engagement
  canReceiveQuests        Boolean  @default(true) @map("can_receive_quests")
  questComplexityLevel    String   @default("moderate") @map("quest_complexity_level") // simple, moderate, detailed
  questPreferences        Json     @default("{}") @map("quest_preferences")
  
  // AI-learned profile
  aiProfile               Json     @default("{}") @map("ai_profile")
  // { completionPatterns, bestTimes, preferredQuestTypes, strugglingAreas }
  
  // Permissions
  canUnlockChild          Boolean  @default(true) @map("can_unlock_child")
  canViewProgress         Boolean  @default(true) @map("can_view_progress")
  canModifySettings       Boolean  @default(false) @map("can_modify_settings")
  canBookTutors           Boolean  @default(false) @map("can_book_tutors")
  canMakePurchases        Boolean  @default(false) @map("can_make_purchases")
  
  // Identity verification (for COPPA)
  identityVerified        Boolean  @default(false) @map("identity_verified")
  identityVerifiedAt      DateTime? @map("identity_verified_at")
  verificationMethod      String?  @map("verification_method")
  
  // Status
  status                  String   @default("active") // active, invited, suspended, removed
  invitedAt               DateTime? @map("invited_at")
  acceptedAt              DateTime? @map("accepted_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  questsAssigned          ParentQuest[]
  videoMessages           CaregiverVideoMessage[]
  unlockEvents            ChildSession[] @relation("UnlockedBy")
  
  @@unique([familyId, email])
  @@unique([familyId, phoneNumber])
  @@index([familyId])
  @@index([userId])
  @@index([status])
  @@map("family_caregivers")
}

/// A child enrolled in Little Explorers
model EarlyYearsChild {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Link to main Scholarly learner profile (created when child is enrolled)
  learnerProfileId        String?  @unique @map("learner_profile_id")
  
  // Identity (minimal for privacy)
  firstName               String   @map("first_name")
  preferredName           String?  @map("preferred_name")
  dateOfBirth             DateTime @map("date_of_birth")
  ageAtEnrollment         Int      @map("age_at_enrollment") // Calculated at enrollment
  
  // Avatar & personalization
  avatarType              String   @default("character") @map("avatar_type") // character, animal, custom
  avatarId                String?  @map("avatar_id")
  avatarCustomization     Json     @default("{}") @map("avatar_customization")
  
  // Learning context
  homeLanguage            String   @default("en") @map("home_language")
  additionalLanguages     String[] @default([]) @map("additional_languages")
  schoolEnrollment        String?  @map("school_enrollment") // preschool, kindergarten, homeschool, none
  schoolName              String?  @map("school_name")
  
  // Learning considerations (parent-provided)
  learningConsiderations  Json     @default("{}") @map("learning_considerations")
  // { speechDelay: bool, ESL: bool, giftedness: bool, additionalNeeds: string[], 
  //   preferredLearningStyle: string, attentionSpan: string }
  
  // Program status
  enrollmentStatus        String   @default("active") @map("enrollment_status") // active, paused, graduated, withdrawn
  enrolledAt              DateTime @default(now()) @map("enrolled_at")
  pausedAt                DateTime? @map("paused_at")
  graduatedAt             DateTime? @map("graduated_at")
  withdrawnAt             DateTime? @map("withdrawn_at")
  withdrawalReason        String?  @map("withdrawal_reason")
  
  // Session limits (parent-configured)
  dailySessionLimitMinutes Int     @default(60) @map("daily_session_limit_minutes")
  weeklySessionLimitMinutes Int?   @map("weekly_session_limit_minutes")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  earlyYearsProfile       EarlyYearsProfile?
  authMethods             ChildAuthMethod[]
  sessions                ChildSession[]
  behavioralProfile       BehavioralProfile?
  
  @@index([familyId])
  @@index([enrollmentStatus])
  @@map("early_years_children")
}

// ============================================================================
// PART 2: AUTHENTICATION & SECURITY
// ============================================================================

/// A device trusted by the family for child access
model DeviceTrust {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Device identification (hashed for privacy)
  deviceFingerprint       String   @unique @map("device_fingerprint")
  deviceFingerprintHash   String   @map("device_fingerprint_hash")
  
  // Device info
  deviceName              String   @map("device_name") // "Emma's iPad"
  deviceType              String   @map("device_type") // tablet, phone, computer
  deviceModel             String?  @map("device_model")
  osType                  String?  @map("os_type") // ios, android, web
  osVersion               String?  @map("os_version")
  appVersion              String?  @map("app_version")
  
  // Trust level
  trustLevel              String   @default("standard") @map("trust_level") // standard, high, temporary
  status                  String   @default("active") // active, suspended, revoked
  
  // Security capabilities
  secureEnclaveAvailable  Boolean  @default(false) @map("secure_enclave_available")
  biometricsAvailable     Boolean  @default(false) @map("biometrics_available")
  screenLockEnabled       Boolean  @default(false) @map("screen_lock_enabled")
  
  // Encryption keys (stored in secure enclave on device)
  deviceKeyId             String?  @map("device_key_id") // Reference only, key on device
  
  // Geofencing (optional)
  geofencingEnabled       Boolean  @default(false) @map("geofencing_enabled")
  homeLocationHash        String?  @map("home_location_hash") // Hashed, not precise
  geofenceRadiusMeters    Int?     @map("geofence_radius_meters")
  
  // Auto-lock settings
  autoLockMinutes         Int      @default(30) @map("auto_lock_minutes")
  lockOnLeaveGeofence     Boolean  @default(false) @map("lock_on_leave_geofence")
  
  // Registration
  registeredAt            DateTime @default(now()) @map("registered_at")
  registeredByUserId      String   @map("registered_by_user_id")
  registrationMethod      String   @default("app") @map("registration_method")
  
  // Activity
  lastSeenAt              DateTime @default(now()) @map("last_seen_at")
  lastVerifiedAt          DateTime @default(now()) @map("last_verified_at")
  lastIpHash              String?  @map("last_ip_hash")
  
  // Revocation
  revokedAt               DateTime? @map("revoked_at")
  revokedByUserId         String?  @map("revoked_by_user_id")
  revokedReason           String?  @map("revoked_reason")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  sessions                ChildSession[]
  accessLogs              DeviceAccessLog[]
  childrenAssigned        DeviceChildAssignment[]
  
  @@index([familyId, status])
  @@index([deviceFingerprint])
  @@index([lastSeenAt])
  @@map("device_trusts")
}

/// Links a device to specific children who can use it
model DeviceChildAssignment {
  id                      String   @id @default(cuid())
  deviceId                String   @map("device_id")
  device                  DeviceTrust @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  childId                 String   @map("child_id")
  
  // Access settings for this child on this device
  accessMode              String   @default("picture_password") @map("access_mode")
  // picture_password, parent_unlock, scheduled, trusted_device
  
  // If trusted device mode
  trustedDeviceMode       Boolean  @default(false) @map("trusted_device_mode")
  
  // If scheduled access
  scheduleEnabled         Boolean  @default(false) @map("schedule_enabled")
  scheduleConfig          Json?    @map("schedule_config")
  // { windows: [{ days: [0,1,2,3,4], start: "07:00", end: "08:00" }], timezone: "..." }
  
  assignedAt              DateTime @default(now()) @map("assigned_at")
  assignedByUserId        String   @map("assigned_by_user_id")
  
  @@unique([deviceId, childId])
  @@index([childId])
  @@map("device_child_assignments")
}

/// Authentication method configured for a child
model ChildAuthMethod {
  id                      String   @id @default(cuid())
  childId                 String   @map("child_id")
  child                   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Method type
  methodType              String   @map("method_type")
  // picture_password, parent_unlock, scheduled_access, trusted_device, voice_recognition
  
  isPrimary               Boolean  @default(false) @map("is_primary")
  isBackup                Boolean  @default(false) @map("is_backup")
  
  // Picture password configuration
  picturePasswordHash     String?  @map("picture_password_hash") // Salted hash of image sequence
  picturePasswordSalt     String?  @map("picture_password_salt")
  pictureGridSeed         String?  @map("picture_grid_seed") // For reproducible randomization
  pictureSequenceLength   Int?     @map("picture_sequence_length") // 3 or 4 typically
  pictureGridSize         Int?     @map("picture_grid_size") // 12 or 18 typically
  
  // Voice recognition (optional)
  voicePrintHash          String?  @map("voice_print_hash")
  voicePrintEnrolledAt    DateTime? @map("voice_print_enrolled_at")
  
  // Security settings
  maxAttempts             Int      @default(3) @map("max_attempts")
  lockoutDurationSeconds  Int      @default(300) @map("lockout_duration_seconds")
  requiresParentBackup    Boolean  @default(true) @map("requires_parent_backup")
  
  // State
  status                  String   @default("active") // active, disabled, locked
  failedAttempts          Int      @default(0) @map("failed_attempts")
  lockedUntil             DateTime? @map("locked_until")
  lastUsedAt              DateTime? @map("last_used_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  createdByUserId         String   @map("created_by_user_id")
  
  @@unique([childId, methodType])
  @@index([childId, status])
  @@map("child_auth_methods")
}

/// An authenticated session for a child
model ChildSession {
  id                      String   @id @default(cuid())
  childId                 String   @map("child_id")
  child                   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  deviceId                String   @map("device_id")
  device                  DeviceTrust @relation(fields: [deviceId], references: [id])
  
  // Session token (hashed)
  sessionTokenHash        String   @unique @map("session_token_hash")
  
  // How session was initiated
  authMethod              String   @map("auth_method")
  // picture_password, parent_unlock, scheduled_window, trusted_device, voice
  
  // Timing
  startedAt               DateTime @default(now()) @map("started_at")
  expiresAt               DateTime @map("expires_at")
  endedAt                 DateTime? @map("ended_at")
  lastActivityAt          DateTime @default(now()) @map("last_activity_at")
  
  // If parent unlocked
  unlockedByUserId        String?  @map("unlocked_by_user_id")
  unlockedByCaregiverId   String?  @map("unlocked_by_caregiver_id")
  unlockedByCaregiver     FamilyCaregiver? @relation("UnlockedBy", fields: [unlockedByCaregiverId], references: [id])
  unlockedDurationMinutes Int?     @map("unlocked_duration_minutes")
  
  // If scheduled access
  scheduledWindowId       String?  @map("scheduled_window_id")
  
  // Security tracking
  ipAddressHash           String?  @map("ip_address_hash")
  approximateLocation     String?  @map("approximate_location") // Country/region only
  
  // Behavioral tracking
  behaviorScore           Float    @default(1.0) @map("behavior_score") // 0-1, anomaly detection
  anomaliesDetected       Int      @default(0) @map("anomalies_detected")
  behaviorSamples         Int      @default(0) @map("behavior_samples")
  
  // Session outcomes
  status                  String   @default("active") // active, expired, terminated, locked, extended
  terminationReason       String?  @map("termination_reason")
  // user_logout, session_timeout, parent_terminated, anomaly_detected, device_revoked
  
  // Learning summary (populated on end)
  totalActiveMinutes      Int?     @map("total_active_minutes")
  activitiesCompleted     Int?     @map("activities_completed")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  learningSession         EarlyYearsLearningSession?
  
  @@index([childId, status])
  @@index([deviceId, startedAt])
  @@index([expiresAt])
  @@map("child_sessions")
}

/// Behavioral biometrics profile for anomaly detection
model BehavioralProfile {
  id                      String   @id @default(cuid())
  childId                 String   @unique @map("child_id")
  child                   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Touch behavior patterns
  touchProfile            Json     @default("{}") @map("touch_profile")
  // { avgPressure, pressureStdDev, avgTapDuration, tapDurationStdDev,
  //   avgSwipeSpeed, swipeSpeedStdDev, tapAccuracy, multiTouchFrequency }
  
  // Device handling patterns
  handlingProfile         Json     @default("{}") @map("handling_profile")
  // { preferredOrientation, tiltPatternSignature, movementFrequency,
  //   holdingStyle, deviceStability }
  
  // Response timing patterns
  responseProfile         Json     @default("{}") @map("response_profile")
  // { avgResponseLatency, latencyStdDev, avgPauseDuration, pauseFrequency }
  
  // Session patterns
  sessionProfile          Json     @default("{}") @map("session_profile")
  // { typicalSessionLength, typicalStartTimes, activityTransitionPatterns }
  
  // Voice profile (if enabled)
  voiceProfileHash        String?  @map("voice_profile_hash")
  voiceConfidence         Float?   @map("voice_confidence")
  
  // Profile quality
  dataPointsCollected     Int      @default(0) @map("data_points_collected")
  profileConfidence       Float    @default(0) @map("profile_confidence") // 0-1
  profileMaturity         String   @default("learning") @map("profile_maturity")
  // learning (< 7 days), developing (7-30 days), mature (30+ days)
  
  // Last calibration
  lastCalibratedAt        DateTime @default(now()) @map("last_calibrated_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([childId])
  @@map("behavioral_profiles")
}

/// Log of device access events
model DeviceAccessLog {
  id                      String   @id @default(cuid())
  deviceId                String   @map("device_id")
  device                  DeviceTrust @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  childId                 String?  @map("child_id")
  sessionId               String?  @map("session_id")
  
  // Event
  eventType               String   @map("event_type")
  // unlock_attempt, unlock_success, unlock_failure, session_start, session_end,
  // session_extend, anomaly_detected, lockout_triggered, device_verified
  
  eventResult             String   @map("event_result") // success, failure, blocked
  
  // Details
  authMethodUsed          String?  @map("auth_method_used")
  failureReason           String?  @map("failure_reason")
  // wrong_password, max_attempts, device_revoked, outside_schedule, anomaly
  
  anomalyDetails          Json?    @map("anomaly_details")
  // { anomalyType, confidence, signals }
  
  // Context
  timestamp               DateTime @default(now())
  ipAddressHash           String?  @map("ip_address_hash")
  approximateLocation     String?  @map("approximate_location")
  
  // If parent/caregiver involved
  caregiverId             String?  @map("caregiver_id")
  parentAction            String?  @map("parent_action")
  
  @@index([deviceId, timestamp])
  @@index([childId, timestamp])
  @@index([eventType, timestamp])
  @@map("device_access_logs")
}

/// Parental consent records for COPPA/GDPR-K compliance
model ParentalConsent {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  parentUserId            String   @map("parent_user_id")
  
  // Consent type
  consentType             String   @map("consent_type")
  // essential_data, voice_recording, video_features, affective_monitoring,
  // tutor_communication, progress_sharing, marketing, research_participation
  
  consentVersion          String   @map("consent_version")
  consentTextHash         String   @map("consent_text_hash") // Hash of text they agreed to
  
  // Status
  granted                 Boolean
  grantedAt               DateTime? @map("granted_at")
  revokedAt               DateTime? @map("revoked_at")
  
  // Verification (for COPPA)
  verificationMethod      String?  @map("verification_method")
  // credit_card, id_document, video_call, knowledge_based, signed_form
  verificationId          String?  @map("verification_id")
  verificationCompletedAt DateTime? @map("verification_completed_at")
  verifiableConsent       Boolean  @default(false) @map("verifiable_consent")
  
  // Expiry & renewal
  expiresAt               DateTime? @map("expires_at")
  renewalReminderSentAt   DateTime? @map("renewal_reminder_sent_at")
  
  // IP and context at consent time
  consentIpHash           String?  @map("consent_ip_hash")
  consentUserAgent        String?  @map("consent_user_agent")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([familyId, consentType, consentVersion])
  @@index([familyId])
  @@index([consentType])
  @@index([expiresAt])
  @@map("parental_consents")
}

/// Security audit log for compliance
model SecurityAuditLog {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Event classification
  eventCategory           String   @map("event_category")
  // authentication, authorization, data_access, data_modification, admin_action,
  // consent, communication, safety
  
  eventType               String   @map("event_type")
  severity                String   // info, warning, critical
  
  // Actor
  actorType               String   @map("actor_type") // parent, caregiver, child, system, admin, tutor
  actorId                 String?  @map("actor_id")
  actorRole               String?  @map("actor_role")
  
  // Target
  targetType              String?  @map("target_type") // child, device, session, data, consent
  targetId                String?  @map("target_id")
  
  // Details
  action                  String   // What was done
  details                 Json     // Additional context
  previousValue           Json?    @map("previous_value") // For modifications
  newValue                Json?    @map("new_value")
  
  // Outcome
  outcome                 String   // success, failure, blocked, partial
  failureReason           String?  @map("failure_reason")
  
  // Context
  timestamp               DateTime @default(now())
  ipAddressHash           String?  @map("ip_address_hash")
  userAgent               String?  @map("user_agent")
  deviceId                String?  @map("device_id")
  sessionId               String?  @map("session_id")
  
  // Retention
  retainUntil             DateTime @map("retain_until") // For compliance retention periods
  
  @@index([familyId, timestamp])
  @@index([eventCategory, timestamp])
  @@index([severity, timestamp])
  @@index([actorId, timestamp])
  @@index([targetId])
  @@map("security_audit_logs")
}

/// Recovery key for account recovery
model RecoveryKey {
  id                      String   @id @default(cuid())
  familyId                String   @unique @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Recovery key (encrypted)
  keyHash                 String   @map("key_hash") // For verification
  keySalt                 String   @map("key_salt")
  
  // Generation
  generatedAt             DateTime @default(now()) @map("generated_at")
  generatedByUserId       String   @map("generated_by_user_id")
  
  // Usage
  usedAt                  DateTime? @map("used_at")
  usedReason              String?  @map("used_reason")
  usedIpHash              String?  @map("used_ip_hash")
  
  // Status
  status                  String   @default("active") // active, used, revoked, expired
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("recovery_keys")
}

// ============================================================================
// PART 3: LEARNING PROFILE & PROGRESS
// ============================================================================

/// The child's learning profile in Little Explorers
model EarlyYearsProfile {
  id                      String   @id @default(cuid())
  childId                 String   @unique @map("child_id")
  child                   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Journey State in Alphabetia
  currentWorld            String   @default("sound_discovery") @map("current_world")
  // sound_discovery, letter_land, word_woods, story_kingdom, reading_realm
  currentChapter          Int      @default(1) @map("current_chapter")
  currentPhase            Int      @default(1) @map("current_phase") // Phonics phase 1-5
  storyProgress           Json     @default("{}") @map("story_progress")
  // { worldsCompleted: [], chaptersCompleted: {}, currentQuest: {} }
  
  // Mentor creature
  mentorCreature          String   @default("mimo_owl") @map("mentor_creature")
  // mimo_owl (visual), bongo_bear (kinesthetic), melody_songbird (auditory), puzzle_fox (logical)
  mentorPersonalization   Json     @default("{}") @map("mentor_personalization")
  // { nickname, customGreeting, preferredEncouragements }
  mentorRelationshipLevel Int      @default(1) @map("mentor_relationship_level") // 1-10
  
  // Collections & achievements
  befriendedSprites       String[] @default([]) @map("befriended_sprites")
  collectedTreasures      Int      @default(0) @map("collected_treasures")
  achievementBadges       String[] @default([]) @map("achievement_badges")
  currentStreak           Int      @default(0) @map("current_streak") // Days
  longestStreak           Int      @default(0) @map("longest_streak")
  
  // Inferred learning style (built over time)
  inferredLearningStyle   Json     @default("{}") @map("inferred_learning_style")
  // { visual: 0.7, auditory: 0.2, kinesthetic: 0.1, readWrite: 0.0 }
  
  // Optimal session parameters (learned)
  optimalSessionLength    Int?     @map("optimal_session_length") // minutes
  optimalTimeOfDay        String?  @map("optimal_time_of_day") // morning, afternoon, evening
  optimalActivityMix      Json     @default("{}") @map("optimal_activity_mix")
  
  // Physical kit
  kitActivated            Boolean  @default(false) @map("kit_activated")
  kitActivatedAt          DateTime? @map("kit_activated_at")
  kitComponentsUsed       String[] @default([]) @map("kit_components_used")
  
  // Curriculum alignment
  curriculumFramework     String   @default("ACARA") @map("curriculum_framework")
  curriculumYear          String   @default("Foundation") @map("curriculum_year")
  curriculumMappings      Json     @default("{}") @map("curriculum_mappings")
  // { achievedOutcomes: [], inProgressOutcomes: [], nextOutcomes: [] }
  
  // Overall metrics
  totalLearningMinutes    Int      @default(0) @map("total_learning_minutes")
  totalSessionsCompleted  Int      @default(0) @map("total_sessions_completed")
  averageSessionLength    Float    @default(0) @map("average_session_length")
  lastSessionAt           DateTime? @map("last_session_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  phonicsProgress         PhonicsProgress?
  numeracyProgress        NumeracyProgress?
  writingProgress         WritingProgress?
  learningSessions        EarlyYearsLearningSession[]
  affectiveRecords        AffectiveRecord[]
  assessments             EarlyYearsAssessment[]
  milestones              LearningMilestone[]
  
  @@index([currentPhase])
  @@index([lastSessionAt])
  @@map("early_years_profiles")
}

/// Phonics learning progress
model PhonicsProgress {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Current phase and level
  currentPhase            Int      @default(1) @map("current_phase")
  phaseStartedAt          DateTime @default(now()) @map("phase_started_at")
  estimatedPhaseCompletion DateTime? @map("estimated_phase_completion")
  
  // Phonemic Awareness Skills
  phonemicAwareness       Json     @default("{}") @map("phonemic_awareness")
  // { rhyming: { level, accuracy, lastPracticed },
  //   syllableSegmentation: { level, accuracy, lastPracticed },
  //   initialSound: { level, accuracy, lastPracticed },
  //   finalSound: { level, accuracy, lastPracticed },
  //   medialSound: { level, accuracy, lastPracticed },
  //   blending: { level, accuracy, lastPracticed },
  //   segmenting: { level, accuracy, lastPracticed },
  //   manipulation: { level, accuracy, lastPracticed } }
  
  // Letter-Sound Knowledge (grapheme-phoneme correspondences)
  graphemeKnowledge       Json     @default("{}") @map("grapheme_knowledge")
  // { [grapheme]: { introduced: date, lastPracticed: date, 
  //                 accuracy: float, masteryLevel: string,
  //                 responseTimeMs: int, reviewSchedule: date } }
  
  // Graphemes by mastery level
  masteredGraphemes       String[] @default([]) @map("mastered_graphemes")
  learningGraphemes       String[] @default([]) @map("learning_graphemes")
  introducedGraphemes     String[] @default([]) @map("introduced_graphemes")
  
  // Blending Skills
  blendingSkills          Json     @default("{}") @map("blending_skills")
  // { cvc: { accuracy, speed }, ccvc: {}, cvcc: {}, ccvcc: {},
  //   digraphWords: {}, multisyllable: {} }
  
  // Reading metrics
  currentReadingLevel     String   @default("pre-reader") @map("current_reading_level")
  // pre-reader, emergent, early, transitional, fluent
  decodingAccuracy        Float    @default(0) @map("decoding_accuracy")
  wordsReadCorrectly      Int      @default(0) @map("words_read_correctly")
  totalWordsAttempted     Int      @default(0) @map("total_words_attempted")
  
  // Sight words
  sightWordsKnown         String[] @default([]) @map("sight_words_known")
  sightWordsLearning      String[] @default([]) @map("sight_words_learning")
  
  // Fluency metrics
  readingFluency          Json     @default("{}") @map("reading_fluency")
  // { wcpm: int, accuracy: float, prosodyScore: float, lastAssessed: date }
  
  // Stories completed
  storiesCompleted        String[] @default([]) @map("stories_completed")
  currentStory            String?  @map("current_story")
  
  // Error patterns (for targeted instruction)
  errorPatterns           Json     @default("[]") @map("error_patterns")
  // [{ type: "substitution", pattern: "b/d", frequency: 5, lastOccurred: date }]
  
  // Challenging areas (need extra practice)
  challengingGraphemes    String[] @default([]) @map("challenging_graphemes")
  challengingSkills       String[] @default([]) @map("challenging_skills")
  
  // Strong areas (for confidence building)
  strongGraphemes         String[] @default([]) @map("strong_graphemes")
  strongSkills            String[] @default([]) @map("strong_skills")
  
  // Spaced repetition schedule
  reviewSchedule          Json     @default("{}") @map("review_schedule")
  // { [grapheme]: { nextReview: date, interval: days, easeFactor: float } }
  
  // Audit
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("phonics_progress")
}

/// Numeracy learning progress
model NumeracyProgress {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Current level
  currentLevel            String   @default("foundations") @map("current_level")
  // foundations, counting_mastery, operations_intro, operations_fluency
  
  // Number Sense
  numberSense             Json     @default("{}") @map("number_sense")
  // { cardinality: { level, accuracy }, oneToOne: {}, subitizing: {},
  //   conservation: {}, comparison: {}, composition: {} }
  
  // Counting Skills
  countingForward         Json     @default("{}") @map("counting_forward")
  // { maxReliable: 10, maxAttempted: 15, accuracy: 0.95,
  //   skipCountingBy2: { max, accuracy }, skipCountingBy5: {}, skipCountingBy10: {} }
  
  countingBackward        Json     @default("{}") @map("counting_backward")
  // { maxReliable: 5, accuracy: 0.80 }
  
  // Number range mastery
  reliableRange           Int      @default(5) @map("reliable_range")
  workingRange            Int      @default(10) @map("working_range")
  exposedRange            Int      @default(20) @map("exposed_range")
  
  // Number Recognition
  numeralRecognition      Json     @default("{}") @map("numeral_recognition")
  // { [numeral]: { recognized: bool, accuracy: float, responseTimeMs: int } }
  
  numeralsRecognized      Int[]    @default([]) @map("numerals_recognized")
  
  // Number Words
  numberWords             Json     @default("{}") @map("number_words")
  // { [word]: { recognized: bool, canWrite: bool } }
  
  // Operations
  additionSkills          Json     @default("{}") @map("addition_skills")
  // { within5: { accuracy, strategies }, within10: {}, within20: {},
  //   strategiesUsed: ["counting_all", "counting_on", "known_facts"] }
  
  subtractionSkills       Json     @default("{}") @map("subtraction_skills")
  // Same structure
  
  // Problem types mastered
  problemTypesMastered    Json     @default("{}") @map("problem_types_mastered")
  // { resultUnknown: bool, changeUnknown: bool, startUnknown: bool,
  //   comparison: bool, equalizing: bool }
  
  // Other concepts
  patternSkills           Json     @default("{}") @map("pattern_skills")
  // { recognition: { level }, extension: {}, creation: {} }
  
  shapeKnowledge          Json     @default("{}") @map("shape_knowledge")
  // { [shape]: { recognized: bool, canName: bool, properties: bool } }
  
  measurementAwareness    Json     @default("{}") @map("measurement_awareness")
  // { length: {}, weight: {}, capacity: {}, time: {} }
  
  spatialAwareness        Json     @default("{}") @map("spatial_awareness")
  // { positionWords: {}, directionality: {}, symmetry: {} }
  
  // Word problems
  wordProblemSkills       Json     @default("{}") @map("word_problem_skills")
  // { comprehension: float, extraction: float, solving: float }
  
  // Audit
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("numeracy_progress")
}

/// Writing development progress
model WritingProgress {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Fine Motor Development
  fineMotorDevelopment    Json     @default("{}") @map("fine_motor_development")
  // { gripType: "tripod|quadrupod|palmar", pressureControl: 0.8,
  //   lineQuality: 0.7, enduranceMinutes: 5, pencilControlLevel: 3 }
  
  // Letter Formation
  letterFormation         Json     @default("{}") @map("letter_formation")
  // { [letter]: { quality: float, consistency: float, speed: float,
  //               commonErrors: [], introduced: date, lastPracticed: date } }
  
  lettersFormed           String[] @default([]) @map("letters_formed") // Can form recognizably
  lettersMastered         String[] @default([]) @map("letters_mastered") // Consistent, correct
  
  // Spelling Development
  spellingStage           String   @default("pre_phonetic") @map("spelling_stage")
  // pre_phonetic, semi_phonetic, phonetic, transitional, conventional
  
  spellingStageHistory    Json     @default("[]") @map("spelling_stage_history")
  // [{ stage, reachedAt, evidence }]
  
  // Words they can spell correctly
  conventionalSpellings   String[] @default([]) @map("conventional_spellings")
  
  // Composition
  compositionLevel        String   @default("pre_writing") @map("composition_level")
  // pre_writing, drawing_with_labels, simple_sentences, multiple_sentences, paragraphs
  
  longestComposition      Int      @default(0) @map("longest_composition") // words
  writingStamina          Int      @default(0) @map("writing_stamina") // minutes of sustained writing
  
  // Name writing
  canWriteFirstName       Boolean  @default(false) @map("can_write_first_name")
  firstNameQuality        Float?   @map("first_name_quality")
  
  // Audit
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  writingSamples          WritingSample[]
  
  @@map("writing_progress")
}

/// Collected writing samples
model WritingSample {
  id                      String   @id @default(cuid())
  progressId              String   @map("progress_id")
  progress                WritingProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  // Sample type
  sampleType              String   @map("sample_type")
  // letter_practice, name_writing, invented_spelling, dictation, 
  // free_write, sentence_completion, story_writing
  
  // Prompt/context
  prompt                  String?
  activityId              String?  @map("activity_id")
  
  // Content
  imageUrl                String?  @map("image_url") // Scan/photo of writing
  imageStorageKey         String?  @map("image_storage_key")
  transcription           String?  // Adult transcription of what child wrote
  intendedMeaning         String?  @map("intended_meaning") // What child said they wrote
  
  // Analysis
  analysis                Json     @default("{}") @map("analysis")
  // { letterFormationScores: {}, spellingAnalysis: {}, 
  //   compositionAnalysis: {}, feedbackGiven: [] }
  
  spellingStageEvidence   String?  @map("spelling_stage_evidence")
  
  // Context
  supportLevel            String   @default("independent") @map("support_level")
  // independent, minimal_help, moderate_help, heavily_scaffolded
  
  timeSpentSeconds        Int?     @map("time_spent_seconds")
  writingTool             String?  @map("writing_tool") // pencil, marker, stylus, finger
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([progressId, createdAt])
  @@map("writing_samples")
}

// ============================================================================
// PART 4: LEARNING SESSIONS & ACTIVITIES
// ============================================================================

/// A learning session in Little Explorers
model EarlyYearsLearningSession {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Link to auth session
  authSessionId           String?  @unique @map("auth_session_id")
  authSession             ChildSession? @relation(fields: [authSessionId], references: [id])
  
  // Timing
  startedAt               DateTime @default(now()) @map("started_at")
  endedAt                 DateTime? @map("ended_at")
  totalDurationSeconds    Int?     @map("total_duration_seconds")
  activeDurationSeconds   Int?     @map("active_duration_seconds") // Excluding pauses
  
  // Context
  world                   String   // Which world they were in
  chapter                 Int
  deviceType              String?  @map("device_type")
  
  // Parent presence
  parentPresent           Boolean  @default(false) @map("parent_present")
  caregiverId             String?  @map("caregiver_id")
  
  // Activities completed
  activitiesCompleted     Json     @default("[]") @map("activities_completed")
  // [{ activityId, type, startTime, endTime, score, attempts, scaffoldingLevel, 
  //    graphemesPracticed, skillsTargeted, outcome }]
  
  totalActivities         Int      @default(0) @map("total_activities")
  
  // Learning data
  graphemesPracticed      String[] @default([]) @map("graphemes_practiced")
  graphemesIntroduced     String[] @default([]) @map("graphemes_introduced")
  wordsRead               String[] @default([]) @map("words_read")
  wordsAttempted          String[] @default([]) @map("words_attempted")
  numbersWorkedWith       Int[]    @default([]) @map("numbers_worked_with")
  skillsTargeted          String[] @default([]) @map("skills_targeted")
  
  // Performance
  overallAccuracy         Float?   @map("overall_accuracy")
  itemsAttempted          Int      @default(0) @map("items_attempted")
  itemsCorrect            Int      @default(0) @map("items_correct")
  hintsUsed               Int      @default(0) @map("hints_used")
  scaffoldingEvents       Int      @default(0) @map("scaffolding_events")
  
  // Affective summary
  engagementSummary       Json     @default("{}") @map("engagement_summary")
  // { averageEngagement: float, frustrationEvents: int, flowMinutes: int,
  //   moodTrajectory: [], dominantMood: string }
  
  // System adaptations during session
  adaptationsMade         Json     @default("[]") @map("adaptations_made")
  // [{ timestamp, trigger, action, outcome }]
  
  // Rewards earned
  treasuresEarned         Int      @default(0) @map("treasures_earned")
  badgesEarned            String[] @default([]) @map("badges_earned")
  spritesUnlocked         String[] @default([]) @map("sprites_unlocked")
  
  // End state
  endReason               String?  @map("end_reason")
  // completed, time_limit, user_exit, parent_ended, session_timeout, error
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  affectiveRecords        AffectiveRecord[]
  activityAttempts        ActivityAttempt[]
  
  @@index([profileId, startedAt])
  @@index([startedAt])
  @@map("early_years_learning_sessions")
}

/// Individual activity attempt within a session
model ActivityAttempt {
  id                      String   @id @default(cuid())
  sessionId               String   @map("session_id")
  session                 EarlyYearsLearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Activity identification
  activityType            String   @map("activity_type")
  // phoneme_identification, grapheme_matching, blending_practice, word_reading,
  // story_reading, counting, number_recognition, addition_practice, subtraction_practice,
  // letter_formation, spelling, free_writing
  
  activityId              String   @map("activity_id")
  activityVariant         String?  @map("activity_variant")
  
  // Timing
  startedAt               DateTime @default(now()) @map("started_at")
  completedAt             DateTime? @map("completed_at")
  durationSeconds         Int?     @map("duration_seconds")
  
  // Difficulty
  difficultyLevel         Int      @map("difficulty_level") // 1-10
  scaffoldingLevel        Int      @default(3) @map("scaffolding_level") // 1-5
  
  // Content targeted
  targetGraphemes         String[] @default([]) @map("target_graphemes")
  targetWords             String[] @default([]) @map("target_words")
  targetNumbers           Int[]    @default([]) @map("target_numbers")
  targetSkills            String[] @default([]) @map("target_skills")
  
  // Performance
  attempts                Int      @default(1)
  correctOnFirstTry       Boolean? @map("correct_on_first_try")
  finalResult             String?  @map("final_result") // correct, incorrect, partial, skipped
  score                   Float?   // 0-1
  
  // Response data
  responseTimeMs          Int?     @map("response_time_ms")
  hintsUsed               Int      @default(0) @map("hints_used")
  errorsBeforeSuccess     Int      @default(0) @map("errors_before_success")
  
  // Error analysis
  errorTypes              String[] @default([]) @map("error_types")
  // substitution, omission, addition, reversal, sequencing, etc.
  
  // Affective state during activity
  affectiveState          String?  @map("affective_state")
  engagementLevel         Float?   @map("engagement_level") // 0-1
  
  // Adaptations triggered
  adaptationTriggered     Boolean  @default(false) @map("adaptation_triggered")
  adaptationType          String?  @map("adaptation_type")
  
  @@index([sessionId, startedAt])
  @@index([activityType])
  @@map("activity_attempts")
}

/// Affective (emotional) state records
model AffectiveRecord {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  sessionId               String?  @map("session_id")
  session                 EarlyYearsLearningSession? @relation(fields: [sessionId], references: [id])
  
  timestamp               DateTime @default(now())
  
  // Raw signals observed
  signals                 Json     @default("{}") @map("signals")
  // { responseLatency: int, errorType: string, touchPressure: float,
  //   pauseDuration: int, clickPattern: string, retryBehavior: string }
  
  // Inferred state
  inferredMood            String   @map("inferred_mood")
  // engaged, frustrated, bored, confident, anxious, tired, distressed
  
  cognitiveLoad           String   @map("cognitive_load") // low, optimal, high
  flowState               Boolean  @default(false) @map("flow_state")
  motivationLevel         String   @default("medium") @map("motivation_level") // high, medium, low
  
  // Confidence in inference
  inferenceConfidence     Float    @default(0.5) @map("inference_confidence")
  
  // System response
  systemResponseTriggered Boolean  @default(false) @map("system_response_triggered")
  systemResponse          String?  @map("system_response")
  // encouragement, reduce_difficulty, increase_challenge, suggest_break,
  // mentor_intervention, parent_alert, none
  
  responseOutcome         String?  @map("response_outcome")
  // improved, no_change, worsened, session_ended
  
  @@index([profileId, timestamp])
  @@index([sessionId])
  @@index([inferredMood])
  @@map("affective_records")
}

/// Learning milestones achieved
model LearningMilestone {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Milestone identification
  milestoneType           String   @map("milestone_type")
  // phonics, numeracy, writing, reading, social_emotional, overall
  
  milestoneCode           String   @map("milestone_code")
  // e.g., "PHONICS_PHASE1_COMPLETE", "FIRST_CVC_WORD", "COUNTS_TO_20"
  
  milestoneName           String   @map("milestone_name")
  milestoneDescription    String   @map("milestone_description")
  
  // Achievement
  achievedAt              DateTime @default(now()) @map("achieved_at")
  evidenceSessionId       String?  @map("evidence_session_id")
  evidenceData            Json?    @map("evidence_data")
  
  // Curriculum alignment
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  // Celebration
  celebrated              Boolean  @default(false)
  celebratedAt            DateTime? @map("celebrated_at")
  celebratedWith          String[] @default([]) @map("celebrated_with") // caregiver IDs
  
  // Parent notification
  parentNotified          Boolean  @default(false) @map("parent_notified")
  parentNotifiedAt        DateTime? @map("parent_notified_at")
  
  @@unique([profileId, milestoneCode])
  @@index([profileId, achievedAt])
  @@index([milestoneType])
  @@map("learning_milestones")
}

/// Formal and informal assessments
model EarlyYearsAssessment {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 EarlyYearsProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Assessment type
  assessmentType          String   @map("assessment_type")
  // phonemic_awareness, letter_sounds, blending, decoding, sight_words,
  // reading_fluency, reading_comprehension, number_sense, counting,
  // operations, writing_skills, fine_motor, overall_readiness
  
  assessmentCode          String   @map("assessment_code")
  assessmentVersion       String   @map("assessment_version")
  
  // Administration
  administeredAt          DateTime @default(now()) @map("administered_at")
  administrator           String   // system, parent, tutor, teacher
  setting                 String   // app, video_call, in_person
  
  // Timing
  plannedDurationMinutes  Int?     @map("planned_duration_minutes")
  actualDurationSeconds   Int?     @map("actual_duration_seconds")
  
  // Results
  completed               Boolean  @default(false)
  rawResults              Json     @map("raw_results") // Item-by-item data
  
  // Scores
  rawScore                Float?   @map("raw_score")
  scaledScore             Float?   @map("scaled_score")
  percentile              Float?
  ageEquivalent           String?  @map("age_equivalent")
  gradeEquivalent         String?  @map("grade_equivalent")
  performanceLevel        String?  @map("performance_level")
  // below_expectation, approaching, meeting, exceeding
  
  // Interpretation
  strengths               String[] @default([])
  areasForGrowth          String[] @default([]) @map("areas_for_growth")
  recommendations         Json     @default("[]")
  nextSteps               Json     @default("[]") @map("next_steps")
  
  // Comparison to previous
  previousAssessmentId    String?  @map("previous_assessment_id")
  growthFromPrevious      Json?    @map("growth_from_previous")
  
  // Sharing
  sharedWithParent        Boolean  @default(false) @map("shared_with_parent")
  sharedWithParentAt      DateTime? @map("shared_with_parent_at")
  sharedWithEducator      Boolean  @default(false) @map("shared_with_educator")
  sharedWithEducatorId    String?  @map("shared_with_educator_id")
  
  // Curriculum alignment
  curriculumOutcomes      String[] @default([]) @map("curriculum_outcomes")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([profileId, assessmentType, administeredAt])
  @@index([administeredAt])
  @@map("early_years_assessments")
}

// ============================================================================
// PART 5: PARENT ENGAGEMENT & QUESTS
// ============================================================================

/// A quest assigned to a parent/caregiver
model ParentQuest {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  childId                 String   @map("child_id")
  caregiverId             String   @map("caregiver_id")
  caregiver               FamilyCaregiver @relation(fields: [caregiverId], references: [id])
  
  // Quest definition reference
  questDefinitionId       String   @map("quest_definition_id")
  questDefinition         QuestDefinition @relation(fields: [questDefinitionId], references: [id])
  
  // Personalization
  personalizedTitle       String?  @map("personalized_title")
  personalizedInstructions Json?   @map("personalized_instructions")
  childFirstName          String   @map("child_first_name")
  
  // Complexity adaptation
  complexityLevel         String   @default("moderate") @map("complexity_level")
  
  // Delivery
  deliveryLanguage        String   @default("en") @map("delivery_language")
  deliveryMode            String   @default("text") @map("delivery_mode")
  
  // Scheduling
  assignedAt              DateTime @default(now()) @map("assigned_at")
  suggestedTime           String?  @map("suggested_time")
  dueBy                   DateTime? @map("due_by")
  reminderSentAt          DateTime? @map("reminder_sent_at")
  
  // Status
  status                  String   @default("assigned")
  viewedAt                DateTime? @map("viewed_at")
  startedAt               DateTime? @map("started_at")
  completedAt             DateTime? @map("completed_at")
  skippedAt               DateTime? @map("skipped_at")
  skipReason              String?  @map("skip_reason")
  
  // Feedback
  feedbackRating          Int?     @map("feedback_rating")
  feedbackDifficulty      String?  @map("feedback_difficulty")
  feedbackChildEnjoyment  Int?     @map("feedback_child_enjoyment")
  feedbackNotes           String?  @map("feedback_notes")
  feedbackVoiceUrl        String?  @map("feedback_voice_url")
  
  // Rewards
  pointsEarned            Int      @default(0) @map("points_earned")
  
  // Learning connection
  targetSkills            String[] @default([]) @map("target_skills")
  targetGraphemes         String[] @default([]) @map("target_graphemes")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([familyId, assignedAt])
  @@index([caregiverId, status])
  @@index([childId])
  @@map("parent_quests")
}

/// Quest template/definition
model QuestDefinition {
  id                      String   @id @default(cuid())
  tenantId                String?  @map("tenant_id")
  
  code                    String   @unique
  version                 Int      @default(1)
  questType               String   @map("quest_type")
  category                String
  
  // Content
  title                   String
  shortDescription        String   @map("short_description")
  fullInstructions        String   @map("full_instructions") @db.Text
  parentScript            String?  @map("parent_script") @db.Text
  tips                    String[] @default([])
  
  // Variants
  simpleInstructions      String?  @map("simple_instructions") @db.Text
  detailedInstructions    String?  @map("detailed_instructions") @db.Text
  
  // Media
  demoVideoUrl            String?  @map("demo_video_url")
  thumbnailUrl            String?  @map("thumbnail_url")
  iconEmoji               String?  @map("icon_emoji")
  
  // Targeting
  targetAgeMin            Int      @default(3) @map("target_age_min")
  targetAgeMax            Int      @default(7) @map("target_age_max")
  targetPhases            Int[]    @default([]) @map("target_phases")
  targetSkills            String[] @default([]) @map("target_skills")
  
  // Timing
  estimatedMinutes        Int      @default(5) @map("estimated_minutes")
  basePoints              Int      @default(10) @map("base_points")
  
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  translations            QuestTranslation[]
  assignments             ParentQuest[]
  
  @@index([questType, category])
  @@map("quest_definitions")
}

/// Translated quest content
model QuestTranslation {
  id                      String   @id @default(cuid())
  questDefinitionId       String   @map("quest_definition_id")
  questDefinition         QuestDefinition @relation(fields: [questDefinitionId], references: [id], onDelete: Cascade)
  
  languageCode            String   @map("language_code")
  title                   String
  shortDescription        String   @map("short_description")
  fullInstructions        String   @map("full_instructions") @db.Text
  parentScript            String?  @map("parent_script") @db.Text
  tips                    String[] @default([])
  simpleInstructions      String?  @map("simple_instructions") @db.Text
  detailedInstructions    String?  @map("detailed_instructions") @db.Text
  
  audioInstructionsUrl    String?  @map("audio_instructions_url")
  demoVideoDubbedUrl      String?  @map("demo_video_dubbed_url")
  
  translationType         String   @default("machine") @map("translation_type")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([questDefinitionId, languageCode])
  @@map("quest_translations")
}

/// Video messages between caregivers and tutors
model CaregiverVideoMessage {
  id                      String   @id @default(cuid())
  caregiverId             String   @map("caregiver_id")
  caregiver               FamilyCaregiver @relation(fields: [caregiverId], references: [id])
  familyId                String   @map("family_id")
  
  direction               String
  otherPartyType          String   @map("other_party_type")
  otherPartyId            String?  @map("other_party_id")
  
  originalLanguage        String   @map("original_language")
  originalVideoUrl        String?  @map("original_video_url")
  originalAudioUrl        String?  @map("original_audio_url")
  originalDurationSeconds Int?     @map("original_duration_seconds")
  originalTranscript      String?  @map("original_transcript") @db.Text
  
  relatedChildId          String?  @map("related_child_id")
  topic                   String?
  
  status                  String   @default("processing")
  processedAt             DateTime? @map("processed_at")
  viewedAt                DateTime? @map("viewed_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  translations            VideoMessageTranslation[]
  
  @@index([caregiverId, createdAt])
  @@index([familyId])
  @@map("caregiver_video_messages")
}

/// Translated video message
model VideoMessageTranslation {
  id                      String   @id @default(cuid())
  messageId               String   @map("message_id")
  message                 CaregiverVideoMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  targetLanguage          String   @map("target_language")
  translatedVideoUrl      String?  @map("translated_video_url")
  translatedAudioUrl      String?  @map("translated_audio_url")
  translatedTranscript    String?  @map("translated_transcript") @db.Text
  captionsUrl             String?  @map("captions_url")
  signLanguageVideoUrl    String?  @map("sign_language_video_url")
  
  status                  String   @default("processing")
  processedAt             DateTime? @map("processed_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@unique([messageId, targetLanguage])
  @@map("video_message_translations")
}

/// Family achievements
model FamilyAchievement {
  id                      String   @id @default(cuid())
  familyId                String   @map("family_id")
  family                  EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  achievementCode         String   @map("achievement_code")
  achievementName         String   @map("achievement_name")
  achievementDescription  String   @map("achievement_description")
  achievementType         String   @map("achievement_type")
  
  earnedAt                DateTime @default(now()) @map("earned_at")
  earnedBy                String[] @default([]) @map("earned_by")
  relatedChildIds         String[] @default([]) @map("related_child_ids")
  
  pointsAwarded           Int      @default(0) @map("points_awarded")
  badgeAwarded            String?  @map("badge_awarded")
  
  @@unique([familyId, achievementCode])
  @@index([familyId, earnedAt])
  @@map("family_achievements")
}

// ============================================================================
// PART 6: CONTENT & CURRICULUM
// ============================================================================

/// Sound Sprite character
model SoundSprite {
  id                      String   @id @default(cuid())
  
  phoneme                 String   @unique
  graphemes               String[]
  ipa                     String
  
  name                    String
  personality             String
  backstory               String   @db.Text
  catchphrase             String?
  
  imageUrl                String   @map("image_url")
  animationUrl            String?  @map("animation_url")
  pronunciationUrl        String   @map("pronunciation_url")
  songUrl                 String?  @map("song_url")
  
  phase                   Int
  introductionOrder       Int      @map("introduction_order")
  prerequisiteSprites     String[] @default([]) @map("prerequisite_sprites")
  keyWords                String[] @map("key_words")
  mnemonicPhrase          String?  @map("mnemonic_phrase")
  
  mouthPositionImageUrl   String?  @map("mouth_position_image_url")
  articulationVideoUrl    String?  @map("articulation_video_url")
  
  similarInLanguages      Json     @default("{}") @map("similar_in_languages")
  challengingFor          String[] @default([]) @map("challenging_for")
  contrastiveSupport      Json     @default("{}") @map("contrastive_support")
  
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  translations            SoundSpriteTranslation[]
  
  @@index([phase, introductionOrder])
  @@map("sound_sprites")
}

/// Translated Sound Sprite
model SoundSpriteTranslation {
  id                      String   @id @default(cuid())
  spriteId                String   @map("sprite_id")
  sprite                  SoundSprite @relation(fields: [spriteId], references: [id], onDelete: Cascade)
  
  languageCode            String   @map("language_code")
  name                    String
  personality             String
  backstory               String   @db.Text
  catchphrase             String?
  
  pronunciationUrl        String?  @map("pronunciation_url")
  keyWords                String[] @map("key_words")
  mnemonicPhrase          String?  @map("mnemonic_phrase")
  
  translationType         String   @default("machine") @map("translation_type")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([spriteId, languageCode])
  @@map("sound_sprite_translations")
}

/// Decodable story
model DecodableStory {
  id                      String   @id @default(cuid())
  tenantId                String?  @map("tenant_id")
  
  code                    String   @unique
  title                   String
  series                  String?
  sequenceInSeries        Int?     @map("sequence_in_series")
  
  coverImageUrl           String   @map("cover_image_url")
  pages                   Json
  totalPages              Int      @map("total_pages")
  
  phase                   Int
  requiredGraphemes       String[] @map("required_graphemes")
  introducesGraphemes     String[] @default([]) @map("introduces_graphemes")
  sightWordsUsed          String[] @map("sight_words_used")
  
  wordCount               Int      @map("word_count")
  uniqueWords             Int      @map("unique_words")
  averageSentenceLength   Float    @map("average_sentence_length")
  decodabilityScore       Float    @map("decodability_score")
  readingLevel            String   @map("reading_level")
  
  themes                  String[] @default([])
  comprehensionQuestions  Json     @default("[]") @map("comprehension_questions")
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  timesRead               Int      @default(0) @map("times_read")
  averageRating           Float    @default(0) @map("average_rating")
  
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  culturalVariants        StoryCulturalVariant[]
  translations            StoryTranslation[]
  
  @@index([phase])
  @@index([readingLevel])
  @@map("decodable_stories")
}

/// Cultural variant of story
model StoryCulturalVariant {
  id                      String   @id @default(cuid())
  storyId                 String   @map("story_id")
  story                   DecodableStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  
  cultureCode             String   @map("culture_code")
  characterNames          Json     @map("character_names")
  settingDescription      String?  @map("setting_description")
  adaptedPages            Json     @map("adapted_pages")
  
  foodReferences          String[] @default([]) @map("food_references")
  familyStructure         String?  @map("family_structure")
  illustrationVariant     String?  @map("illustration_variant")
  
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@unique([storyId, cultureCode])
  @@map("story_cultural_variants")
}

/// Translated story
model StoryTranslation {
  id                      String   @id @default(cuid())
  storyId                 String   @map("story_id")
  story                   DecodableStory @relation(fields: [storyId], references: [id], onDelete: Cascade)
  
  languageCode            String   @map("language_code")
  title                   String
  translatedPages         Json     @map("translated_pages")
  comprehensionQuestions  Json     @default("[]") @map("comprehension_questions")
  
  translationType         String   @default("machine") @map("translation_type")
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@unique([storyId, languageCode])
  @@map("story_translations")
}

// ============================================================================
// PART 7: TRANSLATION INFRASTRUCTURE
// ============================================================================

/// Translation cache
model TranslationCache {
  id                      String   @id @default(cuid())
  
  sourceLanguage          String   @map("source_language")
  sourceTextHash          String   @map("source_text_hash")
  sourceText              String   @map("source_text") @db.Text
  
  targetLanguage          String   @map("target_language")
  translatedText          String   @map("translated_text") @db.Text
  
  context                 String?
  simplificationLevel     String   @default("standard") @map("simplification_level")
  
  translationType         String   @default("machine") @map("translation_type")
  qualityScore            Float?   @map("quality_score")
  
  audioUrl                String?  @map("audio_url")
  
  usageCount              Int      @default(1) @map("usage_count")
  lastUsedAt              DateTime @default(now()) @map("last_used_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@unique([sourceTextHash, targetLanguage, simplificationLevel])
  @@index([sourceLanguage, targetLanguage])
  @@map("translation_cache")
}

/// Supported languages
model SupportedLanguage {
  id                      String   @id @default(cuid())
  
  code                    String   @unique
  name                    String
  nativeName              String   @map("native_name")
  
  script                  String
  direction               String   @default("ltr")
  
  tier                    Int
  supportLevel            String   @map("support_level")
  
  uiTranslated            Boolean  @default(false) @map("ui_translated")
  contentTranslated       Boolean  @default(false) @map("content_translated")
  voiceAvailable          Boolean  @default(false) @map("voice_available")
  videoDubbingAvailable   Boolean  @default(false) @map("video_dubbing_available")
  signLanguageAvailable   Boolean  @default(false) @map("sign_language_available")
  signLanguageCode        String?  @map("sign_language_code")
  
  voiceIds                Json     @default("{}") @map("voice_ids")
  
  phonicsAdaptationAvailable Boolean @default(false) @map("phonics_adaptation_available")
  challengingSoundsForEnglish String[] @default([]) @map("challenging_sounds_for_english")
  
  isActive                Boolean  @default(false) @map("is_active")
  launchDate              DateTime? @map("launch_date")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([tier, isActive])
  @@map("supported_languages")
}

// ============================================================================
// PART 8: EYE TRACKING & GAZE ANALYTICS
// ============================================================================

/// Gaze tracking session during reading
model GazeTrackingSession {
  id                      String   @id @default(cuid())
  learningSessionId       String   @map("learning_session_id")
  profileId               String   @map("profile_id")
  
  // Tracking method
  trackingMethod          String   @map("tracking_method")
  // device_camera, external_tracker, hybrid, touch_inferred
  
  // Device/tracker info
  trackerType             String?  @map("tracker_type")
  trackerModel            String?  @map("tracker_model")
  samplingRateHz          Int?     @map("sampling_rate_hz")
  
  // Calibration
  calibrationQuality      Float?   @map("calibration_quality")
  calibrationMethod       String?  @map("calibration_method")
  calibratedAt            DateTime? @map("calibrated_at")
  
  // Session timing
  startedAt               DateTime @default(now()) @map("started_at")
  endedAt                 DateTime? @map("ended_at")
  totalTrackingSeconds    Int?     @map("total_tracking_seconds")
  validTrackingPercent    Float?   @map("valid_tracking_percent")
  
  // Environmental factors
  lightingCondition       String?  @map("lighting_condition")
  headMovementLevel       String?  @map("head_movement_level")
  
  // Session quality
  dataQualityScore        Float?   @map("data_quality_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  // Relations
  readingGazeAnalyses     ReadingGazeAnalysis[]
  
  @@index([profileId, startedAt])
  @@index([learningSessionId])
  @@map("gaze_tracking_sessions")
}

/// Gaze analysis for a specific reading activity
model ReadingGazeAnalysis {
  id                      String   @id @default(cuid())
  gazeSessionId           String   @map("gaze_session_id")
  gazeSession             GazeTrackingSession @relation(fields: [gazeSessionId], references: [id], onDelete: Cascade)
  
  // What was being read
  contentType             String   @map("content_type")
  // decodable_story, word_list, sentence, assessment_passage
  contentId               String   @map("content_id")
  contentText             String   @map("content_text") @db.Text
  
  // Timing
  startedAt               DateTime @default(now()) @map("started_at")
  endedAt                 DateTime? @map("ended_at")
  totalReadingTimeMs      Int?     @map("total_reading_time_ms")
  
  // Overall metrics
  totalFixations          Int      @default(0) @map("total_fixations")
  totalRegressions        Int      @default(0) @map("total_regressions")
  averageFixationMs       Float?   @map("average_fixation_ms")
  averageSaccadeLength    Float?   @map("average_saccade_length")
  
  // Reading pattern metrics
  readingSpeed            Float?   @map("reading_speed") // words per minute
  lineTrackingAccuracy    Float?   @map("line_tracking_accuracy")
  returnSweepAccuracy     Float?   @map("return_sweep_accuracy")
  
  // Attention metrics
  onTextPercent           Float?   @map("on_text_percent")
  gazeDriftEvents         Int      @default(0) @map("gaze_drift_events")
  longestDriftMs          Int?     @map("longest_drift_ms")
  
  // Word-level data (JSON array of WordGazeMetrics)
  wordGazeData            Json     @default("[]") @map("word_gaze_data")
  // [{ wordIndex, word, fixationCount, totalFixationMs, firstFixationMs,
  //    regressionsTo, regressionsFrom, skipped, prolongedFixation }]
  
  // Identified challenges
  challengingWords        String[] @default([]) @map("challenging_words")
  challengingPatterns     Json     @default("[]") @map("challenging_patterns")
  
  // AI interpretation
  aiInterpretation        Json?    @map("ai_interpretation")
  confidenceScore         Float?   @map("confidence_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([gazeSessionId])
  @@index([contentId])
  @@map("reading_gaze_analyses")
}

/// Aggregated gaze patterns for a child (built over time)
model GazePatternProfile {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  
  // Baseline metrics
  baselineFixationMs      Float?   @map("baseline_fixation_ms")
  baselineSaccadeLength   Float?   @map("baseline_saccade_length")
  baselineRegressionRate  Float?   @map("baseline_regression_rate")
  
  // Reading style classification
  readingStyle            String?  @map("reading_style")
  // careful_methodical, quick_scanner, regression_heavy, inconsistent
  
  // Strengths (gaze-identified)
  strongWordTypes         String[] @default([]) @map("strong_word_types")
  efficientGraphemes      String[] @default([]) @map("efficient_graphemes")
  
  // Challenge areas (gaze-identified)
  challengingWordTypes    String[] @default([]) @map("challenging_word_types")
  challengingGraphemes    String[] @default([]) @map("challenging_graphemes")
  challengingPositions    String[] @default([]) @map("challenging_positions")
  // word_initial, word_medial, word_final, line_end, page_bottom
  
  // Attention patterns
  typicalFocusDuration    Int?     @map("typical_focus_duration")
  attentionPattern        String?  @map("attention_pattern")
  // sustained, variable, declining, task_dependent
  
  // Line navigation abilities
  lineTrackingAbility     String?  @map("line_tracking_ability")
  returnSweepAbility      String?  @map("return_sweep_ability")
  
  // Progression tracking
  progressionData         Json     @default("[]") @map("progression_data")
  // [{ date, avgFixation, regressionRate, readingSpeed }]
  
  // Data quality
  sessionsAnalyzed        Int      @default(0) @map("sessions_analyzed")
  totalReadingMinutes     Int      @default(0) @map("total_reading_minutes")
  profileConfidence       Float    @default(0) @map("profile_confidence")
  lastUpdatedAt           DateTime @default(now()) @map("last_updated_at")
  
  @@map("gaze_pattern_profiles")
}

/// Real-time gaze intervention events
model GazeIntervention {
  id                      String   @id @default(cuid())
  gazeAnalysisId          String   @map("gaze_analysis_id")
  profileId               String   @map("profile_id")
  
  // Trigger
  triggerType             String   @map("trigger_type")
  // prolonged_fixation, excessive_regressions, gaze_drift, 
  // word_skipping, line_tracking_error
  
  triggeredAt             DateTime @default(now()) @map("triggered_at")
  
  // Context
  wordIndex               Int?     @map("word_index")
  word                    String?
  fixationDurationMs      Int?     @map("fixation_duration_ms")
  
  // Intervention applied
  interventionType        String   @map("intervention_type")
  // highlight_word, play_audio, show_syllables, mentor_appears,
  // suggest_break, add_reading_guide, slow_pace
  
  interventionDetails     Json?    @map("intervention_details")
  
  // Outcome
  outcome                 String?  // improved, no_change, skipped, session_ended
  outcomeAssessedAt       DateTime? @map("outcome_assessed_at")
  subsequentFixationMs    Int?     @map("subsequent_fixation_ms")
  
  @@index([profileId, triggeredAt])
  @@index([gazeAnalysisId])
  @@map("gaze_interventions")
}

// ============================================================================
// PART 9: PLATFORM INTEGRATION
// ============================================================================

/// Progress report generated for various audiences
model ProgressReport {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  familyId                String   @map("family_id")
  
  // Report type
  reportType              String   @map("report_type")
  // daily_summary, weekly_summary, monthly_report, milestone_report,
  // assessment_report, term_report, educator_report
  
  // Period covered
  periodStart             DateTime @map("period_start")
  periodEnd               DateTime @map("period_end")
  
  // Audience
  audience                String   // parent, educator, tutor, system
  
  // Content
  reportData              Json     @map("report_data")
  // Varies by type - includes metrics, milestones, recommendations
  
  // Delivery
  deliveryLanguage        String   @default("en") @map("delivery_language")
  deliveryMode            String   @default("text") @map("delivery_mode")
  // text, voice, video, visual
  
  // Generated assets
  pdfUrl                  String?  @map("pdf_url")
  audioSummaryUrl         String?  @map("audio_summary_url")
  videoSummaryUrl         String?  @map("video_summary_url")
  
  // Narrative version (story-based for parents)
  narrativeVersion        String?  @map("narrative_version") @db.Text
  narrativeAudioUrl       String?  @map("narrative_audio_url")
  
  // Delivery status
  generatedAt             DateTime @default(now()) @map("generated_at")
  sentAt                  DateTime? @map("sent_at")
  viewedAt                DateTime? @map("viewed_at")
  
  // Recipient tracking
  sentToCaregiversIds     String[] @default([]) @map("sent_to_caregivers_ids")
  sentToEducatorId        String?  @map("sent_to_educator_id")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([profileId, reportType, periodEnd])
  @@index([familyId, generatedAt])
  @@map("progress_reports")
}

/// Links to Scholarly homeschool compliance tracking
model HomeschoolComplianceLink {
  id                      String   @id @default(cuid())
  childId                 String   @unique @map("child_id")
  familyId                String   @map("family_id")
  
  // Scholarly homeschool hub reference
  homeschoolEnrollmentId  String?  @map("homeschool_enrollment_id")
  
  // Jurisdiction
  jurisdiction            String
  curriculumFramework     String   @map("curriculum_framework")
  
  // Compliance tracking
  registrationNumber      String?  @map("registration_number")
  registrationExpiresAt   DateTime? @map("registration_expires_at")
  
  // Auto-reporting
  autoReportEnabled       Boolean  @default(false) @map("auto_report_enabled")
  lastReportGeneratedAt   DateTime? @map("last_report_generated_at")
  nextReportDueAt         DateTime? @map("next_report_due_at")
  
  // Curriculum outcomes mapped
  outcomesAchieved        String[] @default([]) @map("outcomes_achieved")
  outcomesInProgress      String[] @default([]) @map("outcomes_in_progress")
  lastOutcomesSyncAt      DateTime? @map("last_outcomes_sync_at")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([familyId])
  @@index([jurisdiction])
  @@map("homeschool_compliance_links")
}

// ============================================================================
// PART 9: ANALYTICS & INSIGHTS
// ============================================================================

/// Aggregated daily metrics for analytics
model DailyLearningMetrics {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  date                    DateTime @db.Date
  
  // Session metrics
  totalSessions           Int      @default(0) @map("total_sessions")
  totalMinutes            Int      @default(0) @map("total_minutes")
  activeMinutes           Int      @default(0) @map("active_minutes")
  
  // Activity metrics
  activitiesCompleted     Int      @default(0) @map("activities_completed")
  activitiesAttempted     Int      @default(0) @map("activities_attempted")
  
  // Phonics metrics
  graphemesPracticed      Int      @default(0) @map("graphemes_practiced")
  graphemesIntroduced     Int      @default(0) @map("graphemes_introduced")
  wordsRead               Int      @default(0) @map("words_read")
  wordsAttempted          Int      @default(0) @map("words_attempted")
  phonicsAccuracy         Float?   @map("phonics_accuracy")
  
  // Numeracy metrics
  numberActivities        Int      @default(0) @map("number_activities")
  numeracyAccuracy        Float?   @map("numeracy_accuracy")
  
  // Writing metrics
  lettersFormed           Int      @default(0) @map("letters_formed")
  writingMinutes          Int      @default(0) @map("writing_minutes")
  
  // Engagement metrics
  averageEngagement       Float?   @map("average_engagement")
  frustrationEvents       Int      @default(0) @map("frustration_events")
  flowMinutes             Int      @default(0) @map("flow_minutes")
  dominantMood            String?  @map("dominant_mood")
  
  // Adaptations
  adaptationsMade         Int      @default(0) @map("adaptations_made")
  difficultyIncreases     Int      @default(0) @map("difficulty_increases")
  difficultyDecreases     Int      @default(0) @map("difficulty_decreases")
  
  // Rewards
  treasuresEarned         Int      @default(0) @map("treasures_earned")
  badgesEarned            Int      @default(0) @map("badges_earned")
  
  // Parent engagement
  questsAssigned          Int      @default(0) @map("quests_assigned")
  questsCompleted         Int      @default(0) @map("quests_completed")
  parentMinutesEngaged    Int      @default(0) @map("parent_minutes_engaged")
  
  // Audit
  computedAt              DateTime @default(now()) @map("computed_at")
  
  @@unique([profileId, date])
  @@index([date])
  @@map("daily_learning_metrics")
}

/// Weekly aggregated metrics
model WeeklyLearningMetrics {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  weekStartDate           DateTime @map("week_start_date") @db.Date
  
  // Summary metrics
  totalSessions           Int      @default(0) @map("total_sessions")
  totalMinutes            Int      @default(0) @map("total_minutes")
  daysActive              Int      @default(0) @map("days_active")
  
  // Learning progress
  graphemesMastered       Int      @default(0) @map("graphemes_mastered")
  newWordsRead            Int      @default(0) @map("new_words_read")
  readingLevelChange      Int      @default(0) @map("reading_level_change") // -1, 0, 1
  numeracyGrowth          Float?   @map("numeracy_growth")
  
  // Engagement
  averageEngagement       Float?   @map("average_engagement")
  streakDays              Int      @default(0) @map("streak_days")
  
  // Parent engagement
  questCompletionRate     Float?   @map("quest_completion_rate")
  caregiversActive        Int      @default(0) @map("caregivers_active")
  
  // Milestones
  milestonesAchieved      Int      @default(0) @map("milestones_achieved")
  
  // Computed
  computedAt              DateTime @default(now()) @map("computed_at")
  
  @@unique([profileId, weekStartDate])
  @@index([weekStartDate])
  @@map("weekly_learning_metrics")
}

/// Cohort comparison data (anonymized)
model CohortBenchmark {
  id                      String   @id @default(cuid())
  
  // Cohort definition
  cohortType              String   @map("cohort_type")
  // age, phase, enrollment_month, region
  cohortValue             String   @map("cohort_value")
  
  // Time period
  periodType              String   @map("period_type") // week, month, quarter
  periodStart             DateTime @map("period_start") @db.Date
  
  // Sample size
  sampleSize              Int      @map("sample_size")
  
  // Benchmark metrics (percentiles)
  metrics                 Json
  // { sessionMinutesPerWeek: { p25: 45, p50: 75, p75: 120 },
  //   graphemesPerMonth: { p25: 4, p50: 8, p75: 12 },
  //   questCompletionRate: { p25: 0.3, p50: 0.5, p75: 0.7 } }
  
  // Computed
  computedAt              DateTime @default(now()) @map("computed_at")
  
  @@unique([cohortType, cohortValue, periodType, periodStart])
  @@index([periodStart])
  @@map("cohort_benchmarks")
}

// ============================================================================
// PART 10: SYSTEM CONFIGURATION
// ============================================================================

/// Picture password image library
model PicturePasswordImage {
  id                      String   @id @default(cuid())
  
  // Image identity
  code                    String   @unique
  category                String   // animals, nature, objects, food, transport, etc.
  
  // Display
  emoji                   String   // For simple display
  imageUrl                String   @map("image_url")
  
  // Accessibility
  altText                 String   @map("alt_text")
  audioDescriptionUrl     String?  @map("audio_description_url")
  
  // Translations of alt text
  altTextTranslations     Json     @default("{}") @map("alt_text_translations")
  
  // Ordering
  displayOrder            Int      @default(0) @map("display_order")
  
  // Status
  isActive                Boolean  @default(true) @map("is_active")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([category, isActive])
  @@map("picture_password_images")
}

/// Mentor creature definitions
model MentorCreature {
  id                      String   @id @default(cuid())
  
  // Identity
  code                    String   @unique
  name                    String
  species                 String
  
  // Personality
  personality             String   @db.Text
  learningStyleMatch      String   @map("learning_style_match")
  // visual, auditory, kinesthetic, logical
  
  // Visuals
  imageUrl                String   @map("image_url")
  animationUrl            String?  @map("animation_url")
  idleAnimationUrl        String?  @map("idle_animation_url")
  celebrationAnimationUrl String?  @map("celebration_animation_url")
  
  // Audio (base)
  greetingAudioUrl        String?  @map("greeting_audio_url")
  encouragementAudioUrls  String[] @default([]) @map("encouragement_audio_urls")
  celebrationAudioUrls    String[] @default([]) @map("celebration_audio_urls")
  
  // Catchphrases
  catchphrases            String[] @default([])
  encouragements          String[] @default([])
  
  // Display
  displayOrder            Int      @default(0) @map("display_order")
  isDefault               Boolean  @default(false) @map("is_default")
  
  // Status
  isActive                Boolean  @default(true) @map("is_active")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  translations            MentorCreatureTranslation[]
  
  @@map("mentor_creatures")
}

/// Translated mentor creature content
model MentorCreatureTranslation {
  id                      String   @id @default(cuid())
  mentorId                String   @map("mentor_id")
  mentor                  MentorCreature @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  
  languageCode            String   @map("language_code")
  
  // Translated content
  name                    String
  personality             String   @db.Text
  catchphrases            String[] @default([])
  encouragements          String[] @default([])
  
  // Localized audio
  greetingAudioUrl        String?  @map("greeting_audio_url")
  encouragementAudioUrls  String[] @default([]) @map("encouragement_audio_urls")
  celebrationAudioUrls    String[] @default([]) @map("celebration_audio_urls")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([mentorId, languageCode])
  @@map("mentor_creature_translations")
}

/// Achievement/badge definitions
model AchievementDefinition {
  id                      String   @id @default(cuid())
  
  // Identity
  code                    String   @unique
  name                    String
  description             String
  
  // Type
  achievementType         String   @map("achievement_type")
  // learning_milestone, streak, engagement, parent_quest, celebration, special
  
  targetAudience          String   @map("target_audience")
  // child, family, caregiver
  
  // Criteria
  criteria                Json
  // { type: "graphemes_mastered", threshold: 10 }
  // { type: "streak_days", threshold: 7 }
  // { type: "quests_completed", threshold: 20 }
  
  // Rewards
  pointsAwarded           Int      @default(0) @map("points_awarded")
  treasuresAwarded        Int      @default(0) @map("treasures_awarded")
  
  // Visuals
  badgeImageUrl           String   @map("badge_image_url")
  celebrationAnimationUrl String?  @map("celebration_animation_url")
  
  // Display
  displayOrder            Int      @default(0) @map("display_order")
  isHidden                Boolean  @default(false) @map("is_hidden") // Secret achievements
  
  // Status
  isActive                Boolean  @default(true) @map("is_active")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  translations            AchievementTranslation[]
  
  @@index([achievementType])
  @@map("achievement_definitions")
}

/// Translated achievement content
model AchievementTranslation {
  id                      String   @id @default(cuid())
  achievementId           String   @map("achievement_id")
  achievement             AchievementDefinition @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  languageCode            String   @map("language_code")
  
  name                    String
  description             String
  celebrationMessage      String?  @map("celebration_message")
  
  // Audio
  celebrationAudioUrl     String?  @map("celebration_audio_url")
  
  @@unique([achievementId, languageCode])
  @@map("achievement_translations")
}

// ============================================================================
// PART 11: CURRICULUM ALIGNMENT
// ============================================================================

/// Curriculum framework definitions
model CurriculumFramework {
  id                      String   @id @default(cuid())
  
  // Identity
  code                    String   @unique // ACARA, UK_NC, COMMON_CORE, etc.
  name                    String
  country                 String
  region                  String?  // State/province if applicable
  
  // Structure
  yearLevels              String[] @map("year_levels")
  // ["Foundation", "Year 1", "Year 2"] or ["Kindergarten", "Grade 1"]
  
  // Learning areas relevant to early years
  learningAreas           Json     @map("learning_areas")
  // { "English": { code: "ENG", subAreas: ["Reading", "Writing", "Speaking"] },
  //   "Mathematics": { code: "MAT", subAreas: ["Number", "Measurement", "Geometry"] } }
  
  // Official source
  sourceUrl               String?  @map("source_url")
  lastUpdated             DateTime? @map("last_updated")
  
  // Status
  isActive                Boolean  @default(true) @map("is_active")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  outcomes                CurriculumOutcome[]
  
  @@map("curriculum_frameworks")
}

/// Individual curriculum outcome/standard
model CurriculumOutcome {
  id                      String   @id @default(cuid())
  frameworkId             String   @map("framework_id")
  framework               CurriculumFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  
  // Identity
  code                    String   // Official code e.g., "ACELA1429"
  
  // Classification
  yearLevel               String   @map("year_level")
  learningArea            String   @map("learning_area")
  subArea                 String?  @map("sub_area")
  strand                  String?
  
  // Content
  description             String   @db.Text
  elaborations            String[] @default([])
  
  // Mapping to Little Explorers
  mappedPhases            Int[]    @default([]) @map("mapped_phases")
  mappedSkills            String[] @default([]) @map("mapped_skills")
  mappedActivities        String[] @default([]) @map("mapped_activities")
  mappedMilestones        String[] @default([]) @map("mapped_milestones")
  
  // Assessment criteria
  assessmentCriteria      Json     @default("[]") @map("assessment_criteria")
  
  // Status
  isActive                Boolean  @default(true) @map("is_active")
  
  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([frameworkId, code])
  @@index([yearLevel, learningArea])
  @@map("curriculum_outcomes")
}

// ============================================================================
// PART 12: SAFETY & MONITORING
// ============================================================================

/// Content safety scan results
model ContentSafetyScan {
  id                      String   @id @default(cuid())
  
  // What was scanned
  contentType             String   @map("content_type")
  // message, voice_recording, video, image, text_input
  contentReference        String   @map("content_reference")
  
  // Context
  familyId                String   @map("family_id")
  childId                 String?  @map("child_id")
  caregiverId             String?  @map("caregiver_id")
  sessionId               String?  @map("session_id")
  
  // Scan results
  scannedAt               DateTime @default(now()) @map("scanned_at")
  scanEngine              String   @map("scan_engine")
  
  // Findings
  flagged                 Boolean  @default(false)
  flagReason              String?  @map("flag_reason")
  // inappropriate_content, safety_concern, potential_grooming, distress_detected
  
  severity                String?  // low, medium, high, critical
  confidence              Float?
  
  // Details
  findings                Json     @default("{}")
  
  // Response
  actionTaken             String?  @map("action_taken")
  // none, blocked, parent_notified, reviewed, escalated
  
  reviewedBy              String?  @map("reviewed_by")
  reviewedAt              DateTime? @map("reviewed_at")
  reviewNotes             String?  @map("review_notes")
  
  // Escalation
  escalated               Boolean  @default(false)
  escalatedAt             DateTime? @map("escalated_at")
  escalationReference     String?  @map("escalation_reference")
  
  @@index([familyId, scannedAt])
  @@index([flagged, severity])
  @@map("content_safety_scans")
}

/// Child wellbeing alerts
model WellbeingAlert {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  familyId                String   @map("family_id")
  
  // Alert type
  alertType               String   @map("alert_type")
  // persistent_frustration, declining_engagement, potential_distress,
  // concerning_content, unusual_session_pattern, regression_detected
  
  severity                String   // low, medium, high
  
  // Trigger
  triggeredAt             DateTime @default(now()) @map("triggered_at")
  triggerSource           String   @map("trigger_source")
  // affective_monitoring, content_scan, pattern_detection, manual
  
  triggerDetails          Json     @map("trigger_details")
  
  // Evidence
  evidenceSessionIds      String[] @default([]) @map("evidence_session_ids")
  evidenceSummary         String?  @map("evidence_summary")
  
  // Response
  status                  String   @default("new")
  // new, acknowledged, investigating, resolved, escalated
  
  acknowledgedAt          DateTime? @map("acknowledged_at")
  acknowledgedBy          String?  @map("acknowledged_by")
  
  resolution              String?
  resolvedAt              DateTime? @map("resolved_at")
  resolvedBy              String?  @map("resolved_by")
  
  // Parent notification
  parentNotified          Boolean  @default(false) @map("parent_notified")
  parentNotifiedAt        DateTime? @map("parent_notified_at")
  parentResponse          String?  @map("parent_response")
  
  // Notes
  notes                   Json     @default("[]")
  
  @@index([familyId, triggeredAt])
  @@index([status, severity])
  @@map("wellbeing_alerts")
}

// ============================================================================
// ENUMS (for reference - Prisma doesn't require explicit enum definitions
// when using String fields, but these document valid values)
// ============================================================================

// AuthMethod: picture_password, parent_unlock, scheduled_access, trusted_device, voice_recognition
// TrustLevel: standard, high, temporary
// DeviceStatus: active, suspended, revoked
// SessionStatus: active, expired, terminated, locked, extended
// ConsentType: essential_data, voice_recording, video_features, affective_monitoring, tutor_communication, progress_sharing, marketing, research_participation
// CaregiverRelationship: parent, grandparent, guardian, aunt, uncle, nanny, other
// LiteracyLevel: high, moderate, limited, none
// ContentMode: text, voice, video, visual
// QuestStatus: assigned, viewed, started, completed, skipped, expired
// QuestType: incidental, routine, dedicated, celebration, milestone
// PhonicsPhase: 1, 2, 3, 4, 5
// ReadingLevel: pre-reader, emergent, early, transitional, fluent
// SpellingStage: pre_phonetic, semi_phonetic, phonetic, transitional, conventional
// InferredMood: engaged, frustrated, bored, confident, anxious, tired, distressed
// CognitiveLoad: low, optimal, high
// AssessmentType: phonemic_awareness, letter_sounds, blending, decoding, sight_words, reading_fluency, reading_comprehension, number_sense, counting, operations, writing_skills, fine_motor, overall_readiness
