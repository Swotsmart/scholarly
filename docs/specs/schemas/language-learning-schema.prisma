// ============================================================================
// LINGUAFLOW - LANGUAGE LEARNING MODULE SCHEMA
// AI-Powered Language Acquisition Platform
// Version: 1.0.0
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PART 1: LEARNER LANGUAGE PROFILE
// ============================================================================

/// A learner's language learning profile
model LanguageLearnerProfile {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  learnerId               String   @map("learner_id")
  
  // Target language
  targetLanguage          String   @map("target_language")
  // fra, cmn, ind, spa, ita, deu
  
  // Native/home languages
  nativeLanguage          String   @map("native_language")
  additionalLanguages     String[] @default([]) @map("additional_languages")
  isHeritageSpeaker       Boolean  @default(false) @map("is_heritage_speaker")
  heritageLanguageProfile String?  @map("heritage_language_profile")
  // home_dominant, balanced_bilingual, receptive_only, academic_gap
  
  // Current proficiency (CEFR)
  overallLevel            String   @default("A1") @map("overall_level")
  listeningLevel          String   @default("A1") @map("listening_level")
  speakingLevel           String   @default("A1") @map("speaking_level")
  readingLevel            String   @default("A1") @map("reading_level")
  writingLevel            String   @default("A1") @map("writing_level")
  
  // Heritage speaker specific levels
  heritageOralProficiency String?  @map("heritage_oral_proficiency")
  heritageAcademicLiteracy String? @map("heritage_academic_literacy")
  
  // Skill sub-components
  skillDetails            Json     @default("{}") @map("skill_details")
  
  // Curriculum alignment
  curriculumFramework     String   @default("ACARA") @map("curriculum_framework")
  yearLevel               String?  @map("year_level")
  ibProgramme             String?  @map("ib_programme")
  ibPhaseOrLevel          String?  @map("ib_phase_or_level")
  
  // Learning preferences
  learningPreferences     Json     @default("{}") @map("learning_preferences")
  
  // Accessibility settings
  accessibilitySettings   Json     @default("{}") @map("accessibility_settings")
  
  // Gamification
  currentLevel            Int      @default(1) @map("current_level")
  totalXp                 Int      @default(0) @map("total_xp")
  currentStreak           Int      @default(0) @map("current_streak")
  longestStreak           Int      @default(0) @map("longest_streak")
  achievementIds          String[] @default([]) @map("achievement_ids")
  
  // Engagement metrics
  totalLearningMinutes    Int      @default(0) @map("total_learning_minutes")
  totalSpeakingMinutes    Int      @default(0) @map("total_speaking_minutes")
  lastActiveAt            DateTime? @map("last_active_at")
  
  // Offline sync
  lastSyncedAt            DateTime? @map("last_synced_at")
  offlineDataVersion      Int      @default(0) @map("offline_data_version")
  pendingOfflineActions   Json     @default("[]") @map("pending_offline_actions")
  
  // Enrollment
  enrolledAt              DateTime @default(now()) @map("enrolled_at")
  status                  String   @default("active")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  vocabularyProgress      VocabularyProgress?
  grammarProgress         GrammarProgress?
  pronunciationProfile    PronunciationProfile?
  heritagePathway         HeritageLanguagePathway?
  learningSessions        LanguageLearningSession[]
  conversationSessions    ConversationSession[]
  assessments             LanguageAssessment[]
  practiceTests           StudentPracticeTest[]
  writingSubmissions      WritingSubmission[]
  achievements            LearnerAchievement[]
  offlinePackages         OfflineContentPackage[]
  parentAccess            LanguageParentAccess[]
  
  @@unique([tenantId, learnerId, targetLanguage])
  @@index([tenantId, targetLanguage])
  @@index([overallLevel])
  @@index([isHeritageSpeaker])
  @@map("language_learner_profiles")
}

/// Vocabulary learning progress with spaced repetition
model VocabularyProgress {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  totalWordsExposed       Int      @default(0) @map("total_words_exposed")
  totalWordsMastered      Int      @default(0) @map("total_words_mastered")
  totalWordsLearning      Int      @default(0) @map("total_words_learning")
  
  cefrCoverage            Json     @default("{}") @map("cefr_coverage")
  topicCoverage           Json     @default("{}") @map("topic_coverage")
  
  dueForReview            Int      @default(0) @map("due_for_review")
  nextReviewAt            DateTime? @map("next_review_at")
  
  averageRetentionRate    Float    @default(0) @map("average_retention_rate")
  bestTimeOfDay           String?  @map("best_time_of_day")
  preferredPracticeMode   String?  @map("preferred_practice_mode")
  
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  wordItems               VocabularyItem[]
  
  @@map("vocabulary_progress")
}

/// Individual vocabulary item with SRS data
model VocabularyItem {
  id                      String   @id @default(cuid())
  progressId              String   @map("progress_id")
  progress                VocabularyProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  wordId                  String   @map("word_id")
  word                    String
  
  masteryLevel            String   @default("new") @map("mastery_level")
  // new, learning, reviewing, mastered
  
  // Spaced repetition
  easeFactor              Float    @default(2.5) @map("ease_factor")
  interval                Int      @default(0)
  repetitions             Int      @default(0)
  nextReviewAt            DateTime? @map("next_review_at")
  
  timesCorrect            Int      @default(0) @map("times_correct")
  timesIncorrect          Int      @default(0) @map("times_incorrect")
  lastAttemptCorrect      Boolean? @map("last_attempt_correct")
  
  firstEncounteredAt      DateTime @default(now()) @map("first_encountered_at")
  lastPracticedAt         DateTime? @map("last_practiced_at")
  encounterContexts       String[] @default([]) @map("encounter_contexts")
  
  pronunciationScore      Float?   @map("pronunciation_score")
  
  // Offline availability
  availableOffline        Boolean  @default(false) @map("available_offline")
  
  @@unique([progressId, wordId])
  @@index([progressId, nextReviewAt])
  @@index([masteryLevel])
  @@map("vocabulary_items")
}

/// Grammar learning progress
model GrammarProgress {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  structureMastery        Json     @default("{}") @map("structure_mastery")
  commonErrors            Json     @default("[]") @map("common_errors")
  cefrStructures          Json     @default("{}") @map("cefr_structures")
  
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("grammar_progress")
}

/// Pronunciation profile
model PronunciationProfile {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  overallScore            Float?   @map("overall_score")
  intelligibilityScore    Float?   @map("intelligibility_score")
  accentScore             Float?   @map("accent_score")
  
  phonemeScores           Json     @default("{}") @map("phoneme_scores")
  challengingSounds       String[] @default([]) @map("challenging_sounds")
  
  intonationScore         Float?   @map("intonation_score")
  stressScore             Float?   @map("stress_score")
  rhythmScore             Float?   @map("rhythm_score")
  
  // For tonal languages
  toneAccuracy            Json?    @map("tone_accuracy")
  
  focusAreas              String[] @default([]) @map("focus_areas")
  
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("pronunciation_profiles")
}

// ============================================================================
// PART 2: HERITAGE SPEAKER SUPPORT
// ============================================================================

/// Heritage language learner pathway
model HeritageLanguagePathway {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Heritage background
  homeLanguageExposure    String   @map("home_language_exposure")
  // primary, secondary, grandparents_only, weekend_school, community
  
  generationStatus        String   @map("generation_status")
  // first_gen, second_gen, third_gen_plus
  
  dialectOrVariety        String?  @map("dialect_or_variety")
  // e.g., "Cantonese", "Sicilian", "Castilian"
  
  // Skill assessment
  oralProficiencyLevel    String   @map("oral_proficiency_level")
  // native_like, advanced, intermediate, basic, receptive_only
  
  literacyLevel           String   @map("literacy_level")
  // literate, semi_literate, pre_literate
  
  academicRegisterLevel   String   @map("academic_register_level")
  // proficient, developing, limited, none
  
  // Specific gaps
  identifiedGaps          Json     @default("[]") @map("identified_gaps")
  // [{ area: "formal_register", description: "...", priority: "high" }]
  
  // Strengths to leverage
  identifiedStrengths     Json     @default("[]") @map("identified_strengths")
  // [{ area: "colloquial_fluency", description: "...", leverage: "..." }]
  
  // Customised pathway
  pathwayType             String   @map("pathway_type")
  // literacy_focus, academic_register, dialect_to_standard, balanced
  
  pathwayModules          Json     @default("[]") @map("pathway_modules")
  currentModuleIndex      Int      @default(0) @map("current_module_index")
  
  // Cultural connection
  culturalKnowledgeLevel  String?  @map("cultural_knowledge_level")
  culturalGoals           String[] @default([]) @map("cultural_goals")
  
  // Family involvement
  familyInvolvementLevel  String?  @map("family_involvement_level")
  familyLanguageGoals     String[] @default([]) @map("family_language_goals")
  
  assessedAt              DateTime @default(now()) @map("assessed_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@map("heritage_language_pathways")
}

// ============================================================================
// PART 3: LEARNING SESSIONS & ACTIVITIES
// ============================================================================

/// A language learning session
model LanguageLearningSession {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  startedAt               DateTime @default(now()) @map("started_at")
  endedAt                 DateTime? @map("ended_at")
  durationMinutes         Int?     @map("duration_minutes")
  
  sessionType             String   @map("session_type")
  // practice, assessment, conversation, lesson, review, offline_sync
  
  skillsFocused           String[] @default([]) @map("skills_focused")
  activitiesCompleted     Json     @default("[]") @map("activities_completed")
  
  overallScore            Float?   @map("overall_score")
  itemsAttempted          Int      @default(0) @map("items_attempted")
  itemsCorrect            Int      @default(0) @map("items_correct")
  
  newVocabulary           String[] @default([]) @map("new_vocabulary")
  newGrammar              String[] @default([]) @map("new_grammar")
  
  speakingMinutes         Int      @default(0) @map("speaking_minutes")
  
  // XP and achievements earned
  xpEarned                Int      @default(0) @map("xp_earned")
  achievementsUnlocked    String[] @default([]) @map("achievements_unlocked")
  
  // Offline indicator
  wasOffline              Boolean  @default(false) @map("was_offline")
  syncedAt                DateTime? @map("synced_at")
  
  adaptationsMade         Json     @default("[]") @map("adaptations_made")
  deviceType              String?  @map("device_type")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([profileId, startedAt])
  @@index([sessionType])
  @@map("language_learning_sessions")
}

/// AI Conversation session
model ConversationSession {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  startedAt               DateTime @default(now()) @map("started_at")
  endedAt                 DateTime? @map("ended_at")
  durationSeconds         Int?     @map("duration_seconds")
  
  conversationType        String   @map("conversation_type")
  // role_play, free_conversation, topic_discussion, 
  // targeted_practice, presentation_rehearsal, heritage_practice
  
  scenarioId              String?  @map("scenario_id")
  scenarioTitle           String?  @map("scenario_title")
  scenarioDescription     String?  @map("scenario_description")
  
  // For heritage speakers
  isHeritageMode          Boolean  @default(false) @map("is_heritage_mode")
  dialectMode             String?  @map("dialect_mode")
  registerFocus           String?  @map("register_focus")
  // informal, formal, academic, mixed
  
  targetStructures        String[] @default([]) @map("target_structures")
  targetVocabulary        String[] @default([]) @map("target_vocabulary")
  
  turnCount               Int      @default(0) @map("turn_count")
  studentTurnCount        Int      @default(0) @map("student_turn_count")
  studentSpeakingSeconds  Int      @default(0) @map("student_speaking_seconds")
  
  transcript              Json     @default("[]")
  
  aiPersonaId             String?  @map("ai_persona_id")
  aiPersonaName           String?  @map("ai_persona_name")
  
  // Scores
  fluencyScore            Float?   @map("fluency_score")
  accuracyScore           Float?   @map("accuracy_score")
  rangeScore              Float?   @map("range_score")
  interactionScore        Float?   @map("interaction_score")
  pronunciationScore      Float?   @map("pronunciation_score")
  taskCompletionScore     Float?   @map("task_completion_score")
  
  // Heritage-specific scores
  registerAppropriacy     Float?   @map("register_appropriacy")
  dialectConsistency      Float?   @map("dialect_consistency")
  
  vocabularyUsed          String[] @default([]) @map("vocabulary_used")
  newVocabularyUsed       String[] @default([]) @map("new_vocabulary_used")
  grammarStructuresUsed   String[] @default([]) @map("grammar_structures_used")
  
  grammarErrors           Json     @default("[]") @map("grammar_errors")
  pronunciationIssues     Json     @default("[]") @map("pronunciation_issues")
  suggestionsGiven        Json     @default("[]") @map("suggestions_given")
  
  audioRecordingUrl       String?  @map("audio_recording_url")
  audioStorageKey         String?  @map("audio_storage_key")
  
  // XP earned
  xpEarned                Int      @default(0) @map("xp_earned")
  
  // Teacher/Parent visibility
  teacherCanAccess        Boolean  @default(true) @map("teacher_can_access")
  teacherViewedAt         DateTime? @map("teacher_viewed_at")
  teacherFeedback         String?  @map("teacher_feedback")
  
  parentCanAccess         Boolean  @default(false) @map("parent_can_access")
  parentViewedAt          DateTime? @map("parent_viewed_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([profileId, startedAt])
  @@index([conversationType])
  @@map("conversation_sessions")
}

/// Writing submission
model WritingSubmission {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  taskType                String   @map("task_type")
  taskTitle               String   @map("task_title")
  taskPrompt              String   @map("task_prompt") @db.Text
  taskInstructions        String?  @map("task_instructions") @db.Text
  
  targetWordCount         Int?     @map("target_word_count")
  targetCefrLevel         String?  @map("target_cefr_level")
  
  submittedText           String   @map("submitted_text") @db.Text
  wordCount               Int      @map("word_count")
  submittedAt             DateTime @default(now()) @map("submitted_at")
  
  draftHistory            Json     @default("[]") @map("draft_history")
  
  // AI analysis
  aiAnalysis              Json     @default("{}") @map("ai_analysis")
  aiContentScore          Float?   @map("ai_content_score")
  aiOrganisationScore     Float?   @map("ai_organisation_score")
  aiLanguageScore         Float?   @map("ai_language_score")
  aiStyleScore            Float?   @map("ai_style_score")
  aiOverallScore          Float?   @map("ai_overall_score")
  
  // Teacher assessment
  teacherReviewStatus     String   @default("pending") @map("teacher_review_status")
  teacherReviewedAt       DateTime? @map("teacher_reviewed_at")
  teacherReviewedBy       String?  @map("teacher_reviewed_by")
  
  teacherContentScore     Float?   @map("teacher_content_score")
  teacherOrganisationScore Float?  @map("teacher_organisation_score")
  teacherLanguageScore    Float?   @map("teacher_language_score")
  teacherStyleScore       Float?   @map("teacher_style_score")
  teacherOverallScore     Float?   @map("teacher_overall_score")
  
  teacherFeedback         String?  @map("teacher_feedback") @db.Text
  teacherAnnotations      Json     @default("[]") @map("teacher_annotations")
  
  rubricId                String?  @map("rubric_id")
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  authenticityScore       Float?   @map("authenticity_score")
  aiAssistanceLevel       String?  @map("ai_assistance_level")
  
  revisionRequested       Boolean  @default(false) @map("revision_requested")
  revisionInstructions    String?  @map("revision_instructions")
  
  isAssessment            Boolean  @default(false) @map("is_assessment")
  isPractice              Boolean  @default(true) @map("is_practice")
  
  // XP earned
  xpEarned                Int      @default(0) @map("xp_earned")
  
  // Parent visibility
  parentCanAccess         Boolean  @default(false) @map("parent_can_access")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([profileId, submittedAt])
  @@index([teacherReviewStatus])
  @@map("writing_submissions")
}

// ============================================================================
// PART 4: ASSESSMENTS
// ============================================================================

/// Language assessment
model LanguageAssessment {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  assessmentType          String   @map("assessment_type")
  // placement, diagnostic, unit_test, summative, ib_mock, cefr_certification
  
  assessmentId            String   @map("assessment_id")
  assessmentTitle         String   @map("assessment_title")
  
  skillsAssessed          String[] @map("skills_assessed")
  
  curriculumFramework     String?  @map("curriculum_framework")
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  ibCriteria              String[] @default([]) @map("ib_criteria")
  
  plannedDurationMinutes  Int?     @map("planned_duration_minutes")
  startedAt               DateTime @default(now()) @map("started_at")
  completedAt             DateTime? @map("completed_at")
  actualDurationMinutes   Int?     @map("actual_duration_minutes")
  
  isTimed                 Boolean  @default(false) @map("is_timed")
  allowsResources         Boolean  @default(false) @map("allows_resources")
  
  rawResults              Json     @map("raw_results")
  
  rawScore                Float?   @map("raw_score")
  scaledScore             Float?   @map("scaled_score")
  percentageScore         Float?   @map("percentage_score")
  
  listeningScore          Float?   @map("listening_score")
  speakingScore           Float?   @map("speaking_score")
  readingScore            Float?   @map("reading_score")
  writingScore            Float?   @map("writing_score")
  
  ibCriterionScores       Json?    @map("ib_criterion_scores")
  determinedCefrLevel     String?  @map("determined_cefr_level")
  
  strengths               String[] @default([])
  areasForImprovement     String[] @default([]) @map("areas_for_improvement")
  recommendedNextSteps    Json     @default("[]") @map("recommended_next_steps")
  
  aiAssessment            Json?    @map("ai_assessment")
  
  teacherModerated        Boolean  @default(false) @map("teacher_moderated")
  teacherModeratedAt      DateTime? @map("teacher_moderated_at")
  teacherModeratedBy      String?  @map("teacher_moderated_by")
  teacherAdjustedScores   Json?    @map("teacher_adjusted_scores")
  teacherComments         String?  @map("teacher_comments")
  
  status                  String   @default("in_progress")
  // in_progress, completed, scored, moderated, released
  
  releasedToStudent       Boolean  @default(false) @map("released_to_student")
  releasedAt              DateTime? @map("released_at")
  
  // For formal reports
  includedInReport        Boolean  @default(false) @map("included_in_report")
  reportId                String?  @map("report_id")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([profileId, assessmentType])
  @@index([status])
  @@map("language_assessments")
}

/// Student-generated practice test
model StudentPracticeTest {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  requestedSkill          String   @map("requested_skill")
  requestedTopic          String?  @map("requested_topic")
  requestedDifficulty     String   @map("requested_difficulty")
  requestedDuration       Int      @map("requested_duration")
  
  generatedAt             DateTime @default(now()) @map("generated_at")
  testContent             Json     @map("test_content")
  
  startedAt               DateTime? @map("started_at")
  completedAt             DateTime? @map("completed_at")
  durationMinutes         Int?     @map("duration_minutes")
  
  responses               Json     @default("{}") @map("responses")
  score                   Float?
  itemsAttempted          Int      @default(0) @map("items_attempted")
  itemsCorrect            Int      @default(0) @map("items_correct")
  
  aiFeedback              Json?    @map("ai_feedback")
  areasToReview           String[] @default([]) @map("areas_to_review")
  
  recordingUrl            String?  @map("recording_url")
  writtenResponse         String?  @map("written_response") @db.Text
  
  // XP earned
  xpEarned                Int      @default(0) @map("xp_earned")
  
  // Visibility
  teacherCanView          Boolean  @default(true) @map("teacher_can_view")
  teacherViewedAt         DateTime? @map("teacher_viewed_at")
  teacherNotes            String?  @map("teacher_notes")
  
  parentCanView           Boolean  @default(false) @map("parent_can_view")
  parentViewedAt          DateTime? @map("parent_viewed_at")
  
  // Offline support
  availableOffline        Boolean  @default(false) @map("available_offline")
  completedOffline        Boolean  @default(false) @map("completed_offline")
  
  status                  String   @default("generated")
  
  @@index([profileId, generatedAt])
  @@index([requestedSkill])
  @@map("student_practice_tests")
}

// ============================================================================
// PART 5: GAMIFICATION & ACHIEVEMENTS
// ============================================================================

/// Achievement definition
model LanguageAchievement {
  id                      String   @id @default(cuid())
  
  code                    String   @unique
  name                    String
  description             String
  
  // Localized names
  nameTranslations        Json     @default("{}") @map("name_translations")
  descriptionTranslations Json     @default("{}") @map("description_translations")
  
  // Visual
  iconUrl                 String   @map("icon_url")
  badgeUrl                String   @map("badge_url")
  animationUrl            String?  @map("animation_url")
  
  // Category
  category                String
  // streak, vocabulary, speaking, listening, reading, writing, 
  // grammar, cultural, milestone, special, heritage
  
  // Criteria
  criteriaType            String   @map("criteria_type")
  // count, streak, score, time, level, special
  criteriaValue           Int      @map("criteria_value")
  criteriaDetails         Json?    @map("criteria_details")
  
  // Rewards
  xpReward                Int      @default(0) @map("xp_reward")
  
  // Rarity
  rarity                  String   @default("common")
  // common, uncommon, rare, epic, legendary
  
  // Visibility
  isHidden                Boolean  @default(false) @map("is_hidden")
  isActive                Boolean  @default(true) @map("is_active")
  
  // Language specific
  language                String?  // null = all languages
  
  displayOrder            Int      @default(0) @map("display_order")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  // Relations
  learnerAchievements     LearnerAchievement[]
  
  @@index([category])
  @@index([language])
  @@map("language_achievements")
}

/// Learner's earned achievement
model LearnerAchievement {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  achievementId           String   @map("achievement_id")
  achievement             LanguageAchievement @relation(fields: [achievementId], references: [id])
  
  earnedAt                DateTime @default(now()) @map("earned_at")
  
  // Progress towards next tier (if applicable)
  currentProgress         Int      @default(0) @map("current_progress")
  targetProgress          Int?     @map("target_progress")
  
  // Celebration
  celebrationShown        Boolean  @default(false) @map("celebration_shown")
  sharedToParent          Boolean  @default(false) @map("shared_to_parent")
  
  @@unique([profileId, achievementId])
  @@index([profileId, earnedAt])
  @@map("learner_achievements")
}

/// XP level configuration
model XPLevelConfig {
  id                      String   @id @default(cuid())
  
  level                   Int      @unique
  xpRequired              Int      @map("xp_required")
  levelName               String   @map("level_name")
  levelNameTranslations   Json     @default("{}") @map("level_name_translations")
  
  badgeUrl                String?  @map("badge_url")
  
  // Unlocks at this level
  unlocksFeatures         String[] @default([]) @map("unlocks_features")
  
  @@map("xp_level_configs")
}

// ============================================================================
// PART 6: PARENT ACCESS & DASHBOARD
// ============================================================================

/// Parent access to language learning
model LanguageParentAccess {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  parentId                String   @map("parent_id")
  parentEmail             String   @map("parent_email")
  
  // Access level
  accessLevel             String   @default("view") @map("access_level")
  // view, detailed, full
  
  // What parent can see
  canViewProgress         Boolean  @default(true) @map("can_view_progress")
  canViewAssessments      Boolean  @default(true) @map("can_view_assessments")
  canViewConversations    Boolean  @default(false) @map("can_view_conversations")
  canViewWriting          Boolean  @default(false) @map("can_view_writing")
  canViewPracticeTests    Boolean  @default(true) @map("can_view_practice_tests")
  
  // Notification preferences
  notifyOnAchievements    Boolean  @default(true) @map("notify_on_achievements")
  notifyOnAssessments     Boolean  @default(true) @map("notify_on_assessments")
  notifyOnStreak          Boolean  @default(true) @map("notify_on_streak")
  notifyOnInactivity      Boolean  @default(true) @map("notify_on_inactivity")
  inactivityThresholdDays Int      @default(3) @map("inactivity_threshold_days")
  
  // Weekly summary
  weeklyDigestEnabled     Boolean  @default(true) @map("weekly_digest_enabled")
  weeklyDigestDay         String   @default("sunday") @map("weekly_digest_day")
  
  // Language preference for communications
  communicationLanguage   String   @default("en") @map("communication_language")
  
  // Verification
  verifiedAt              DateTime? @map("verified_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([profileId, parentId])
  @@index([parentId])
  @@map("language_parent_access")
}

/// Parent dashboard snapshot (cached for performance)
model ParentDashboardSnapshot {
  id                      String   @id @default(cuid())
  parentId                String   @map("parent_id")
  profileId               String   @map("profile_id")
  
  // Snapshot data
  snapshotData            Json     @map("snapshot_data")
  // { currentLevel, xp, streak, weeklyMinutes, weeklyXp, 
  //   recentAchievements, skillProgress, upcomingReviews }
  
  generatedAt             DateTime @default(now()) @map("generated_at")
  
  @@unique([parentId, profileId])
  @@index([parentId])
  @@map("parent_dashboard_snapshots")
}

// ============================================================================
// PART 7: OFFLINE SUPPORT
// ============================================================================

/// Offline content package
model OfflineContentPackage {
  id                      String   @id @default(cuid())
  profileId               String   @map("profile_id")
  profile                 LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Package identity
  packageType             String   @map("package_type")
  // vocabulary_review, lesson_unit, conversation_scenarios, practice_tests, full_sync
  
  // Content selection
  contentSelection        Json     @map("content_selection")
  // { vocabularyIds: [...], lessonIds: [...], scenarioIds: [...] }
  
  // Package metadata
  totalItems              Int      @map("total_items")
  estimatedSizeMb         Float    @map("estimated_size_mb")
  estimatedOfflineMinutes Int      @map("estimated_offline_minutes")
  
  // Download status
  downloadStatus          String   @default("pending") @map("download_status")
  // pending, downloading, ready, expired, error
  
  downloadedAt            DateTime? @map("downloaded_at")
  expiresAt               DateTime? @map("expires_at")
  
  // Package version for sync
  packageVersion          Int      @default(1) @map("package_version")
  
  // Offline progress (synced back when online)
  offlineProgressData     Json     @default("{}") @map("offline_progress_data")
  lastOfflineActivityAt   DateTime? @map("last_offline_activity_at")
  pendingSyncItems        Int      @default(0) @map("pending_sync_items")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([profileId, downloadStatus])
  @@map("offline_content_packages")
}

/// Offline audio cache
model OfflineAudioCache {
  id                      String   @id @default(cuid())
  
  // Reference
  referenceType           String   @map("reference_type")
  // vocabulary, scenario, listening_passage
  referenceId             String   @map("reference_id")
  
  language                String
  
  // Audio data
  audioUrl                String   @map("audio_url")
  audioDurationSeconds    Int      @map("audio_duration_seconds")
  audioSizeBytes          Int      @map("audio_size_bytes")
  
  // Offline storage
  offlineKey              String   @unique @map("offline_key")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@index([referenceType, referenceId])
  @@index([language])
  @@map("offline_audio_cache")
}

// ============================================================================
// PART 8: TEACHER TOOLS
// ============================================================================

/// Teacher-created assessment template
model AssessmentTemplate {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  createdByTeacherId      String   @map("created_by_teacher_id")
  
  title                   String
  description             String?  @db.Text
  language                String
  
  assessmentType          String   @map("assessment_type")
  
  targetCefrLevel         String   @map("target_cefr_level")
  targetYearLevel         String?  @map("target_year_level")
  
  curriculumFramework     String?  @map("curriculum_framework")
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  ibCriteria              String[] @default([]) @map("ib_criteria")
  
  topics                  String[] @default([])
  theme                   String?
  
  durationMinutes         Int      @map("duration_minutes")
  
  sections                Json
  audioUrls               Json     @default("[]") @map("audio_urls")
  rubric                  Json?
  answerKey               Json?    @map("answer_key")
  markingGuidance         String?  @map("marking_guidance") @db.Text
  
  hasDifferentiatedVersions Boolean @default(false) @map("has_differentiated_versions")
  differentiatedVersions  Json?    @map("differentiated_versions")
  
  aiGenerated             Boolean  @default(false) @map("ai_generated")
  aiGeneratedAt           DateTime? @map("ai_generated_at")
  teacherEdited           Boolean  @default(false) @map("teacher_edited")
  
  status                  String   @default("draft")
  
  isShared                Boolean  @default(false) @map("is_shared")
  sharedWithTeacherIds    String[] @default([]) @map("shared_with_teacher_ids")
  
  timesAssigned           Int      @default(0) @map("times_assigned")
  averageScore            Float?   @map("average_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, language])
  @@index([targetCefrLevel])
  @@index([assessmentType])
  @@map("assessment_templates")
}

/// Teacher-created conversation scenario
model TeacherConversationScenario {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  createdByTeacherId      String   @map("created_by_teacher_id")
  
  title                   String
  titleInEnglish          String   @map("title_in_english")
  language                String
  
  description             String   @db.Text
  context                 String   @db.Text
  
  scenarioType            String   @map("scenario_type")
  cefrLevel               String   @map("cefr_level")
  
  aiRole                  String   @map("ai_role")
  aiPersonaDescription    String   @map("ai_persona_description") @db.Text
  
  targetVocabulary        String[] @default([]) @map("target_vocabulary")
  targetStructures        String[] @default([]) @map("target_structures")
  
  suggestedFlow           Json     @map("suggested_flow")
  successCriteria         Json     @map("success_criteria")
  
  topics                  String[] @default([])
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  // Heritage speaker variant
  hasHeritageVariant      Boolean  @default(false) @map("has_heritage_variant")
  heritageVariant         Json?    @map("heritage_variant")
  
  status                  String   @default("draft")
  
  isShared                Boolean  @default(false) @map("is_shared")
  sharedWithTeacherIds    String[] @default([]) @map("shared_with_teacher_ids")
  
  timesUsed               Int      @default(0) @map("times_used")
  averageScore            Float?   @map("average_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, language])
  @@index([cefrLevel])
  @@map("teacher_conversation_scenarios")
}

/// Teacher-created reading/listening resource
model TeacherTextResource {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  createdByTeacherId      String   @map("created_by_teacher_id")
  
  title                   String
  language                String
  
  textContent             String   @map("text_content") @db.Text
  
  resourceType            String   @map("resource_type")
  modality                String
  
  audioUrl                String?  @map("audio_url")
  audioDurationSeconds    Int?     @map("audio_duration_seconds")
  
  cefrLevel               String   @map("cefr_level")
  wordCount               Int      @map("word_count")
  
  keyVocabulary           String[] @default([]) @map("key_vocabulary")
  keyStructures           String[] @default([]) @map("key_structures")
  
  comprehensionQuestions  Json     @default("[]") @map("comprehension_questions")
  
  topics                  String[] @default([])
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  culturalNotes           String?  @map("cultural_notes")
  
  status                  String   @default("draft")
  
  isShared                Boolean  @default(false) @map("is_shared")
  sharedWithTeacherIds    String[] @default([]) @map("shared_with_teacher_ids")
  
  timesUsed               Int      @default(0) @map("times_used")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, language])
  @@index([cefrLevel])
  @@map("teacher_text_resources")
}

/// Language class
model LanguageClass {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  teacherId               String   @map("teacher_id")
  
  name                    String
  language                String
  
  cefrLevelRange          String   @map("cefr_level_range")
  yearLevel               String?  @map("year_level")
  
  curriculumFramework     String?  @map("curriculum_framework")
  ibProgramme             String?  @map("ib_programme")
  
  academicYear            String   @map("academic_year")
  term                    String?
  
  studentProfileIds       String[] @default([]) @map("student_profile_ids")
  studentCount            Int      @default(0) @map("student_count")
  
  settings                Json     @default("{}")
  
  status                  String   @default("active")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  assignments             LanguageAssignment[]
  reports                 LanguageReport[]
  
  @@unique([tenantId, teacherId, name, academicYear])
  @@index([tenantId, teacherId])
  @@index([language])
  @@map("language_classes")
}

/// Assignment
model LanguageAssignment {
  id                      String   @id @default(cuid())
  classId                 String   @map("class_id")
  languageClass           LanguageClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  title                   String
  description             String?  @db.Text
  instructions            String?  @db.Text
  
  assignmentType          String   @map("assignment_type")
  
  assessmentTemplateId    String?  @map("assessment_template_id")
  conversationScenarioId  String?  @map("conversation_scenario_id")
  textResourceId          String?  @map("text_resource_id")
  contentResourceIds      String[] @default([]) @map("content_resource_ids")
  
  assignedAt              DateTime @default(now()) @map("assigned_at")
  dueAt                   DateTime? @map("due_at")
  
  estimatedMinutes        Int?     @map("estimated_minutes")
  isTimed                 Boolean  @default(false) @map("is_timed")
  allowLateSubmission     Boolean  @default(true) @map("allow_late_submission")
  
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  // Offline availability
  availableOffline        Boolean  @default(false) @map("available_offline")
  
  status                  String   @default("active")
  
  submissionCount         Int      @default(0) @map("submission_count")
  completionRate          Float    @default(0) @map("completion_rate")
  averageScore            Float?   @map("average_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([classId, dueAt])
  @@index([assignmentType])
  @@map("language_assignments")
}

// ============================================================================
// PART 9: REPORTING
// ============================================================================

/// Language report (semester, term, etc.)
model LanguageReport {
  id                      String   @id @default(cuid())
  classId                 String   @map("class_id")
  languageClass           LanguageClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  // Report period
  reportType              String   @map("report_type")
  // term, semester, annual, ib_progress, ib_final
  
  reportPeriod            String   @map("report_period")
  // "Term 1 2026", "Semester 1 2026", etc.
  
  academicYear            String   @map("academic_year")
  
  // Status
  status                  String   @default("draft")
  // draft, in_progress, review, approved, published
  
  // Dates
  periodStartDate         DateTime @map("period_start_date")
  periodEndDate           DateTime @map("period_end_date")
  dueDate                 DateTime? @map("due_date")
  publishedAt             DateTime? @map("published_at")
  
  // Template
  templateId              String?  @map("template_id")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  // Relations
  studentReports          StudentLanguageReport[]
  
  @@index([classId, reportType])
  @@map("language_reports")
}

/// Individual student report
model StudentLanguageReport {
  id                      String   @id @default(cuid())
  reportId                String   @map("report_id")
  report                  LanguageReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  profileId               String   @map("profile_id")
  studentName             String   @map("student_name")
  
  // Levels at start and end of period
  startingCefrLevel       String   @map("starting_cefr_level")
  endingCefrLevel         String   @map("ending_cefr_level")
  levelProgress           String?  @map("level_progress")
  // significant_progress, good_progress, steady, needs_support
  
  // Skill assessments
  listeningGrade          String?  @map("listening_grade")
  speakingGrade           String?  @map("speaking_grade")
  readingGrade            String?  @map("reading_grade")
  writingGrade            String?  @map("writing_grade")
  overallGrade            String?  @map("overall_grade")
  
  // IB specific
  ibCriterionA            Int?     @map("ib_criterion_a")
  ibCriterionB            Int?     @map("ib_criterion_b")
  ibCriterionC            Int?     @map("ib_criterion_c")
  ibCriterionD            Int?     @map("ib_criterion_d")
  ibOverallGrade          Int?     @map("ib_overall_grade")
  
  // Curriculum coverage
  curriculumCodesAchieved String[] @default([]) @map("curriculum_codes_achieved")
  curriculumCodesWorking  String[] @default([]) @map("curriculum_codes_working")
  
  // Effort and engagement
  effortGrade             String?  @map("effort_grade")
  engagementMetrics       Json?    @map("engagement_metrics")
  // { totalMinutes, averageSessionLength, streakDays, practiceTestCount }
  
  // Comments
  strengthsComment        String?  @map("strengths_comment") @db.Text
  areasForGrowthComment   String?  @map("areas_for_growth_comment") @db.Text
  generalComment          String?  @map("general_comment") @db.Text
  
  // AI-generated draft comments
  aiDraftComments         Json?    @map("ai_draft_comments")
  teacherEditedComments   Boolean  @default(false) @map("teacher_edited_comments")
  
  // Goals
  goalsForNextPeriod      String[] @default([]) @map("goals_for_next_period")
  
  // Parent acknowledgement
  parentAcknowledgedAt    DateTime? @map("parent_acknowledged_at")
  parentComments          String?  @map("parent_comments")
  
  // PDF generation
  pdfUrl                  String?  @map("pdf_url")
  pdfGeneratedAt          DateTime? @map("pdf_generated_at")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([reportId, profileId])
  @@index([profileId])
  @@map("student_language_reports")
}

/// Report template
model ReportTemplate {
  id                      String   @id @default(cuid())
  tenantId                String   @map("tenant_id")
  
  name                    String
  description             String?
  
  reportType              String   @map("report_type")
  // term, semester, annual, ib_progress, ib_final
  
  curriculumFramework     String?  @map("curriculum_framework")
  
  // Template structure
  sections                Json
  // [{ sectionId, title, type: "grades"|"comments"|"metrics"|"goals", config: {...} }]
  
  // Grading scale
  gradingScale            Json     @map("grading_scale")
  // { type: "letter"|"number"|"descriptor", values: [...] }
  
  // Comment banks
  strengthsCommentBank    Json     @default("[]") @map("strengths_comment_bank")
  growthCommentBank       Json     @default("[]") @map("growth_comment_bank")
  generalCommentBank      Json     @default("[]") @map("general_comment_bank")
  
  // PDF styling
  pdfTemplate             Json?    @map("pdf_template")
  headerLogo              String?  @map("header_logo")
  footerText              String?  @map("footer_text")
  
  isDefault               Boolean  @default(false) @map("is_default")
  isActive                Boolean  @default(true) @map("is_active")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, reportType])
  @@map("report_templates")
}

// ============================================================================
// PART 10: CONTENT LIBRARY
// ============================================================================

/// Master vocabulary list
model MasterVocabularyItem {
  id                      String   @id @default(cuid())
  language                String
  
  word                    String
  wordNormalised          String   @map("word_normalised")
  
  partOfSpeech            String   @map("part_of_speech")
  gender                  String?
  plural                  String?
  conjugationGroup        String?  @map("conjugation_group")
  
  definition              String
  definitionInEnglish     String   @map("definition_in_english")
  exampleSentence         String?  @map("example_sentence")
  exampleTranslation      String?  @map("example_translation")
  
  pronunciationUrl        String?  @map("pronunciation_url")
  ipa                     String?
  
  cefrLevel               String   @map("cefr_level")
  topics                  String[] @default([])
  frequency               Int      @default(0)
  
  synonyms                String[] @default([])
  antonyms                String[] @default([])
  relatedWords            String[] @default([]) @map("related_words")
  
  // Chinese specific
  pinyinOrRomanisation    String?  @map("pinyin_or_romanisation")
  characters              String?
  strokeCount             Int?     @map("stroke_count")
  radicals                String[] @default([])
  
  // Heritage register markers
  registerLevel           String?  @map("register_level")
  // colloquial, standard, formal, academic, literary
  dialectVariants         Json?    @map("dialect_variants")
  
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([language, word])
  @@index([language, cefrLevel])
  @@index([language, wordNormalised])
  @@map("master_vocabulary_items")
}

/// System conversation scenario
model ConversationScenario {
  id                      String   @id @default(cuid())
  language                String
  
  title                   String
  titleInEnglish          String   @map("title_in_english")
  description             String
  context                 String
  
  scenarioType            String   @map("scenario_type")
  cefrLevel               String   @map("cefr_level")
  
  aiRole                  String   @map("ai_role")
  aiPersonaDescription    String   @map("ai_persona_description")
  
  targetVocabulary        String[] @default([]) @map("target_vocabulary")
  targetStructures        String[] @default([]) @map("target_structures")
  
  suggestedFlow           Json     @map("suggested_flow")
  successCriteria         Json     @map("success_criteria")
  
  topics                  String[] @default([])
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  ibThemes                String[] @default([]) @map("ib_themes")
  
  // Heritage variant
  hasHeritageVariant      Boolean  @default(false) @map("has_heritage_variant")
  heritageVariant         Json?    @map("heritage_variant")
  
  isActive                Boolean  @default(true) @map("is_active")
  
  timesUsed               Int      @default(0) @map("times_used")
  averageScore            Float?   @map("average_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([language, cefrLevel])
  @@index([scenarioType])
  @@map("conversation_scenarios")
}

/// System text resource
model LanguageTextResource {
  id                      String   @id @default(cuid())
  tenantId                String?  @map("tenant_id")
  language                String
  
  title                   String
  textContent             String   @map("text_content") @db.Text
  
  resourceType            String   @map("resource_type")
  modality                String
  
  audioUrl                String?  @map("audio_url")
  audioDurationSeconds    Int?     @map("audio_duration_seconds")
  
  cefrLevel               String   @map("cefr_level")
  wordCount               Int      @map("word_count")
  averageSentenceLength   Float    @map("average_sentence_length")
  
  keyVocabulary           String[] @default([]) @map("key_vocabulary")
  keyStructures           String[] @default([]) @map("key_structures")
  
  comprehensionQuestions  Json     @default("[]") @map("comprehension_questions")
  
  topics                  String[] @default([])
  themes                  String[] @default([])
  
  culturalNotes           String?  @map("cultural_notes")
  
  isAuthentic             Boolean  @default(false) @map("is_authentic")
  source                  String?
  
  curriculumCodes         String[] @default([]) @map("curriculum_codes")
  ibThemes                String[] @default([]) @map("ib_themes")
  
  isActive                Boolean  @default(true) @map("is_active")
  
  timesUsed               Int      @default(0) @map("times_used")
  averageComprehensionScore Float? @map("average_comprehension_score")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@index([language, cefrLevel])
  @@index([resourceType])
  @@map("language_text_resources")
}

// ============================================================================
// PART 11: CURRICULUM & IB SUPPORT
// ============================================================================

/// IB Language curriculum
model IBLanguageCurriculum {
  id                      String   @id @default(cuid())
  
  programme               String
  course                  String
  level                   String?
  phase                   String?
  
  theme                   String
  topic                   String?
  
  description             String   @db.Text
  learningObjectives      String[] @map("learning_objectives")
  
  assessmentCriteria      Json     @map("assessment_criteria")
  commandTerms            String[] @map("command_terms")
  
  cefrEquivalent          String   @map("cefr_equivalent")
  
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  
  @@unique([programme, course, level, theme])
  @@index([programme, course])
  @@map("ib_language_curriculum")
}

/// CEFR descriptors
model CEFRDescriptor {
  id                      String   @id @default(cuid())
  
  level                   String
  skill                   String
  subSkill                String?  @map("sub_skill")
  
  descriptor              String   @db.Text
  canDoStatement          String   @map("can_do_statement") @db.Text
  
  exampleTasks            String[] @default([]) @map("example_tasks")
  assessmentIndicators    String[] @default([]) @map("assessment_indicators")
  
  createdAt               DateTime @default(now()) @map("created_at")
  
  @@unique([level, skill, subSkill])
  @@index([level])
  @@index([skill])
  @@map("cefr_descriptors")
}
