// ============================================================================
// SCHOLARLY EXTENSIONS - PRISMA SCHEMA
// ============================================================================
// 
// This schema extends Scholarly with:
// 1. Early Years Curriculum Support (EYLF, EYFS)
// 2. Third-Party Integrations (Canva, Google, Microsoft, PayPal, PayID, Zimbra)
//
// @version 1.0.0
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// EARLY YEARS CURRICULUM MODELS
// ============================================================================

/// Early years curriculum framework (EYLF, EYFS, etc.)
model EarlyYearsFramework {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  
  // Identity
  code          String   // EYLF, EYFS, TE_WHARIKI, HEAD_START
  name          String
  version       String
  jurisdiction  String
  
  // Age range
  minAgeMonths  Int      @map("min_age_months")
  maxAgeMonths  Int      @map("max_age_months")
  ageRangeDisplay String @map("age_range_display")
  
  // Source
  sourceUrl     String   @map("source_url")
  effectiveFrom DateTime @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  
  // AI enrichment stats
  conceptsExtracted    Int @default(0) @map("concepts_extracted")
  progressionsIdentified Int @default(0) @map("progressions_identified")
  crossMappingsGenerated Int @default(0) @map("cross_mappings_generated")
  lastEnrichedAt       DateTime? @map("last_enriched_at")
  
  // Timestamps
  ingestedAt    DateTime @default(now()) @map("ingested_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  outcomes      LearningOutcome[]
  areas         DevelopmentalArea[]
  principles    FrameworkPrinciple[]
  practices     FrameworkPractice[]
  childProgress ChildFrameworkProgress[]
  
  @@unique([tenantId, code, version])
  @@index([tenantId])
  @@map("early_years_frameworks")
}

/// Learning outcome (e.g., EYLF Outcome 1: Children have a strong sense of identity)
model LearningOutcome {
  id            String   @id @default(cuid())
  frameworkId   String   @map("framework_id")
  
  // Identity
  code          String   // EYLF_O1, EYFS_CL
  number        Int?     // 1, 2, 3...
  name          String
  description   String   @db.Text
  
  // AI enrichment
  keyConcepts   String[] @map("key_concepts")
  developmentalDomains String[] @map("developmental_domains")
  embedding     Float[]  // Vector for semantic matching
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  framework     EarlyYearsFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  subElements   OutcomeSubElement[]
  indicators    OutcomeIndicator[]
  observationLinks ObservationOutcomeLink[]
  outcomeProgress ChildOutcomeProgress[]
  
  @@unique([frameworkId, code])
  @@index([frameworkId])
  @@map("learning_outcomes")
}

/// Sub-element of an outcome (e.g., EYLF_O1.1: Children feel safe, secure, and supported)
model OutcomeSubElement {
  id            String   @id @default(cuid())
  outcomeId     String   @map("outcome_id")
  
  code          String   // EYLF_O1.1
  description   String   @db.Text
  exampleBehaviours String[] @map("example_behaviours")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  outcome       LearningOutcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  progressDescriptors ProgressionDescriptor[]
  
  @@index([outcomeId])
  @@map("outcome_sub_elements")
}

/// Observable indicator for an outcome
model OutcomeIndicator {
  id            String   @id @default(cuid())
  outcomeId     String   @map("outcome_id")
  subElementId  String?  @map("sub_element_id")
  
  text          String   @db.Text
  exampleObservations String[] @map("example_observations")
  keywords      String[]
  embedding     Float[]
  
  // Age suitability
  minAgeMonths  Int?     @map("min_age_months")
  maxAgeMonths  Int?     @map("max_age_months")
  
  indicatesLevel String  @map("indicates_level") // emerging, developing, secure, extending
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  outcome       LearningOutcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  
  @@index([outcomeId])
  @@map("outcome_indicators")
}

/// Progression descriptor for a sub-element
model ProgressionDescriptor {
  id            String   @id @default(cuid())
  subElementId  String   @map("sub_element_id")
  
  level         String   // not_yet_observed, emerging, developing, secure, extending, embedded
  description   String   @db.Text
  typicalIndicators String[] @map("typical_indicators")
  
  // Typical age range
  minAgeMonths  Int?     @map("min_age_months")
  maxAgeMonths  Int?     @map("max_age_months")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  subElement    OutcomeSubElement @relation(fields: [subElementId], references: [id], onDelete: Cascade)
  
  @@unique([subElementId, level])
  @@map("progression_descriptors")
}

/// Developmental area (EYFS-style areas of learning)
model DevelopmentalArea {
  id            String   @id @default(cuid())
  frameworkId   String   @map("framework_id")
  
  code          String   // EYFS_PRIME_CL, EYLF_DA_IDENTITY
  name          String
  description   String   @db.Text
  areaType      String?  @map("area_type") // prime, specific, cross_cutting
  
  linkedAreaIds String[] @map("linked_area_ids")
  supportedOutcomeIds String[] @map("supported_outcome_ids")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  framework     EarlyYearsFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  aspects       DevelopmentalAspect[]
  
  @@unique([frameworkId, code])
  @@index([frameworkId])
  @@map("developmental_areas")
}

/// Aspect within a developmental area
model DevelopmentalAspect {
  id            String   @id @default(cuid())
  areaId        String   @map("area_id")
  
  code          String
  name          String
  description   String   @db.Text
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  area          DevelopmentalArea @relation(fields: [areaId], references: [id], onDelete: Cascade)
  
  @@index([areaId])
  @@map("developmental_aspects")
}

/// Framework principle
model FrameworkPrinciple {
  id            String   @id @default(cuid())
  frameworkId   String   @map("framework_id")
  
  code          String
  name          String
  description   String   @db.Text
  practiceIndicators String[] @map("practice_indicators")
  reflectiveQuestions String[] @map("reflective_questions")
  relatedOutcomeIds String[] @map("related_outcome_ids")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  framework     EarlyYearsFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  
  @@unique([frameworkId, code])
  @@map("framework_principles")
}

/// Framework practice
model FrameworkPractice {
  id            String   @id @default(cuid())
  frameworkId   String   @map("framework_id")
  
  code          String
  name          String
  description   String   @db.Text
  indicators    String[]
  strategies    String[]
  relatedPrincipleIds String[] @map("related_principle_ids")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  framework     EarlyYearsFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  
  @@unique([frameworkId, code])
  @@map("framework_practices")
}

/// Cross-framework mapping
model CrossFrameworkMapping {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  sourceFramework String   @map("source_framework")
  sourceCode      String   @map("source_code")
  sourceType      String   @map("source_type") // outcome, area, indicator, goal
  
  targetFramework String   @map("target_framework")
  targetCode      String   @map("target_code")
  targetType      String   @map("target_type")
  
  mappingType     String   @map("mapping_type") // equivalent, partial, related, broader, narrower
  confidence      Float
  explanation     String   @db.Text
  source          String   // official, ai_generated, educator_validated
  
  validatedBy     String?  @map("validated_by")
  validatedAt     DateTime? @map("validated_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@unique([sourceFramework, sourceCode, targetFramework, targetCode])
  @@index([tenantId])
  @@index([sourceFramework, sourceCode])
  @@index([targetFramework, targetCode])
  @@map("cross_framework_mappings")
}

/// Child's progress against a framework
model ChildFrameworkProgress {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  childId         String   @map("child_id")
  frameworkId     String   @map("framework_id")
  
  ageAtLastUpdate Int      @map("age_at_last_update") // months
  
  // AI summary
  narrativeSummary String? @map("narrative_summary") @db.Text
  keyHighlights   String[] @map("key_highlights")
  recommendations String[]
  summaryGeneratedAt DateTime? @map("summary_generated_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  lastObservationAt DateTime? @map("last_observation_at")
  
  // Relations
  framework       EarlyYearsFramework @relation(fields: [frameworkId], references: [id])
  outcomeProgress ChildOutcomeProgress[]
  strengths       ChildStrength[]
  areasForGrowth  ChildGrowthArea[]
  
  @@unique([tenantId, childId, frameworkId])
  @@index([tenantId, childId])
  @@map("child_framework_progress")
}

/// Child's progress on a specific outcome
model ChildOutcomeProgress {
  id              String   @id @default(cuid())
  progressId      String   @map("progress_id")
  outcomeId       String   @map("outcome_id")
  
  currentLevel    String   @map("current_level") // not_yet_observed, emerging, developing, secure, extending
  trend           String   // progressing, consolidating, needs_support, insufficient_data
  evidenceCount   Int      @default(0) @map("evidence_count")
  lastEvidenceAt  DateTime? @map("last_evidence_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  progress        ChildFrameworkProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  outcome         LearningOutcome @relation(fields: [outcomeId], references: [id])
  
  @@unique([progressId, outcomeId])
  @@map("child_outcome_progress")
}

/// Child's identified strength
model ChildStrength {
  id              String   @id @default(cuid())
  progressId      String   @map("progress_id")
  outcomeId       String   @map("outcome_id")
  
  description     String   @db.Text
  evidenceObservationIds String[] @map("evidence_observation_ids")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  progress        ChildFrameworkProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  @@map("child_strengths")
}

/// Child's area for growth
model ChildGrowthArea {
  id              String   @id @default(cuid())
  progressId      String   @map("progress_id")
  outcomeId       String   @map("outcome_id")
  
  description     String   @db.Text
  suggestedStrategies String[] @map("suggested_strategies")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  progress        ChildFrameworkProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  
  @@map("child_growth_areas")
}

/// Link between observation and framework outcomes
model ObservationOutcomeLink {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  observationId   String   @map("observation_id")
  outcomeId       String   @map("outcome_id")
  
  evidenceStrength String  @map("evidence_strength") // strong, supporting, emerging
  levelDemonstrated String? @map("level_demonstrated")
  
  // AI analysis
  aiConfidence    Float?   @map("ai_confidence")
  aiReasoning     String?  @map("ai_reasoning") @db.Text
  
  // Teacher validation
  teacherValidated Boolean @default(false) @map("teacher_validated")
  validatedBy     String?  @map("validated_by")
  validatedAt     DateTime? @map("validated_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  outcome         LearningOutcome @relation(fields: [outcomeId], references: [id])
  
  @@unique([observationId, outcomeId])
  @@index([tenantId, observationId])
  @@map("observation_outcome_links")
}

/// Generated progress report
model ProgressReport {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  childId         String   @map("child_id")
  frameworkId     String   @map("framework_id")
  
  reportType      String   @map("report_type") // termly_summary, annual_report, transition_statement, 2_year_check
  audience        String   // parent, educator, next_setting, health_visitor
  
  // Report content (JSON)
  content         Json
  
  // Configuration
  config          Json
  
  // Period covered
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  childAgeAtReport Int     @map("child_age_at_report") // months
  
  // Observations used
  observationIdsUsed String[] @map("observation_ids_used")
  
  // Status
  status          String   @default("draft") // draft, approved, shared
  approvedBy      String?  @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  sharedAt        DateTime? @map("shared_at")
  
  // Generation
  generatedAt     DateTime @map("generated_at")
  generatedBy     String   @map("generated_by") // ai, teacher, hybrid
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId, childId])
  @@map("progress_reports")
}

// ============================================================================
// INTEGRATION MODELS
// ============================================================================

/// Integration connection (OAuth credentials, settings)
model IntegrationConnection {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  userId          String   @map("user_id")
  
  provider        String   // canva, google_classroom, gmail, outlook_365, paypal, payid, zimbra
  status          String   // connected, disconnected, expired, error, pending_authorization
  
  // OAuth credentials (encrypted)
  accessToken     String?  @map("access_token") @db.Text
  refreshToken    String?  @map("refresh_token") @db.Text
  tokenType       String?  @map("token_type")
  tokenExpiresAt  DateTime? @map("token_expires_at")
  tokenScope      String[] @map("token_scope")
  
  // API key auth (for non-OAuth providers)
  apiKey          String?  @map("api_key") @db.Text
  
  // Provider-specific data
  providerUserId  String?  @map("provider_user_id")
  providerEmail   String?  @map("provider_email")
  providerData    Json?    @map("provider_data")
  
  // Settings
  autoSync        Boolean  @default(true) @map("auto_sync")
  syncFrequencyMinutes Int? @map("sync_frequency_minutes")
  notifyOnSync    Boolean  @default(false) @map("notify_on_sync")
  notifyOnError   Boolean  @default(true) @map("notify_on_error")
  providerSettings Json?   @map("provider_settings")
  
  // Connection status
  connectedAt     DateTime @map("connected_at")
  lastUsedAt      DateTime? @map("last_used_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  errorMessage    String?  @map("error_message")
  errorAt         DateTime? @map("error_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  syncJobs        SyncJob[]
  webhooks        WebhookConfig[]
  
  @@unique([tenantId, userId, provider])
  @@index([tenantId, userId])
  @@index([tenantId, provider])
  @@map("integration_connections")
}

/// Sync job configuration
model SyncJob {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  connectionId    String   @map("connection_id")
  
  provider        String
  syncType        String   @map("sync_type")
  scheduleType    String   @map("schedule_type") // manual, scheduled, webhook_triggered
  cronExpression  String?  @map("cron_expression")
  
  status          String   @default("idle") // idle, running, completed, failed
  lastRunAt       DateTime? @map("last_run_at")
  nextRunAt       DateTime? @map("next_run_at")
  
  // Last result (JSON)
  lastResult      Json?    @map("last_result")
  
  // Settings
  settings        Json
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  connection      IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([connectionId])
  @@index([status, nextRunAt])
  @@map("sync_jobs")
}

/// Webhook configuration
model WebhookConfig {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  connectionId    String   @map("connection_id")
  
  provider        String
  webhookUrl      String   @map("webhook_url")
  secret          String?  @db.Text
  
  events          String[]
  active          Boolean  @default(true)
  
  providerWebhookId String? @map("provider_webhook_id")
  verifiedAt      DateTime? @map("verified_at")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  connection      IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, provider])
  @@map("webhook_configs")
}

/// Webhook event log
model WebhookEvent {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  provider        String
  eventType       String   @map("event_type")
  payload         Json
  signature       String?
  
  status          String   @default("pending") // pending, processed, failed
  error           String?
  
  // Timestamps
  receivedAt      DateTime @map("received_at")
  processedAt     DateTime? @map("processed_at")
  
  @@index([tenantId, provider])
  @@index([status])
  @@map("webhook_events")
}

/// Rate limit tracking
model RateLimitUsage {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  provider        String
  
  minuteUsage     Int      @default(0) @map("minute_usage")
  hourUsage       Int      @default(0) @map("hour_usage")
  dayUsage        Int      @default(0) @map("day_usage")
  
  minuteResetAt   DateTime @map("minute_reset_at")
  hourResetAt     DateTime @map("hour_reset_at")
  dayResetAt      DateTime @map("day_reset_at")
  
  // Timestamps
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([tenantId, provider])
  @@map("rate_limit_usage")
}

/// Canva design record (for tracking created designs)
model CanvaDesign {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  userId          String   @map("user_id")
  
  canvaDesignId   String   @map("canva_design_id")
  title           String
  designType      String   @map("design_type")
  
  editUrl         String   @map("edit_url")
  viewUrl         String   @map("view_url")
  thumbnailUrl    String?  @map("thumbnail_url")
  
  // Dimensions
  width           Int
  height          Int
  
  // Scholarly linking
  scholarlyResourceId String? @map("scholarly_resource_id")
  scholarlyResourceType String? @map("scholarly_resource_type")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@unique([canvaDesignId])
  @@index([tenantId, userId])
  @@map("canva_designs")
}

/// Google Classroom course sync record
model GoogleClassroomCourseSync {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  
  googleCourseId    String   @map("google_course_id")
  scholarlyClassroomId String @map("scholarly_classroom_id")
  
  googleCourseName  String   @map("google_course_name")
  lastSyncAt        DateTime? @map("last_sync_at")
  syncStatus        String   @map("sync_status") // active, paused, error
  syncDirection     String   @map("sync_direction") // google_to_scholarly, scholarly_to_google, bidirectional
  
  // Sync settings
  syncStudents      Boolean  @default(true) @map("sync_students")
  syncTeachers      Boolean  @default(true) @map("sync_teachers")
  syncAssignments   Boolean  @default(true) @map("sync_assignments")
  syncSubmissions   Boolean  @default(true) @map("sync_submissions")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@unique([tenantId, googleCourseId])
  @@unique([tenantId, scholarlyClassroomId])
  @@map("google_classroom_course_syncs")
}

/// PayPal payment record
model PayPalPaymentRecord {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  paypalOrderId   String   @map("paypal_order_id")
  status          String   // created, approved, completed, cancelled, failed, refunded
  
  amount          Decimal  @db.Decimal(10, 2)
  currency        String
  fee             Decimal? @db.Decimal(10, 2)
  netAmount       Decimal? @db.Decimal(10, 2) @map("net_amount")
  
  payerEmail      String?  @map("payer_email")
  payerId         String?  @map("payer_id")
  
  // Scholarly linking
  scholarlyPaymentId String? @map("scholarly_payment_id")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  approvedAt      DateTime? @map("approved_at")
  completedAt     DateTime? @map("completed_at")
  
  @@unique([paypalOrderId])
  @@index([tenantId])
  @@index([scholarlyPaymentId])
  @@map("paypal_payment_records")
}

/// PayID payment record
model PayIDPaymentRecord {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  
  status          String   // pending, completed, failed, returned
  
  amount          Int      // Amount in cents
  currency        String   @default("AUD")
  reference       String
  
  recipientPayId  String   @map("recipient_pay_id")
  recipientName   String?  @map("recipient_name")
  
  // NPP details
  nppTransactionId String? @map("npp_transaction_id")
  nppSettlementDate String? @map("npp_settlement_date")
  
  // Error details
  failureReason   String?  @map("failure_reason")
  returnReason    String?  @map("return_reason")
  
  // Scholarly linking
  scholarlyPaymentId String? @map("scholarly_payment_id")
  
  // Timestamps
  initiatedAt     DateTime @map("initiated_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([tenantId])
  @@index([scholarlyPaymentId])
  @@map("payid_payment_records")
}
