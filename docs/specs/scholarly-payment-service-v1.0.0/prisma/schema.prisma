// =============================================================================
// SCHOLARLY PAYMENT SERVICE - PRISMA SCHEMA
// =============================================================================
// 
// Database schema for the financial infrastructure of the Scholarly platform.
// Handles financial accounts, invoices, payments, payouts, and integrations.
//
// @version 1.0.0
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum AccountOwnerType {
  school
  micro_school
  tutor
  tutoring_centre
  homeschool_coop
  parent
  content_creator
}

enum AccountStatus {
  pending_setup
  onboarding
  pending_review
  active
  suspended
  closed
}

enum AccountVerificationLevel {
  unverified
  email_verified
  identity_verified
  bank_verified
  fully_verified
}

enum Currency {
  AUD
  GBP
  USD
  CAD
  NZD
  SGD
}

enum FeeCategory {
  tuition
  enrollment
  materials
  technology
  excursion
  uniform
  examination
  tutoring
  co_curricular
  boarding
  transport
  catering
  facility
  insurance
  late_payment
  marketplace
  subscription
  other
}

enum InvoiceStatus {
  draft
  pending
  sent
  viewed
  partial
  paid
  overdue
  void
  written_off
}

enum PayoutStatus {
  calculating
  pending
  processing
  in_transit
  paid
  failed
  cancelled
}

enum RefundReason {
  requested_by_customer
  duplicate_payment
  fraudulent
  session_cancelled_by_tutor
  session_cancelled_by_student
  quality_issue
  policy_withdrawal
  other
}

enum RefundStatus {
  pending
  processing
  succeeded
  failed
  cancelled
}

enum XeroSyncStatus {
  pending
  syncing
  synced
  error
  manual
}

enum ProfileStatus {
  draft
  pending_review
  pending_verification
  published
  suspended
  archived
}

enum ProfileBuildStage {
  welcome
  basics
  qualifications
  teaching_style
  subjects
  availability
  story
  review
  polish
  complete
}

// =============================================================================
// FINANCIAL ACCOUNTS
// =============================================================================

model FinancialAccount {
  id                  String                   @id @default(cuid())
  tenantId            String                   @map("tenant_id")
  
  ownerType           AccountOwnerType         @map("owner_type")
  ownerId             String                   @map("owner_id")
  ownerName           String                   @map("owner_name")
  ownerEmail          String                   @map("owner_email")
  
  legalEntity         Json                     @map("legal_entity")
  balances            Json
  stripeConnect       Json                     @map("stripe_connect")
  xeroIntegration     Json?                    @map("xero_integration")
  payoutMethod        Json?                    @map("payout_method")
  settings            Json
  stats               Json
  
  status              AccountStatus            @default(pending_setup)
  statusReason        String?                  @map("status_reason")
  statusChangedAt     DateTime?                @map("status_changed_at")
  
  verificationLevel   AccountVerificationLevel @default(unverified) @map("verification_level")
  kycStatus           Json                     @map("kyc_status")
  
  audit               Json
  
  createdAt           DateTime                 @default(now()) @map("created_at")
  updatedAt           DateTime                 @updatedAt @map("updated_at")
  
  // Relations
  feeStructures       FeeStructure[]
  issuedInvoices      Invoice[]                @relation("IssuerAccount")
  receivedInvoices    Invoice[]                @relation("RecipientAccount")
  payouts             Payout[]
  refunds             Refund[]
  
  @@unique([tenantId, ownerId])
  @@index([tenantId, ownerType])
  @@index([status])
  @@map("financial_accounts")
}

// =============================================================================
// FEE STRUCTURES
// =============================================================================

model FeeStructure {
  id              String       @id @default(cuid())
  tenantId        String       @map("tenant_id")
  accountId       String       @map("account_id")
  
  name            String
  description     String
  category        FeeCategory
  
  applicability   Json
  pricing         Json
  taxConfig       Json         @map("tax_config")
  billingSchedule Json?        @map("billing_schedule")
  refundPolicy    Json         @map("refund_policy")
  variations      Json         @default("[]")
  paymentPlans    Json         @default("[]") @map("payment_plans")
  
  status          String       @default("active")
  effectiveFrom   DateTime     @map("effective_from")
  effectiveTo     DateTime?    @map("effective_to")
  
  audit           Json
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  
  account         FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId, status])
  @@index([tenantId, category])
  @@map("fee_structures")
}

// =============================================================================
// INVOICES
// =============================================================================

model Invoice {
  id                    String        @id @default(cuid())
  tenantId              String        @map("tenant_id")
  
  issuerId              String        @map("issuer_id")
  issuerAccountId       String        @map("issuer_account_id")
  issuerDetails         Json          @map("issuer_details")
  
  recipientId           String?       @map("recipient_id")
  recipientType         String        @map("recipient_type")
  recipientDetails      Json          @map("recipient_details")
  
  studentId             String?       @map("student_id")
  studentName           String?       @map("student_name")
  enrollmentId          String?       @map("enrollment_id")
  
  invoiceNumber         String        @unique @map("invoice_number")
  reference             String?
  purchaseOrderNumber   String?       @map("purchase_order_number")
  
  issueDate             DateTime      @map("issue_date")
  dueDate               DateTime      @map("due_date")
  periodStart           DateTime?     @map("period_start")
  periodEnd             DateTime?     @map("period_end")
  
  lineItems             Json          @map("line_items")
  
  subtotal              Int
  discountTotal         Int           @map("discount_total")
  taxTotal              Int           @map("tax_total")
  total                 Int
  amountPaid            Int           @default(0) @map("amount_paid")
  amountDue             Int           @map("amount_due")
  currency              Currency      @default(AUD)
  
  status                InvoiceStatus @default(draft)
  statusHistory         Json          @map("status_history") @default("[]")
  
  payments              Json          @default("[]")
  paymentPlan           Json?         @map("payment_plan")
  reminders             Json          @default("[]")
  
  notes                 String?
  internalNotes         String?       @map("internal_notes")
  terms                 String?
  
  xeroSync              Json?         @map("xero_sync")
  stripeInvoiceId       String?       @map("stripe_invoice_id")
  stripePaymentIntentId String?       @map("stripe_payment_intent_id")
  
  viewUrl               String?       @map("view_url")
  pdfUrl                String?       @map("pdf_url")
  
  metadata              Json          @default("{}")
  audit                 Json
  
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  
  issuerAccount         FinancialAccount  @relation("IssuerAccount", fields: [issuerId], references: [id])
  recipientAccount      FinancialAccount? @relation("RecipientAccount", fields: [recipientId], references: [id])
  refunds               Refund[]
  
  @@index([tenantId, status])
  @@index([issuerId, status])
  @@index([recipientId])
  @@index([dueDate])
  @@map("invoices")
}

// =============================================================================
// PAYOUTS
// =============================================================================

model Payout {
  id                  String       @id @default(cuid())
  tenantId            String       @map("tenant_id")
  accountId           String       @map("account_id")
  
  amount              Int
  currency            Currency     @default(AUD)
  
  breakdown           Json
  transactions        Json         @default("[]")
  
  stripePayoutId      String?      @map("stripe_payout_id")
  stripeTransferId    String?      @map("stripe_transfer_id")
  
  destinationBankName String?      @map("destination_bank_name")
  destinationLast4    String       @map("destination_last4")
  
  status              PayoutStatus @default(pending)
  statusHistory       Json         @map("status_history") @default("[]")
  
  scheduledFor        DateTime?    @map("scheduled_for")
  initiatedAt         DateTime?    @map("initiated_at")
  estimatedArrival    DateTime?    @map("estimated_arrival")
  arrivedAt           DateTime?    @map("arrived_at")
  
  failureCode         String?      @map("failure_code")
  failureReason       String?      @map("failure_reason")
  retryCount          Int          @default(0) @map("retry_count")
  lastRetryAt         DateTime?    @map("last_retry_at")
  
  statementDescriptor String       @map("statement_descriptor")
  statementPeriod     Json         @map("statement_period")
  
  xeroPaymentId       String?      @map("xero_payment_id")
  xeroSyncStatus      XeroSyncStatus @default(pending) @map("xero_sync_status")
  
  audit               Json
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  
  account             FinancialAccount @relation(fields: [accountId], references: [id])
  
  @@index([accountId, status])
  @@index([tenantId])
  @@map("payouts")
}

// =============================================================================
// REFUNDS
// =============================================================================

model Refund {
  id                  String       @id @default(cuid())
  tenantId            String       @map("tenant_id")
  
  invoiceId           String       @map("invoice_id")
  paymentId           String       @map("payment_id")
  accountId           String       @map("account_id")
  
  amount              Int
  currency            Currency     @default(AUD)
  
  reason              RefundReason
  reasonDescription   String?      @map("reason_description")
  
  stripeRefundId      String?      @map("stripe_refund_id")
  stripeStatus        String?      @map("stripe_status")
  
  status              RefundStatus @default(pending)
  processedAt         DateTime?    @map("processed_at")
  failureReason       String?      @map("failure_reason")
  
  deductedFromPayoutId String?     @map("deducted_from_payout_id")
  
  audit               Json
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  
  invoice             Invoice      @relation(fields: [invoiceId], references: [id])
  account             FinancialAccount @relation(fields: [accountId], references: [id])
  
  @@index([invoiceId])
  @@index([accountId])
  @@map("refunds")
}

// =============================================================================
// TUTOR PROFILES
// =============================================================================

model TutorProfile {
  id                  String        @id @default(cuid())
  tutorId             String        @unique @map("tutor_id")
  tenantId            String        @map("tenant_id")
  
  basics              Json
  professional        Json
  teachingStyle       Json          @map("teaching_style")
  aiContent           Json          @map("ai_content")
  media               Json
  trustSignals        Json          @map("trust_signals")
  availability        Json
  pricing             Json
  
  status              ProfileStatus @default(draft)
  publishedAt         DateTime?     @map("published_at")
  lastUpdatedAt       DateTime      @map("last_updated_at")
  
  analytics           Json
  searchOptimization  Json          @map("search_optimization")
  
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  createdBy           String        @map("created_by")
  updatedBy           String        @map("updated_by")
  
  sessions            ProfileBuilderSession[]
  
  @@index([tenantId, status])
  @@index([status])
  @@map("tutor_profiles")
}

// =============================================================================
// PROFILE BUILDER SESSIONS
// =============================================================================

model ProfileBuilderSession {
  id                  String            @id @default(cuid())
  tutorId             String            @map("tutor_id")
  tenantId            String            @map("tenant_id")
  
  stage               ProfileBuildStage @default(welcome)
  stagesCompleted     String[]          @map("stages_completed")
  questionsCompleted  Int               @default(0) @map("questions_completed")
  totalQuestions      Int               @map("total_questions")
  progressPercentage  Int               @default(0) @map("progress_percentage")
  
  responses           Json              @default("[]")
  extractedInsights   Json              @map("extracted_insights")
  drafts              Json
  selections          Json
  
  conversationHistory Json              @map("conversation_history") @default("[]")
  
  startedAt           DateTime          @map("started_at")
  lastActivityAt      DateTime          @map("last_activity_at")
  completedAt         DateTime?         @map("completed_at")
  expiresAt           DateTime          @map("expires_at")
  
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  
  profile             TutorProfile?     @relation(fields: [tutorId], references: [tutorId])
  
  @@index([tutorId])
  @@index([tenantId])
  @@map("profile_builder_sessions")
}

// =============================================================================
// PAYMENT EVENTS (Audit Trail)
// =============================================================================

model PaymentEvent {
  id          String   @id @default(cuid())
  type        String
  tenantId    String   @map("tenant_id")
  accountId   String   @map("account_id")
  timestamp   DateTime @default(now())
  data        Json     @default("{}")
  metadata    Json     @default("{}")
  
  @@index([tenantId, type])
  @@index([accountId])
  @@index([timestamp])
  @@map("payment_events")
}

// =============================================================================
// XERO CONNECTIONS
// =============================================================================

model XeroConnection {
  id              String   @id @default(cuid())
  accountId       String   @unique @map("account_id")
  tenantId        String   @map("tenant_id")
  
  xeroTenantId    String   @map("xero_tenant_id")
  xeroTenantName  String   @map("xero_tenant_name")
  
  accessToken     String   @map("access_token")
  refreshToken    String   @map("refresh_token")
  tokenExpiresAt  DateTime @map("token_expires_at")
  
  contactId       String?  @map("contact_id")
  defaultAccounts Json     @map("default_accounts")
  
  syncEnabled     Boolean  @default(true) @map("sync_enabled")
  lastSyncAt      DateTime? @map("last_sync_at")
  lastSyncError   String?  @map("last_sync_error")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([tenantId])
  @@map("xero_connections")
}

// =============================================================================
// STRIPE WEBHOOKS (Idempotency)
// =============================================================================

model StripeWebhook {
  id              String   @id @default(cuid())
  eventId         String   @unique @map("event_id")
  eventType       String   @map("event_type")
  
  processed       Boolean  @default(false)
  processedAt     DateTime? @map("processed_at")
  
  data            Json
  error           String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([eventType, processed])
  @@map("stripe_webhooks")
}