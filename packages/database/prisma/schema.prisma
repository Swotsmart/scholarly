// ============================================================================
// SCHOLARLY DATABASE SCHEMA - ENHANCED VERSION
// PostgreSQL with Prisma ORM
// 
// ENHANCEMENTS FROM ORIGINAL:
// ✓ Added AuditLog model for compliance tracking
// ✓ Added soft delete (deletedAt) to key entities
// ✓ Extracted high-churn JSON fields into proper models:
//   - TutorAvailabilitySlot (from TutorProfile.availability)
//   - TutorPricingTier (from TutorProfile.pricing)
//   - Address (shared across entities)
// ✓ Added Subject reference table to prevent data drift
// ✓ Added missing unique constraints (ContentReview, LearningAssetRequest)
// ✓ Added LearningAssetVote model (extracted from JSON)
// ✓ Added composite indexes for common query patterns
// ✓ Fixed attentionSpan typo in LearnerProfile
// ✓ Added EduScrum models for agile learning
// ✓ Added Notification models
// ✓ Added Analytics models
// ✓ Added FeatureFlag and TenantConfiguration
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUDIT & COMPLIANCE INFRASTRUCTURE
// ============================================================================

/// Comprehensive audit log for compliance with GDPR, child safety regulations,
/// and general security best practices. Every sensitive operation should be logged.
model AuditLog {
  id       String @id @default(cuid())
  tenantId String

  // Who performed the action
  userId    String? // Null for system actions
  userEmail String? // Denormalized for historical accuracy
  userRole  String? // Role at time of action

  // What happened
  action     String // create, read, update, delete, export, login, logout, permission_change
  entityType String // User, LearnerProfile, TutoringSession, etc.
  entityId   String

  // Change details
  changes  Json? // { before: {...}, after: {...} } for updates
  metadata Json? // Additional context

  // Request context
  ipAddress String?
  userAgent String?
  requestId String? // For correlating distributed operations

  // Classification
  sensitivity String @default("normal") // normal, sensitive, pii, child_data

  timestamp DateTime @default(now())

  @@index([tenantId, timestamp])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId, timestamp])
  @@index([tenantId, action, timestamp])
  @@index([sensitivity, timestamp])
}

// ============================================================================
// SHARED REFERENCE TABLES
// ============================================================================

/// Canonical subject definitions to prevent data drift between bookings and sessions
model Subject {
  id       String @id @default(cuid())
  tenantId String

  code        String // e.g., "MATH", "ENG", "SCI"
  name        String // e.g., "Mathematics", "English", "Science"
  description String?

  learningArea String? // e.g., "STEM", "Humanities", "Arts"
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tutorSubjects   TutorSubject[]
  learnerSubjects LearnerSubject[]
  bookings        Booking[]
  sessions        TutoringSession[]
  content         Content[]
  Tenant          Tenant            @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@index([learningArea])
}

/// Reusable address structure for families, schools, venues
model Address {
  id       String @id @default(cuid())
  tenantId String

  streetAddress String?
  suburb        String?
  city          String?
  state         String?
  postcode      String?
  country       String  @default("Australia")

  // Geolocation for proximity searches
  latitude  Float?
  longitude Float?

  type  String  @default("primary") // primary, mailing, venue
  label String? // "Home", "Work", etc.

  // Polymorphic ownership (only one should be set)
  homeschoolFamilyId String?           @unique
  homeschoolFamily   HomeschoolFamily? @relation(fields: [homeschoolFamilyId], references: [id], onDelete: Cascade)

  microSchoolId String?      @unique
  microSchool   MicroSchool? @relation(fields: [microSchoolId], references: [id], onDelete: Cascade)

  homeschoolCoopId String?         @unique
  homeschoolCoop   HomeschoolCoop? @relation("CoopPrimaryLocation", fields: [homeschoolCoopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([latitude, longitude])
  @@index([postcode])
}

// ============================================================================
// TENANT & USER MODELS
// ============================================================================

model Tenant {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  domain    String?
  settings  Json      @default("{}")
  status    String    @default("active") // active, suspended, cancelled
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  subjects     Subject[]
  bookings     Booking[]
  sessions     TutoringSession[]
  content      Content[]
  standards    CurriculumStandard[]
  families     HomeschoolFamily[]
  coops        HomeschoolCoop[]
  microSchools MicroSchool[]
  reliefPools  ReliefPool[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
}

model User {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  externalId   String?
  email        String
  phone        String?
  passwordHash String?
  displayName  String
  firstName    String
  lastName     String
  avatarUrl    String?
  bio          String?

  roles        String[] @default([])
  jurisdiction String   @default("AU_NSW")

  emailVerified    Boolean @default(false)
  phoneVerified    Boolean @default(false)
  identityVerified Boolean @default(false)

  trustScore   Float @default(50)
  tokenBalance Float @default(0)

  walletAddress    String?   @unique
  walletVerifiedAt DateTime?

  status    String    @default("active")
  deletedAt DateTime?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastActiveAt DateTime?
  lastLoginAt  DateTime?

  // Profiles
  learnerProfile LearnerProfile?
  parentProfile  ParentProfile?
  tutorProfile   TutorProfile?
  creatorProfile CreatorProfile?
  reliefTeacher  ReliefTeacher?

  // Relations
  bookingsAsBooker      Booking[]              @relation("BookedBy")
  sessionsAsTutor       TutoringSession[]      @relation("SessionTutor")
  createdContent        Content[]              @relation("ContentCreator")
  contentPurchases      ContentPurchase[]      @relation("ContentBuyer")
  contentReviews        ContentReview[]
  learningAssetRequests LearningAssetRequest[] @relation("Requester")
  learningAssetVotes    LearningAssetVote[]

  refreshTokens     RefreshToken[]
  credentialNFTs    CredentialNFT[]
  onChainReputation OnChainReputation?
  tokenTransactions TokenTransaction[]

  // Early Years & LinguaFlow
  earlyYearsFamilies      EarlyYearsFamily[]
  languageLearnerProfiles LanguageLearnerProfile[]

  // KYC/WWCC Verifications
  identityVerifications IdentityVerification[]
  wwccVerifications     WWCCVerification[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([email])
  @@index([walletAddress])
  @@index([deletedAt])
}

// ============================================================================
// PROFILE MODELS
// ============================================================================

model LearnerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateOfBirth  DateTime
  yearLevel    String
  parentIds    String[] @default([])
  specialNeeds String[] @default([])

  // Learning preferences (structured - fixed typo from original)
  preferredSessionLength Int?
  preferredTimeOfDay     String?
  preferredDays          Int[]    @default([])
  learningPace           String?
  attentionSpan          String? // FIXED: was "attention span" with space
  bestMotivators         String[] @default([])

  lisProfileSharing     Json    @default("{}")
  lisProfileId          String?
  lisIntegrationEnabled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subjects              LearnerSubject[]
  sessionParticipations SessionParticipant[]

  @@index([yearLevel])
}

model LearnerSubject {
  id        String         @id @default(cuid())
  profileId String
  profile   LearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject        @relation(fields: [subjectId], references: [id])

  currentLevel  String
  needsHelp     Boolean @default(false)
  canHelpOthers Boolean @default(false)

  @@unique([profileId, subjectId])
  @@index([subjectId])
}

model ParentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  childIds                String[] @default([])
  approvedTutorIds        String[] @default([])
  paymentMethodOnFile     Boolean  @default(false)
  monthlyBudget           Float?
  isHomeschoolParent      Boolean  @default(false)
  notificationPreferences Json     @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TutorProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tutorType           String    @default("professional")
  verificationStatus  String    @default("pending")
  verifiedAt          DateTime?
  profileCompleteness Float     @default(0)

  yearLevelsTeaching  String[] @default([])
  languages           String[] @default([])
  sessionTypes        String[] @default([])
  maxStudentsPerGroup Int      @default(1)

  teachingStyle Json      @default("{}")
  metrics       Json      @default("{}")
  deletedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Extracted from JSON
  availabilitySlots TutorAvailabilitySlot[]
  pricingTiers      TutorPricingTier[]

  qualifications     TutorQualification[]
  safeguardingChecks SafeguardingCheck[]
  subjects           TutorSubject[]
  bookings           Booking[]
  sessions           TutoringSession[]    @relation("SessionTutor")

  @@index([verificationStatus])
  @@index([tutorType])
  @@index([deletedAt])
}

/// Extracted from TutorProfile.availability JSON
model TutorAvailabilitySlot {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  dayOfWeek     Int // 0-6
  startTime     String // "09:00"
  endTime       String // "17:00"
  timezone      String    @default("Australia/Sydney")
  isRecurring   Boolean   @default(true)
  effectiveFrom DateTime?
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([profileId, dayOfWeek])
}

/// Extracted from TutorProfile.pricing JSON
model TutorPricingTier {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  sessionType   String
  duration      Int // minutes
  baseRate      Float
  currency      String  @default("AUD")
  groupDiscount Float   @default(0)
  maxGroupSize  Int     @default(1)
  introRate     Float?
  packageRate   Json?
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, sessionType, duration])
  @@index([profileId, isActive])
}

model TutorSubject {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject      @relation(fields: [subjectId], references: [id])

  yearLevels      String[] @default([])
  confidenceLevel Int      @default(3)
  specializations String[] @default([])
  examBoardsKnown String[] @default([])
  curriculumCodes String[] @default([])

  @@unique([profileId, subjectId])
  @@index([subjectId])
}

model TutorQualification {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type               String
  title              String
  institution        String?
  dateObtained       DateTime?
  verified           Boolean   @default(false)
  verificationMethod String?
  documentUrl        String?

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([type, verified])
}

model SafeguardingCheck {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type               String
  jurisdiction       String
  checkNumber        String
  verifiedAt         DateTime
  expiresAt          DateTime?
  status             String    @default("pending")
  verificationMethod String    @default("manual")
  documentUrl        String?

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([status, expiresAt])
  @@index([jurisdiction, type])
}

model CreatorProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  bio         String?
  avatarUrl   String?
  websiteUrl  String?

  totalContent   Int   @default(0)
  totalSales     Int   @default(0)
  totalDownloads Int   @default(0)
  averageRating  Float @default(0)
  totalReviews   Int   @default(0)
  totalEarnings  Float @default(0)

  level         String    @default("new")
  badges        String[]  @default([])
  featuredSince DateTime?

  subjects   String[] @default([])
  yearLevels String[] @default([])

  verificationStatus String    @default("pending")
  verifiedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([verificationStatus])
}

// ============================================================================
// BOOKING & SESSION MODELS
// ============================================================================

model Booking {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  tutorId        String
  tutor          TutorProfile @relation(fields: [tutorId], references: [id])
  bookedByUserId String
  bookedByUser   User         @relation("BookedBy", fields: [bookedByUserId], references: [id])

  learnerIds     String[] @default([])
  scheduledStart DateTime
  scheduledEnd   DateTime
  timezone       String   @default("Australia/Sydney")

  sessionType String
  subjectId   String
  subject     Subject @relation(fields: [subjectId], references: [id])

  topicsNeedingHelp String[] @default([])
  curriculumCodes   String[] @default([])
  learnerNotes      String?

  isGroupSession Boolean @default(false)
  openToOthers   Boolean @default(false)
  maxGroupSize   Int     @default(1)

  pricing Json

  status             String    @default("pending")
  cancellationReason String?
  cancelledBy        String?
  cancelledAt        DateTime?

  paymentStatus String  @default("pending")
  paymentId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session           TutoringSession?
  escrowTransaction EscrowTransaction?

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tutorId])
  @@index([tutorId, scheduledStart])
  @@index([scheduledStart])
  @@index([tenantId, status, scheduledStart])
}

model TutoringSession {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  tutorProfileId String
  tutorProfile   TutorProfile @relation("SessionTutor", fields: [tutorProfileId], references: [id])
  tutorUserId    String
  tutorUser      User         @relation("SessionTutor", fields: [tutorUserId], references: [id])

  scheduledStart DateTime
  scheduledEnd   DateTime
  actualStart    DateTime?
  actualEnd      DateTime?
  timezone       String

  sessionType    String
  isGroupSession Boolean @default(false)
  location       Json?
  videoRoomUrl   String?

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  topicsFocus     String[] @default([])
  curriculumCodes String[] @default([])

  status String @default("scheduled")

  preworkAssigned  String?
  sessionNotes     String?  @db.Text
  homeworkAssigned String?
  resourcesShared  String[] @default([])

  tutorFeedback    Json?
  learnerFeedback  Json?
  parentFeedback   Json?
  lisSessionReport Json?

  billingStatus      String @default("pending")
  amountCharged      Float  @default(0)
  tutorEarnings      Float  @default(0)
  platformCommission Float  @default(0)
  tokenRewards       Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants SessionParticipant[]

  @@index([tenantId])
  @@index([tutorProfileId])
  @@index([tutorProfileId, scheduledStart, status])
  @@index([scheduledStart])
  @@index([status])
}

model SessionParticipant {
  id               String          @id @default(cuid())
  sessionId        String
  session          TutoringSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  learnerProfileId String
  learnerProfile   LearnerProfile  @relation(fields: [learnerProfileId], references: [id])

  attended Boolean @default(false)
  feedback Json?

  @@unique([sessionId, learnerProfileId])
  @@index([learnerProfileId])
}

// ============================================================================
// CURRICULUM MODELS
// ============================================================================

model CurriculumStandard {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  framework  String
  code       String
  externalId String?
  uri        String?

  type         String
  learningArea String
  subject      String
  strand       String?
  substrand    String?

  yearLevels     String[] @default([])
  bandDescriptor String?

  title               String
  description         String   @db.Text
  elaborations        String[] @default([])
  contentDescriptions String[] @default([])

  bloomsLevel    String?
  cognitiveVerbs String[] @default([])
  skills         String[] @default([])
  concepts       String[] @default([])
  keywords       String[] @default([])

  prerequisites             String[] @default([])
  relatedStandards          String[] @default([])
  crossCurricularLinks      Json     @default("[]")
  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  embedding Float[] @default([])

  source        String
  version       String
  effectiveFrom DateTime?
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alignments  ContentAlignment[]
  lessonPlans LessonPlanStandard[]

  @@unique([tenantId, framework, code])
  @@index([tenantId])
  @@index([framework])
  @@index([learningArea])
  @@index([subject])
  @@index([yearLevels])
}

model LessonPlan {
  id       String @id @default(cuid())
  tenantId String

  title       String
  description String @db.Text
  yearLevel   String
  subject     String
  duration    Int

  learningIntentions        String[] @default([])
  successCriteria           String[] @default([])
  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  sections                   Json
  differentiation            Json
  resources                  Json @default("[]")
  assessmentOpportunities    Json @default("[]")
  crossCurricularConnections Json @default("[]")

  generatedBy      String  @default("ai")
  generationPrompt String?
  qualityScore     Float?

  status    String @default("draft")
  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  standards LessonPlanStandard[]

  @@index([tenantId])
  @@index([subject])
  @@index([yearLevel])
  @@index([status])
}

model LessonPlanStandard {
  id           String             @id @default(cuid())
  lessonPlanId String
  lessonPlan   LessonPlan         @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  standardId   String
  standard     CurriculumStandard @relation(fields: [standardId], references: [id])

  @@unique([lessonPlanId, standardId])
}

// ============================================================================
// CONTENT MARKETPLACE MODELS
// ============================================================================

model Content {
  id        String @id @default(cuid())
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creatorId String
  creator   User   @relation("ContentCreator", fields: [creatorId], references: [id])

  title       String
  description String @db.Text
  type        String

  thumbnailUrl String?
  previewUrl   String?

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  subjects             String[] @default([])
  yearLevels           String[] @default([])
  curriculumFrameworks String[] @default([])
  curriculumCodes      String[] @default([])
  generalCapabilities  String[] @default([])

  format    String
  fileSize  Int?
  pageCount Int?
  duration  Int?

  pricing Json
  license Json

  qualityScore  Float @default(0)
  reviewCount   Int   @default(0)
  averageRating Float @default(0)
  downloadCount Int   @default(0)
  purchaseCount Int   @default(0)

  tags           String[] @default([])
  keywords       String[] @default([])
  searchableText String   @db.Text
  embedding      Float[]  @default([])

  status      String    @default("draft")
  publishedAt DateTime?
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alignments ContentAlignment[]
  reviews    ContentReview[]
  purchases  ContentPurchase[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, status, subjects])
  @@index([tenantId, status, yearLevels])
  @@index([creatorId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
}

model ContentAlignment {
  id         String             @id @default(cuid())
  contentId  String
  content    Content            @relation(fields: [contentId], references: [id], onDelete: Cascade)
  standardId String
  standard   CurriculumStandard @relation(fields: [standardId], references: [id])

  alignmentScore  Float
  alignmentMethod String
  conceptsMatched String[] @default([])
  skillsMatched   String[] @default([])
  confidence      Float

  verifiedBy String?
  verifiedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([contentId, standardId])
}

model ContentReview {
  id         String  @id @default(cuid())
  contentId  String
  content    Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User    @relation(fields: [reviewerId], references: [id])

  rating  Int
  title   String?
  comment String? @db.Text

  // NEW: Structured feedback aligned with service
  topicsWellCovered  String[] @default([])
  topicsNeedMoreWork String[] @default([])
  wouldRecommend     Boolean  @default(true)

  helpfulCount    Int     @default(0)
  notHelpfulCount Int     @default(0)
  verified        Boolean @default(false)
  yearLevelUsed   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contentId, reviewerId]) // ADDED: Prevent duplicate reviews
  @@index([contentId])
  @@index([reviewerId])
  @@index([rating])
}

model ContentPurchase {
  id        String  @id @default(cuid())
  tenantId  String
  contentId String
  content   Content @relation(fields: [contentId], references: [id])
  buyerId   String
  buyer     User    @relation("ContentBuyer", fields: [buyerId], references: [id])

  price           Float
  currency        String
  tokenAmount     Float  @default(0)
  platformFee     Float
  creatorEarnings Float
  tokenRewards    Float  @default(0)

  downloadCount Int @default(0)
  maxDownloads  Int @default(5)

  status String @default("completed")

  purchasedAt      DateTime  @default(now())
  lastDownloadedAt DateTime?

  @@unique([contentId, buyerId]) // ADDED: One purchase per user
  @@index([tenantId])
  @@index([buyerId])
  @@index([contentId])
}

model LearningAssetRequest {
  id          String @id @default(cuid())
  tenantId    String
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  title           String
  description     String    @db.Text
  type            String
  subjects        String[]  @default([])
  yearLevels      String[]  @default([])
  curriculumCodes String[]  @default([])
  specifications  String[]  @default([])
  preferredFormat String?
  budgetMin       Float?
  budgetMax       Float?
  deadline        DateTime?

  voteCount Int @default(0)

  status                String    @default("open")
  fulfilledByContentIds String[]  @default([])
  fulfilledAt           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes LearningAssetVote[]

  @@unique([tenantId, requesterId, title]) // ADDED: Prevent duplicates
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([status])
}

/// NEW: Extracted from LearningAssetRequest.votes JSON
model LearningAssetVote {
  id        String               @id @default(cuid())
  requestId String
  request   LearningAssetRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  userId    String
  user      User                 @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([requestId, userId])
  @@index([requestId])
  @@index([userId])
}

// ============================================================================
// HOMESCHOOL MODELS
// ============================================================================

model HomeschoolFamily {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  primaryContactUserId String
  primaryContactName   String
  primaryContactEmail  String
  primaryContactPhone  String?

  additionalContacts Json @default("[]")

  educationalPhilosophy String?
  curriculumApproach    String?
  teachingCapabilities  Json    @default("[]")

  coopPreferences Json @default("{}")
  compliance      Json @default("{}")
  aiProfile       Json @default("{}")

  status       String    @default("active")
  joinedAt     DateTime  @default(now())
  lastActiveAt DateTime  @default(now())
  deletedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location               Address?
  children               HomeschoolChild[]
  coopMemberships        CoopMember[]
  excursionRegistrations ExcursionRegistration[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model HomeschoolChild {
  id       String           @id @default(cuid())
  familyId String
  family   HomeschoolFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)

  name             String
  dateOfBirth      DateTime
  currentYearLevel String

  learningStyle  String?
  interests      String[] @default([])
  strengths      String[] @default([])
  challengeAreas String[] @default([])
  specialNeeds   String[] @default([])

  curriculumFramework String @default("ACARA")
  subjectProgress     Json   @default("[]")

  lisProfileId          String?
  lisIntegrationEnabled Boolean @default(false)

  friendConnections String[] @default([])
  coopParticipation String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([familyId])
  @@index([currentYearLevel])
}

model HomeschoolCoop {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String @db.Text
  philosophy  String

  meetingLocations Json @default("[]")

  maxFamilies   Int    @default(10)
  membershipFee Float?

  meetingSchedule       Json
  subjects              String[] @default([])
  ageRange              Json
  educationalApproaches String[] @default([])

  structure Json
  roles     Json @default("[]")

  status    String    @default("forming")
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  primaryLocation Address?     @relation("CoopPrimaryLocation")
  members         CoopMember[]
  excursions      Excursion[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model CoopMember {
  id       String           @id @default(cuid())
  coopId   String
  coop     HomeschoolCoop   @relation(fields: [coopId], references: [id], onDelete: Cascade)
  familyId String
  family   HomeschoolFamily @relation(fields: [familyId], references: [id])

  role             String   @default("member")
  teachingSubjects String[] @default([])
  joinedAt         DateTime @default(now())
  status           String   @default("active")

  @@unique([coopId, familyId])
  @@index([familyId])
}

model Excursion {
  id          String          @id @default(cuid())
  tenantId    String
  organizerId String
  coopId      String?
  coop        HomeschoolCoop? @relation(fields: [coopId], references: [id])

  title                 String
  description           String   @db.Text
  venue                 Json
  curriculumConnections Json     @default("[]")
  learningObjectives    String[] @default([])

  date           DateTime
  startTime      String
  endTime        String
  meetingPoint   String
  transportation String

  minParticipants Int
  maxParticipants Int
  costPerChild    Float     @default(0)
  costPerAdult    Float     @default(0)
  paymentDeadline DateTime?

  waitlist String[] @default([])

  preActivities  String[] @default([])
  postActivities String[] @default([])

  status String @default("planning")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registrations ExcursionRegistration[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([date])
  @@index([coopId])
}

model ExcursionRegistration {
  id          String           @id @default(cuid())
  excursionId String
  excursion   Excursion        @relation(fields: [excursionId], references: [id], onDelete: Cascade)
  familyId    String
  family      HomeschoolFamily @relation(fields: [familyId], references: [id])

  childrenIds         String[] @default([])
  adultsAttending     Int      @default(1)
  dietaryRequirements String?
  medicalNotes        String?
  emergencyContact    String

  paymentStatus String   @default("pending")
  registeredAt  DateTime @default(now())

  @@unique([excursionId, familyId])
  @@index([familyId])
}

// ============================================================================
// MICRO-SCHOOL MODELS
// ============================================================================

model MicroSchool {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name             String
  description      String @db.Text
  philosophy       String
  educationalModel String

  facilities  Json  @default("[]")
  legalEntity Json?
  compliance  Json

  founderId          String
  enrollmentCapacity Int    @default(20)

  curriculumFramework String   @default("ACARA")
  subjects            String[] @default([])
  yearLevelsOffered   String[] @default([])

  schedule    Json
  termDates   Json @default("[]")
  tuitionFees Json

  healthAnalysis Json?

  status      String    @default("forming")
  foundedDate DateTime?
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location     Address?
  staff        MicroSchoolStaff[]
  students     MicroSchoolStudent[]
  applications EnrollmentApplication[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model MicroSchoolStaff {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userId   String

  name           String
  email          String
  phone          String?
  role           String
  employmentType String

  qualifications        Json     @default("[]")
  teachingSubjects      String[] @default([])
  yearLevelCapabilities String[] @default([])

  safeguardingCheck     Json?
  firstAidCertification Json?
  teachingRegistration  Json?

  status    String    @default("active")
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, userId])
  @@index([schoolId])
  @@index([schoolId, status])
}

model MicroSchoolStudent {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  familyId String

  name        String
  dateOfBirth DateTime
  yearLevel   String

  enrollmentStatus String    @default("enrolled")
  enrollmentDate   DateTime?
  withdrawalDate   DateTime?

  learningProfile    Json?
  medicalInformation Json?
  emergencyContacts  Json  @default("[]")

  lisProfileId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, familyId, name])
  @@index([schoolId])
  @@index([schoolId, enrollmentStatus])
}

model EnrollmentApplication {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  familyId String

  studentName        String
  studentDob         DateTime
  requestedYearLevel String
  requestedStartDate DateTime

  reasonForEnrolling String  @db.Text
  previousSchooling  String  @db.Text
  learningNeeds      String?
  additionalInfo     String?

  parentConsent    Boolean   @default(false)
  consentTimestamp DateTime?
  documents        Json      @default("[]")

  status      String    @default("submitted")
  reviewNotes String?   @db.Text
  reviewedBy  String?
  reviewedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, familyId, studentName])
  @@index([schoolId])
  @@index([schoolId, status])
}

// ============================================================================
// RELIEF MARKETPLACE MODELS
// ============================================================================

model ReliefTeacher {
  id       String @id @default(cuid())
  tenantId String
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  email       String
  phone       String?
  avatarUrl   String?

  location             Json
  qualifications       Json @default("[]")
  teachingRegistration Json
  safeguardingCheck    Json

  subjects        String[] @default([])
  yearLevels      String[] @default([])
  specializations String[] @default([])

  availability     Json
  preferredSchools String[] @default([])
  excludedSchools  String[] @default([])

  metrics   Json   @default("{}")
  tier      String @default("standard")
  aiProfile Json   @default("{}")

  status     String    @default("pending_verification")
  verifiedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poolMemberships ReliefPoolMember[]
  assignments     ReliefAssignment[]
  bookings        ReliefBooking[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tier])
  @@index([deletedAt])
}

model ReliefPool {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolId String

  name              String
  config            Json
  autonomousActions Json   @default("{}")
  statistics        Json   @default("{}")

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members ReliefPoolMember[]

  @@unique([tenantId, schoolId])
  @@index([tenantId])
}

model ReliefPoolMember {
  id              String        @id @default(cuid())
  poolId          String
  pool            ReliefPool    @relation(fields: [poolId], references: [id], onDelete: Cascade)
  reliefTeacherId String
  reliefTeacher   ReliefTeacher @relation(fields: [reliefTeacherId], references: [id])

  tier         String    @default("standard")
  priority     Int       @default(1)
  schoolRating Float?
  lastBookedAt DateTime?
  joinedAt     DateTime  @default(now())

  @@unique([poolId, reliefTeacherId])
  @@index([reliefTeacherId])
}

model TeacherAbsence {
  id          String @id @default(cuid())
  tenantId    String
  schoolId    String
  teacherId   String
  teacherName String

  date      DateTime
  startTime String
  endTime   String
  isFullDay Boolean  @default(true)
  reason    String
  notes     String?

  coverageRequired Json   @default("[]")
  status           String @default("reported")

  wasPredicted         Boolean @default(false)
  predictionConfidence Float?

  reportedAt DateTime @default(now())
  reportedBy String
  updatedAt  DateTime @updatedAt

  assignments   ReliefAssignment[]
  notifications AbsenceNotification[]

  @@index([tenantId])
  @@index([tenantId, schoolId])
  @@index([schoolId])
  @@index([date])
  @@index([tenantId, date, status])
}

model ReliefAssignment {
  id              String         @id @default(cuid())
  absenceId       String
  absence         TeacherAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  reliefTeacherId String
  reliefTeacher   ReliefTeacher  @relation(fields: [reliefTeacherId], references: [id])

  coverageRequirementIds String[] @default([])

  status      String    @default("offered")
  offeredAt   DateTime  @default(now())
  respondedAt DateTime?
  confirmedAt DateTime?
  completedAt DateTime?

  rating   Int?
  feedback String?

  @@index([absenceId])
  @@index([reliefTeacherId])
  @@index([status])
}

model ReliefBooking {
  id              String        @id @default(cuid())
  tenantId        String
  schoolId        String
  absenceId       String
  reliefTeacherId String
  reliefTeacher   ReliefTeacher @relation(fields: [reliefTeacherId], references: [id])

  date       DateTime
  periods    Json
  totalHours Float

  hourlyRate    Float
  totalAmount   Float
  paymentStatus String @default("pending")

  status String @default("confirmed")

  schoolRating    Int?
  schoolFeedback  String?
  teacherRating   Int?
  teacherFeedback String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([date])
  @@index([reliefTeacherId])
}

model AbsenceNotification {
  id        String         @id @default(cuid())
  absenceId String
  absence   TeacherAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)

  recipientId   String
  recipientType String
  channel       String
  type          String

  status      String    @default("sent")
  sentAt      DateTime  @default(now())
  deliveredAt DateTime?
  readAt      DateTime?

  @@index([absenceId])
  @@index([recipientId])
}

model AbsencePrediction {
  id       String   @id @default(cuid())
  tenantId String
  schoolId String
  date     DateTime

  predictedAbsences Json
  totalPredicted    Int
  confidence        Float
  factors           Json  @default("[]")
  recommendations   Json  @default("[]")

  generatedAt DateTime @default(now())

  @@unique([tenantId, schoolId, date])
  @@index([date])
}

// ============================================================================
// AUTHENTICATION MODELS
// ============================================================================

model RefreshToken {
  id          String @id @default(cuid())
  tokenFamily String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  hashedToken String    @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  replacedBy  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenFamily])
  @@index([hashedToken])
  @@index([expiresAt])
}

// ============================================================================
// BLOCKCHAIN MODELS
// ============================================================================

model CredentialNFT {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenId         BigInt @unique
  contractAddress String
  credentialType  String

  metadata Json
  dataHash String

  issuedAt         DateTime  @default(now())
  expiresAt        DateTime?
  revokedAt        DateTime?
  revocationReason String?

  mintTxHash   String
  revokeTxHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([credentialType])
  @@index([tokenId])
  @@index([contractAddress])
}

model EscrowTransaction {
  id       String @id @default(cuid())
  tenantId String

  escrowId  String  @unique
  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  learnerId     String
  tutorId       String
  learnerWallet String
  tutorWallet   String

  amount         Decimal @db.Decimal(36, 18)
  platformFeeBps Int     @default(500)
  platformFee    Decimal @db.Decimal(36, 18)
  tutorAmount    Decimal @db.Decimal(36, 18)

  status String @default("created")

  createTxHash  String?
  fundTxHash    String?
  releaseTxHash String?
  refundTxHash  String?

  disputeReason     String?
  disputeRaisedAt   DateTime?
  disputeResolvedAt DateTime?
  disputeResolution Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([learnerId])
  @@index([tutorId])
  @@index([status])
}

model OnChainReputation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  walletAddress String @unique

  onChainScore      Int @default(0)
  totalSessions     Int @default(0)
  completedSessions Int @default(0)
  totalRatings      Int @default(0)
  ratingSum         Int @default(0)
  disputesWon       Int @default(0)
  disputesLost      Int @default(0)

  completionRate Float   @default(0)
  averageRating  Decimal @default(0) @db.Decimal(3, 2)

  lastSyncedAt   DateTime @default(now())
  lastSyncTxHash String?
  syncErrorCount Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletAddress])
  @@index([onChainScore])
}

model TokenTransaction {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  type        String
  amount      Decimal @db.Decimal(36, 18)
  fromAddress String?
  toAddress   String

  referenceType String?
  referenceId   String?

  txHash      String  @unique
  blockNumber Int?
  gasUsed     String?

  status String @default("pending")

  createdAt   DateTime  @default(now())
  confirmedAt DateTime?

  @@index([userId])
  @@index([txHash])
  @@index([type])
  @@index([status])
  @@index([tenantId, type, createdAt])
}

// ============================================================================
// Continue in Part 2...
// ============================================================================

// ============================================================================
// AI BUDDY MODELS
// ============================================================================

model AIBuddyConversation {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  role     String
  title    String
  messages Json
  context  Json

  status String @default("active")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
  @@index([status])
  @@index([lastMessageAt])
}

model AIBuddySettings {
  id       String @id @default(cuid())
  userId   String
  tenantId String

  responseStyle       String  @default("encouraging")
  verbosityLevel      String  @default("concise")
  useEmojis           Boolean @default(true)
  includeExamples     Boolean @default(true)
  provideChallenges   Boolean @default(true)
  reminderFrequency   String  @default("none")
  parentNotifications Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
}

// ============================================================================
// DIGITAL PORTFOLIO MODELS
// ============================================================================

model Portfolio {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  displayName   String
  bio           String?
  avatarUrl     String?
  coverImageUrl String?

  visibility String @default("private")
  theme      Json
  sections   Json
  stats      Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  artifacts    Artifact[]
  goals        LearningGoal[]
  achievements Achievement[]
  journeys     LearningJourney[]

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([visibility])
}

model Artifact {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String? @db.Text
  type        String

  content             Json
  metadata            Json
  reflection          Json?
  curriculumAlignment Json?
  feedback            Json  @default("[]")

  tags       String[] @default([])
  status     String   @default("draft")
  visibility String   @default("private")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([status])
}

model LearningGoal {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String    @db.Text
  category    String
  subject     String?
  targetDate  DateTime?

  status   String @default("not_started")
  progress Int    @default(0)

  milestones       Json     @default("[]")
  relatedArtifacts String[] @default([])
  curriculumCodes  String[] @default([])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model Achievement {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  type        String
  title       String
  description String
  imageUrl    String

  earnedAt DateTime
  issuedBy String
  criteria String
  evidence String[] @default([])

  blockchain Json?

  createdAt DateTime @default(now())

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([type])
}

model LearningJourney {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String  @db.Text
  subject     String?

  startDate DateTime
  endDate   DateTime?
  status    String    @default("active")

  path              Json
  currentNode       String
  aiRecommendations Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// ============================================================================
// EDUSCRUM / AGILE LEARNING MODELS (NEW)
// ============================================================================

model EduScrumTeam {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?

  scrumMasterId  String
  productOwnerId String?
  memberIds      String[] @default([])

  velocity      Float  @default(0)
  maturityLevel String @default("forming")
  healthScore   Float  @default(0)

  sprintDuration  Int   @default(14)
  standupSchedule Json?

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sprints        EduScrumSprint[]
  retrospectives EduScrumRetrospective[]

  @@index([tenantId])
  @@index([tenantId, status])
}

model EduScrumSprint {
  id       String       @id @default(cuid())
  tenantId String
  teamId   String
  team     EduScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  name         String
  goal         String @db.Text
  sprintNumber Int

  startDate DateTime
  endDate   DateTime

  backlogItems     Json @default("[]")
  totalStoryPoints Int  @default(0)
  completedPoints  Int  @default(0)

  standups     Json  @default("[]")
  burndownData Json  @default("[]")
  aiInsights   Json?

  status String @default("planning")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, sprintNumber])
  @@index([tenantId])
  @@index([teamId])
  @@index([status])
}

model EduScrumRetrospective {
  id       String       @id @default(cuid())
  tenantId String
  teamId   String
  team     EduScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sprintId String?

  wentWell    Json @default("[]")
  toImprove   Json @default("[]")
  actionItems Json @default("[]")

  participantIds String[] @default([])
  facilitatorId  String

  aiSummary         String? @db.Text
  aiRecommendations Json    @default("[]")
  teamDynamicsScore Float?

  conductedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([teamId])
  @@index([sprintId])
}

// ============================================================================
// COMPLIANCE MODELS
// ============================================================================

model ComplianceCheck {
  id       String @id @default(cuid())
  tenantId String

  entityType String
  entityId   String
  framework  String
  ruleId     String

  status   String
  details  String @db.Text
  evidence Json?

  checkedAt           DateTime  @default(now())
  checkedBy           String
  remediationRequired Boolean   @default(false)
  remediationDeadline DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([entityType, entityId])
  @@index([framework])
  @@index([status])
}

model ComplianceReport {
  id       String @id @default(cuid())
  tenantId String

  reportType String
  period     Json
  frameworks String[] @default([])

  summary         Json
  checkIds        String[] @default([])
  recommendations Json     @default("[]")
  certifications  Json     @default("[]")

  generatedAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, generatedAt])
}

model ACARACurriculumCode {
  id           String  @id @default(cuid())
  code         String  @unique
  learningArea String
  subject      String
  yearLevel    String
  strand       String
  subStrand    String?

  description         String   @db.Text
  elaborations        String[] @default([])
  achievementStandard String   @db.Text

  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  source        String    @default("ACARA")
  version       String
  effectiveFrom DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([learningArea])
  @@index([subject])
  @@index([yearLevel])
  @@index([strand])
}

// ============================================================================
// NOTIFICATION MODELS (NEW)
// ============================================================================

model Notification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  type  String
  title String
  body  String @db.Text
  data  Json?

  channels String[] @default(["in_app"])
  priority String   @default("normal")

  inAppStatus String  @default("unread")
  emailStatus String?
  smsStatus   String?
  pushStatus  String?

  scheduledFor DateTime?
  sentAt       DateTime?
  readAt       DateTime?

  groupKey String?

  createdAt DateTime @default(now())

  @@index([tenantId, userId])
  @@index([userId, inAppStatus])
  @@index([userId, createdAt])
  @@index([type])
  @@index([scheduledFor])
}

model NotificationPreference {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  categoryPreferences Json @default("{}")

  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  timezone          String  @default("Australia/Sydney")

  digestEnabled   Boolean @default(false)
  digestFrequency String?
  digestTime      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, userId])
  @@index([userId])
}

// ============================================================================
// ANALYTICS MODELS (NEW)
// ============================================================================

model AnalyticsEvent {
  id       String @id @default(cuid())
  tenantId String

  eventType String
  eventName String

  userId    String?
  sessionId String?

  entityType String?
  entityId   String?

  properties Json @default("{}")

  deviceType String?
  browser    String?
  os         String?

  country String?
  region  String?

  timestamp DateTime @default(now())

  @@index([tenantId, timestamp])
  @@index([tenantId, eventType, timestamp])
  @@index([tenantId, userId, timestamp])
  @@index([entityType, entityId])
}

model ReportDefinition {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?

  reportType String
  parameters Json
  filters    Json   @default("{}")
  columns    Json

  isScheduled Boolean  @default(false)
  schedule    Json?
  recipients  String[] @default([])

  createdBy  String
  isPublic   Boolean  @default(false)
  sharedWith String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  executions ReportExecution[]

  @@index([tenantId])
  @@index([tenantId, reportType])
  @@index([createdBy])
}

model ReportExecution {
  id       String           @id @default(cuid())
  tenantId String
  reportId String
  report   ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)

  parameters Json
  filters    Json

  status        String  @default("pending")
  resultSummary Json?
  resultFileUrl String?
  rowCount      Int?

  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?

  errorMessage String?

  executedBy String?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([reportId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// FEATURE FLAGS & CONFIGURATION (NEW)
// ============================================================================

model FeatureFlag {
  id String @id @default(cuid())

  key         String  @unique
  name        String
  description String?

  isEnabled         Boolean @default(false)
  rules             Json    @default("[]")
  rolloutPercentage Int     @default(0)

  category String?
  owner    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isEnabled])
  @@index([category])
}

model TenantConfiguration {
  id       String @id @default(cuid())
  tenantId String @unique

  branding         Json     @default("{}")
  enabledFeatures  String[] @default([])
  disabledFeatures String[] @default([])
  limits           Json     @default("{}")
  integrations     Json     @default("{}")

  dataRetentionDays Int     @default(2555)
  gdprEnabled       Boolean @default(true)

  billingPlan  String @default("free")
  billingCycle String @default("monthly")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([billingPlan])
}

// ============================================================================
// DATA MIGRATION TRACKING
// ============================================================================

model DataMigration {
  id String @id @default(cuid())

  name        String  @unique
  description String?

  status      String    @default("pending")
  startedAt   DateTime?
  completedAt DateTime?

  totalRecords     Int?
  processedRecords Int  @default(0)
  failedRecords    Int  @default(0)

  resultSummary Json?
  errorLog      Json  @default("[]")

  isReversible Boolean @default(false)
  rollbackData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// DESIGN & PITCH AI MODELS
// ============================================================================

model DesignChallenge {
  id       String @id @default(cuid())
  tenantId String

  title             String
  description       String @db.Text
  context           String @db.Text
  complexity        String @default("intermediate")
  estimatedDuration String

  subject                   String?
  yearLevels                String[] @default([])
  curriculumCodes           String[] @default([])
  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  constraints   Json  @default("[]")
  resourceLinks Json  @default("[]")
  exemplars     Json  @default("[]")
  rubric        Json?

  status      String    @default("draft")
  publishedAt DateTime?
  createdBy   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  journeys DesignJourney[]

  @@index([tenantId])
  @@index([status])
  @@index([complexity])
  @@index([subject])
}

model DesignJourney {
  id          String          @id @default(cuid())
  tenantId    String
  challengeId String
  challenge   DesignChallenge @relation(fields: [challengeId], references: [id])
  userId      String

  currentPhase String @default("empathize")
  status       String @default("in_progress")

  problemStatement  String? @db.Text
  hmwStatement      String?
  problemValidation Json?

  empathizeData Json @default("{}")
  defineData    Json @default("{}")
  ideateData    Json @default("{}")
  prototypeData Json @default("{}")
  iterateData   Json @default("{}")
  pitchData     Json @default("{}")

  phaseProgress   Json @default("{}")
  overallProgress Int  @default(0)
  aiInteractions  Int  @default(0)

  completedAt DateTime?
  finalScore  Float?
  feedback    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  artifacts   DesignArtifact[]
  peerReviews DesignPeerReview[]
  pitchDeck   DesignPitchDeck?
  showcase    ShowcasePortfolio?

  @@index([tenantId])
  @@index([userId])
  @@index([challengeId])
  @@index([status])
  @@index([currentPhase])
}

model DesignArtifact {
  id        String        @id @default(cuid())
  tenantId  String
  journeyId String
  journey   DesignJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  userId    String

  type        String
  title       String
  description String? @db.Text
  phase       String

  content      Json
  fileUrl      String?
  thumbnailUrl String?

  version          Int     @default(1)
  parentArtifactId String?

  aiAnalysis   Json?
  skillsTagged String[] @default([])
  qualityScore Float?

  status     String @default("draft")
  visibility String @default("private")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([journeyId])
  @@index([userId])
  @@index([type])
  @@index([phase])
}

model DesignPeerReview {
  id        String        @id @default(cuid())
  tenantId  String
  journeyId String
  journey   DesignJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  reviewerId   String
  artifactIds  String[] @default([])
  isAnonymous  Boolean  @default(true)
  feedback     String   @db.Text
  feedbackPins Json     @default("[]")
  rubricScores Json?
  overallScore Float?

  status      String    @default("pending")
  assignedAt  DateTime  @default(now())
  dueAt       DateTime?
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([journeyId, reviewerId])
  @@index([tenantId])
  @@index([journeyId])
  @@index([reviewerId])
  @@index([status])
}

model DesignPitchDeck {
  id        String        @id @default(cuid())
  tenantId  String
  journeyId String        @unique
  journey   DesignJourney @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  userId    String

  title             String
  slides            Json
  slideCount        Int    @default(0)
  estimatedDuration Int    @default(0)
  minFontSize       Int    @default(30)

  aiCoachingNotes Json      @default("[]")
  lastCoachingAt  DateTime?
  readinessScore  Float?

  practiceRuns     Json      @default("[]")
  presentationDate DateTime?
  presentedTo      String[]  @default([])

  finalScore        Float?
  evaluatorFeedback Json?
  status            String @default("draft")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// ============================================================================
// SHOWCASE PORTFOLIO MODELS
// ============================================================================

model ShowcasePortfolio {
  id        String        @id @default(cuid())
  tenantId  String
  userId    String
  journeyId String        @unique
  journey   DesignJourney @relation(fields: [journeyId], references: [id])

  title         String
  headline      String
  bio           String? @db.Text
  avatarUrl     String?
  coverImageUrl String?

  customSlug String? @unique
  vanityUrl  String?

  visibility String @default("private")
  theme      Json   @default("{}")
  layout     String @default("standard")

  executiveSummary String? @db.Text
  growthNarrative  String? @db.Text
  skillTags        Json    @default("[]")

  totalViews        Int   @default(0)
  uniqueViews       Int   @default(0)
  averageTimeOnPage Float @default(0)

  status      String    @default("draft")
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     ShowcaseItem[]
  guestbook ShowcaseGuestbook[]
  viewLogs  ShowcaseViewLog[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([customSlug])
}

model ShowcaseItem {
  id          String            @id @default(cuid())
  portfolioId String
  portfolio   ShowcasePortfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  artifactId  String?
  title       String
  description String? @db.Text
  type        String

  curatedContent    Json
  mediaUrl          String?
  thumbnailUrl      String?
  curatorNotes      String?  @db.Text
  skillsHighlighted String[] @default([])
  orderIndex        Int      @default(0)
  isVisible         Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portfolioId])
  @@index([artifactId])
}

model ShowcaseGuestbook {
  id          String            @id @default(cuid())
  portfolioId String
  portfolio   ShowcasePortfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  authorName    String
  authorEmail   String?
  authorCompany String?
  authorRole    String?

  message String @db.Text
  rating  Int?

  isApproved Boolean @default(false)
  isSpam     Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([portfolioId])
  @@index([isApproved])
}

model ShowcaseViewLog {
  id          String            @id @default(cuid())
  portfolioId String
  portfolio   ShowcasePortfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  sessionId String
  referrer  String?
  userAgent String?
  country   String?
  city      String?

  duration     Int      @default(0)
  itemsViewed  String[] @default([])
  interactions Json     @default("[]")

  viewedAt DateTime @default(now())

  @@index([portfolioId])
  @@index([viewedAt])
}

// ============================================================================
// EARLY YEARS (LITTLE EXPLORERS) MODULE
// Ages 3-7 education with Systematic Synthetic Phonics (SSP) and CPA numeracy
// ============================================================================

/// Family unit enrolled in Little Explorers
model EarlyYearsFamily {
  id       String @id @default(cuid())
  tenantId String

  // Primary account holder
  primaryUserId String
  primaryUser   User   @relation(fields: [primaryUserId], references: [id], onDelete: Cascade)

  // Identity
  familyName String?

  // Language & Culture
  primaryLanguage String   @default("en")
  homeLanguages   String[] @default([])
  timezone        String   @default("Australia/Sydney")

  // Subscription
  subscriptionTier      String    @default("free")
  subscriptionStatus    String    @default("active")
  subscriptionExpiresAt DateTime?

  // Engagement Metrics
  totalLearningMinutes Int       @default(0)
  lastActiveAt         DateTime?

  // Compliance (COPPA/GDPR-K)
  dataProcessingConsent   Boolean   @default(false)
  dataProcessingConsentAt DateTime?
  consentIpAddress        String?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  children EarlyYearsChild[]

  @@unique([tenantId, primaryUserId])
  @@index([tenantId])
  @@index([subscriptionStatus])
}

/// Child profile (ages 3-7)
model EarlyYearsChild {
  id       String           @id @default(cuid())
  tenantId String
  familyId String
  family   EarlyYearsFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)

  // Identity (minimal for child privacy)
  firstName     String
  preferredName String?
  dateOfBirth   DateTime
  avatarId      String?

  // Current State
  currentWorld  String @default("sound_discovery")
  currentMentor String @default("mimo_owl")

  // Engagement
  totalTreasures       Int       @default(0)
  totalStars           Int       @default(0)
  totalLearningMinutes Int       @default(0)
  totalSessions        Int       @default(0)
  currentStreak        Int       @default(0)
  longestStreak        Int       @default(0)
  lastActiveAt         DateTime?

  // Status
  status     String   @default("active")
  enrolledAt DateTime @default(now())

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  picturePassword  EarlyYearsPicturePassword?
  phonicsProgress  EarlyYearsPhonicsProgress?
  numeracyProgress EarlyYearsNumeracyProgress?
  sessions         EarlyYearsSession[]

  @@index([tenantId, familyId])
  @@index([dateOfBirth])
  @@index([status])
}

/// Picture password for pre-literate authentication
model EarlyYearsPicturePassword {
  id      String          @id @default(cuid())
  childId String          @unique
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)

  // Security (bcrypt hash of image sequence)
  imageSequenceHash String
  sequenceLength    Int

  // Brute force protection
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  lastAttemptAt  DateTime?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Phonics progress (Systematic Synthetic Phonics - 6 phases)
model EarlyYearsPhonicsProgress {
  id      String          @id @default(cuid())
  childId String          @unique
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)

  // Phase tracking (1-6)
  currentPhase Int @default(1)

  // Grapheme mastery
  masteredGraphemes   String[] @default([])
  introducedGraphemes String[] @default([])
  strugglingGraphemes String[] @default([])

  // Skill metrics (0.0 - 1.0)
  blendingAccuracy   Float @default(0)
  segmentingAccuracy Float @default(0)

  // Sight words
  sightWordsMastered   String[] @default([])
  sightWordsIntroduced String[] @default([])

  // Detailed progress (JSON for flexibility)
  graphemeHistory Json @default("[]")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Numeracy progress (Concrete-Pictorial-Abstract approach)
model EarlyYearsNumeracyProgress {
  id      String          @id @default(cuid())
  childId String          @unique
  child   EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)

  // Level tracking
  currentLevel String @default("foundations")

  // Number sense
  reliableCountingRange   Int @default(5)
  highestNumberRecognised Int @default(10)

  // Skill metrics (0.0 - 1.0)
  subitizingAccuracy  Float @default(0)
  additionAccuracy    Float @default(0)
  subtractionAccuracy Float @default(0)

  // Recognition
  numeralsRecognized    Int[]    @default([])
  operationsIntroduced  String[] @default([])
  shapesKnown           String[] @default([])

  // Detailed progress
  operationHistory Json @default("[]")

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Learning session
model EarlyYearsSession {
  id       String          @id @default(cuid())
  tenantId String
  childId  String
  child    EarlyYearsChild @relation(fields: [childId], references: [id], onDelete: Cascade)
  familyId String

  // Session info
  sessionType String @default("learning")
  world       String
  mentor      String

  // Limits
  maxDurationMinutes Int @default(15)
  maxActivities      Int @default(10)

  // Timing
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMinutes Int       @default(0)

  // Activity tracking
  totalActivities     Int @default(0)
  activitiesCompleted Int @default(0)

  // Skills practiced
  graphemesPracticed String[] @default([])
  numbersPracticed   Int[]    @default([])

  // Rewards
  treasuresEarned Int @default(0)
  starsEarned     Int @default(0)

  // Engagement
  averageFocusScore Float?
  childMoodRating   Int?
  parentNotes       String?

  // Audit
  createdAt DateTime @default(now())

  // Relations
  activities EarlyYearsActivity[]

  @@index([tenantId, childId])
  @@index([startedAt])
  @@index([childId, startedAt])
}

/// Individual activity within a session
model EarlyYearsActivity {
  id        String            @id @default(cuid())
  sessionId String
  session   EarlyYearsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Activity details
  activityType  String
  targetContent String[] @default([])
  difficulty    Int      @default(1)

  // Timing
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  durationSeconds Int?

  // Results
  score           Float?
  attempts        Int     @default(1)
  hintsUsed       Int     @default(0)
  errorsCommitted Int     @default(0)

  // Response data (for analysis)
  responseData Json @default("{}")

  // Reward
  treasureAwarded Boolean @default(false)

  @@index([sessionId])
  @@index([activityType])
}

// ============================================================================
// LINGUAFLOW MODULE
// Language learning with CEFR A1-C2, SM-2 SRS, heritage pathways, IB alignment
// Supports: French, Mandarin, Indonesian, Spanish, Italian, German
// ============================================================================

/// Language learner profile
model LanguageLearnerProfile {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Target language (ISO 639-3)
  targetLanguage String // fra, cmn, ind, spa, ita, deu

  // Native language
  nativeLanguage      String
  additionalLanguages String[] @default([])

  // CEFR levels (A1, A2, B1, B2, C1, C2)
  overallLevel   String @default("A1")
  listeningLevel String @default("A1")
  speakingLevel  String @default("A1")
  readingLevel   String @default("A1")
  writingLevel   String @default("A1")

  // Heritage speaker
  isHeritageSpeaker Boolean @default(false)

  // Curriculum
  curriculumFramework String  @default("ACARA")
  yearLevel           String?
  ibProgramme         String? // PYP, MYP, DP
  ibPhaseOrLevel      String?
  ibCriteriaScores    Json    @default("{}")

  // Gamification
  currentLevel  Int @default(1)
  totalXp       Int @default(0)
  currentStreak Int @default(0)
  longestStreak Int @default(0)

  // Engagement
  totalLearningMinutes Int       @default(0)
  totalSpeakingMinutes Int       @default(0)
  lastActiveAt         DateTime?

  // Offline
  lastSyncedAt       DateTime?
  offlineDataVersion Int       @default(0)

  // Status
  status     String   @default("active")
  enrolledAt DateTime @default(now())

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  vocabularyProgress LanguageVocabularyProgress?
  heritagePathway    LanguageHeritagePathway?
  conversations      LanguageConversation[]
  achievements       LanguageLearnerAchievement[]
  offlinePackages    LanguageOfflinePackage[]

  @@unique([tenantId, userId, targetLanguage])
  @@index([tenantId, targetLanguage])
  @@index([userId])
  @@index([overallLevel])
  @@index([status])
}

/// Vocabulary progress with SRS tracking
model LanguageVocabularyProgress {
  id        String                 @id @default(cuid())
  profileId String                 @unique
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Counts
  totalWordsExposed  Int @default(0)
  totalWordsMastered Int @default(0)
  totalWordsLearning Int @default(0)

  // Coverage tracking
  cefrCoverage  Json @default("{}")
  topicCoverage Json @default("{}")

  // Review scheduling
  dueForReview Int       @default(0)
  nextReviewAt DateTime?

  // Metrics
  averageRetentionRate Float @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items LanguageVocabularyItem[]
}

/// Individual vocabulary item with SM-2 SRS
model LanguageVocabularyItem {
  id         String                     @id @default(cuid())
  progressId String
  progress   LanguageVocabularyProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  // Word data
  wordId          String
  word            String
  translation     String
  cefrLevel       String  @default("A1")
  partOfSpeech    String?
  exampleSentence String?
  audioUrl        String?

  // Mastery
  masteryLevel String @default("new") // new, learning, reviewing, mastered

  // SM-2 SRS fields
  easeFactor   Float     @default(2.5)
  interval     Int       @default(0)
  repetitions  Int       @default(0)
  nextReviewAt DateTime?

  // Accuracy tracking
  timesCorrect       Int      @default(0)
  timesIncorrect     Int      @default(0)
  lastAttemptCorrect Boolean?

  // Timestamps
  firstEncounteredAt DateTime  @default(now())
  lastPracticedAt    DateTime?
  masteredAt         DateTime?

  // Pronunciation
  pronunciationScore Float?

  // Offline
  availableOffline Boolean @default(false)

  @@unique([progressId, wordId])
  @@index([progressId, nextReviewAt])
  @@index([progressId, masteryLevel])
  @@index([cefrLevel])
}

/// Heritage speaker pathway
model LanguageHeritagePathway {
  id        String                 @id @default(cuid())
  profileId String                 @unique
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Pathway type
  pathwayType String // literacy_launch, academic_register, standard_variety, cultural_deepening, accelerated

  // Assessment
  assessmentDate DateTime @default(now())

  // Proficiency levels
  oralProficiency       String
  literacyLevel         String
  academicRegisterLevel String
  dialectFeatures       String[] @default([])

  // Curriculum customization
  focusAreas        String[] @default([])
  skipAreas         String[] @default([])
  acceleratedTopics String[] @default([])

  // Progress
  literacyMilestones Json  @default("{}")
  registerProgress   Float @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// AI conversation session
model LanguageConversation {
  id        String                 @id @default(cuid())
  profileId String
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Conversation setup
  mode      String // role_play, free_conversation, topic_discussion, targeted_practice, ib_oral_practice
  language  String
  cefrLevel String

  // AI configuration
  aiRole    String?
  aiPersona String?

  // Scenario
  scenarioId    String?
  scenarioTitle String?

  // Targets
  targetVocabulary String[] @default([])
  targetStructures String[] @default([])

  // Timing
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMinutes Int       @default(0)

  // Transcript (JSON array of messages)
  messages Json @default("[]")

  // Assessment scores (0.0 - 1.0)
  fluencyScore  Float?
  accuracyScore Float?
  overallScore  Float?

  // Feedback
  strengths      String[] @default([])
  areasToImprove String[] @default([])
  vocabularyUsed String[] @default([])
  errorsNoted    Json     @default("[]")

  // Rewards
  xpEarned Int @default(0)

  // Self-rating
  selfFluencyRating    Int?
  selfConfidenceRating Int?

  // Flags
  isHeritageVariant Boolean @default(false)

  @@index([profileId, startedAt])
  @@index([profileId, mode])
}

/// Achievement definition
model LanguageAchievement {
  id String @id @default(cuid())

  // Identity
  code        String @unique
  name        String
  description String

  // Categorization
  category String // streak, vocabulary, speaking, listening, reading, writing, grammar, cultural, heritage, milestone

  // Display
  iconUrl  String?
  badgeUrl String?

  // Criteria
  criteriaType  String // count, streak, score, time, level
  criteriaValue Int

  // Reward
  xpReward Int    @default(0)
  rarity   String @default("common") // common, uncommon, rare, epic, legendary

  // Flags
  isHidden Boolean @default(false)
  isActive Boolean @default(true)

  // Language-specific (null = all languages)
  language String?

  // Audit
  createdAt DateTime @default(now())

  // Relations
  learnerAchievements LanguageLearnerAchievement[]

  @@index([category])
  @@index([isActive])
}

/// Learner's earned achievement
model LanguageLearnerAchievement {
  id            String                 @id @default(cuid())
  profileId     String
  profile       LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   LanguageAchievement    @relation(fields: [achievementId], references: [id])

  // Progress
  earnedAt        DateTime @default(now())
  currentProgress Int      @default(0)
  targetProgress  Int?

  // Display
  celebrationShown Boolean @default(false)

  @@unique([profileId, achievementId])
  @@index([profileId, earnedAt])
}

/// Offline content package
model LanguageOfflinePackage {
  id        String                 @id @default(cuid())
  profileId String
  profile   LanguageLearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Package type
  packageType String // vocabulary_review, lesson_unit, conversation_scenarios, practice_tests, full_sync

  // Content
  contentSelection Json    @default("{}")
  vocabularyCount  Int     @default(0)

  // Size
  totalItems              Int   @default(0)
  estimatedSizeMb         Float @default(0)
  estimatedOfflineMinutes Int   @default(0)

  // Status
  downloadStatus String    @default("pending") // pending, downloading, ready, expired, error
  downloadedAt   DateTime?
  expiresAt      DateTime?

  // Versioning
  packageVersion Int @default(1)

  // Offline progress (synced on reconnect)
  offlineProgressData   Json      @default("{}")
  lastOfflineActivityAt DateTime?
  pendingSyncItems      Int       @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId, downloadStatus])
  @@index([expiresAt])
}

// ============================================================================
// ANALYTICS & ML SUPPORT
// ============================================================================

/// Learning event for analytics pipeline
model LearningEvent {
  id       String @id @default(cuid())
  tenantId String

  // Event identification
  eventType   String
  eventSource String // early_years, linguaflow

  // Context
  learnerId String?
  sessionId String?

  // Payload
  payload Json

  // Timestamps
  occurredAt  DateTime  @default(now())
  processedAt DateTime?

  @@index([tenantId, eventType])
  @@index([tenantId, occurredAt])
  @@index([learnerId])
  @@index([processedAt])
}

/// ML prediction cache
model MLPrediction {
  id       String @id @default(cuid())
  tenantId String

  // Model info
  modelId      String
  modelVersion String

  // Target
  learnerId      String
  predictionType String // at_risk, engagement, proficiency, recommendation

  // Result
  prediction Json
  confidence Float

  // Lifecycle
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([tenantId, learnerId])
  @@index([predictionType])
  @@index([expiresAt])
}

// ============================================================================
// ADDITIONAL EARLY YEARS MODELS
// ============================================================================

/// Early Years conversation with AI characters
model EarlyYearsConversation {
  id       String @id @default(cuid())
  tenantId String

  // Context
  learnerId   String
  characterId String // Lettie, Numero, etc.
  sessionId   String?

  // Conversation state
  messages      Json     @default("[]")
  topic         String?
  learningGoal  String?
  isActive      Boolean  @default(true)

  // Timestamps
  startedAt DateTime @default(now())
  endedAt   DateTime?
  updatedAt DateTime @updatedAt

  @@index([tenantId, learnerId])
  @@index([characterId])
  @@index([isActive])
}

/// Picture password login attempt tracking
model EarlyYearsPicturePasswordAttempt {
  id         String @id @default(cuid())
  passwordId String

  // Attempt details
  wasSuccessful Boolean
  attemptedAt   DateTime @default(now())

  // Security context
  ipAddress String?
  userAgent String?

  @@index([passwordId, attemptedAt])
}

// ============================================================================
// ADDITIONAL LANGUAGE LEARNING MODELS
// ============================================================================

/// SRS review history for vocabulary items
model LanguageVocabularyReview {
  id       String @id @default(cuid())
  tenantId String

  // References
  learnerId String
  cardId    String

  // Review result
  quality        Int      // SM-2 quality rating (0-5)
  wasCorrect     Boolean
  responseTimeMs Int?

  // Before/after state
  previousInterval Int
  newInterval      Int
  previousEasiness Float
  newEasiness      Float

  // Timestamp
  reviewedAt DateTime @default(now())

  @@index([tenantId, learnerId])
  @@index([cardId])
  @@index([reviewedAt])
}

// ============================================================================
// 1EDTECH LTI ADVANTAGE (LTI 1.3)
// ============================================================================

/// Registered LTI 1.3 platforms (e.g., Canvas, Moodle, Blackboard)
model LTIPlatform {
  id       String @id @default(cuid())
  tenantId String

  name         String
  issuer       String
  clientId     String
  deploymentId String
  oidcAuthUrl  String
  tokenUrl     String
  jwksUrl      String

  publicKey  String? @db.Text
  privateKey String? @db.Text
  keyId      String?

  accessTokenUrl String?
  scopes         String[] @default([])

  status          String    @default("active") // active, inactive, pending_validation
  lastKeyRotation DateTime?
  metadata        Json      @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tools      LTITool[]
  lineItems  AGSLineItem[]
  oidcStates LTIOIDCState[]

  @@unique([tenantId, issuer, clientId])
  @@index([tenantId])
  @@index([issuer])
}

/// Registered LTI tools linked to a platform
model LTITool {
  id         String      @id @default(cuid())
  tenantId   String
  platformId String
  platform   LTIPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  name        String
  description String?

  launchUrl    String
  loginUrl     String
  redirectUrls String[] @default([])
  deepLinkUrl  String?

  customParameters Json     @default("{}")
  scopes           String[] @default([])
  iconUrl          String?
  status           String   @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([platformId])
}

/// OIDC state tracking for LTI launches (anti-replay)
model LTIOIDCState {
  id         String      @id @default(cuid())
  platformId String
  platform   LTIPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  state         String  @unique
  nonce         String
  loginHint     String
  targetLinkUri String
  ltiMessageHint String?

  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([state])
  @@index([expiresAt])
}

/// AGS line items for grade passback
model AGSLineItem {
  id         String      @id @default(cuid())
  tenantId   String
  platformId String
  platform   LTIPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  contextId      String
  label          String
  scoreMaximum   Float
  resourceId     String?
  resourceLinkId String?
  tag            String?

  startDateTime  DateTime?
  endDateTime    DateTime?
  gradesReleased Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scores  AGSScore[]
  results AGSResult[]

  @@index([tenantId])
  @@index([platformId, contextId])
}

/// AGS score submissions
model AGSScore {
  id         String      @id @default(cuid())
  lineItemId String
  lineItem   AGSLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)

  userId           String
  scoreGiven       Float?
  scoreMaximum     Float?
  comment          String?
  activityProgress String // Initialized, Started, InProgress, Submitted, Completed
  gradingProgress  String // FullyGraded, Pending, PendingManual, Failed, NotReady

  timestamp DateTime @default(now())

  @@index([lineItemId, userId])
}

/// AGS results (read-only computed from scores)
model AGSResult {
  id         String      @id @default(cuid())
  lineItemId String
  lineItem   AGSLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)

  userId        String
  resultScore   Float?
  resultMaximum Float?
  comment       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lineItemId, userId])
}

// ============================================================================
// ONEROSTER 1.2
// ============================================================================

/// OneRoster connection configuration for SIS integration
model OneRosterConnection {
  id       String @id @default(cuid())
  tenantId String

  name         String
  baseUrl      String
  clientId     String
  clientSecret String
  tokenUrl     String
  scope        String?

  accessToken String?   @db.Text
  tokenExpiry DateTime?

  lastSyncAt DateTime?
  syncStatus String    @default("idle") // idle, syncing, error

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fieldMappings OneRosterFieldMapping[]
  syncJobs      OneRosterSyncJob[]

  @@index([tenantId])
}

/// Field mapping between Scholarly and OneRoster schemas
model OneRosterFieldMapping {
  id           String             @id @default(cuid())
  connectionId String
  connection   OneRosterConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  sourceField     String
  targetField     String
  transform       String? // uppercase, lowercase, trim, date_iso, custom
  customTransform String?

  @@index([connectionId])
}

/// OneRoster sync job tracking
model OneRosterSyncJob {
  id           String             @id @default(cuid())
  tenantId     String
  connectionId String
  connection   OneRosterConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  resourceType String // orgs, users, classes, enrollments, etc.
  direction    String // inbound, outbound
  status       String @default("pending") // pending, running, completed, failed

  totalRecords     Int @default(0)
  processedRecords Int @default(0)
  errorRecords     Int @default(0)

  deltaFrom DateTime?
  errors    Json      @default("[]")

  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([connectionId, status])
}

// ============================================================================
// CASE (Competency & Academic Standards Exchange)
// ============================================================================

/// CASE competency framework document
model CASEFramework {
  id       String @id @default(cuid())
  tenantId String

  identifier String
  uri        String?
  creator    String
  title      String
  publisher  String?
  description String?

  subject       String[] @default([])
  language      String?
  version       String?
  adoptionStatus String @default("Draft") // Draft, Review, Adopted, Deprecated

  sourceUrl     String?
  lastSyncAt    DateTime?
  status        String   @default("active") // active, archived, draft

  document Json // Full CFDocument JSON

  importedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items        CASEItem[]
  associations CASEAssociation[]
  itemMappings CASEItemMapping[]

  @@unique([tenantId, identifier])
  @@index([tenantId])
  @@index([tenantId, adoptionStatus])
}

/// CASE competency framework item (standard/competency)
model CASEItem {
  id          String        @id @default(cuid())
  frameworkId String
  framework   CASEFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  identifier         String
  uri                String?
  fullStatement      String  @db.Text
  humanCodingScheme  String?
  cfItemType         String?
  educationLevel     String[] @default([])
  abbreviatedStatement String?
  conceptKeywords    String[] @default([])
  listEnumeration    String?
  language           String?

  lastChangeDateTime DateTime @default(now())

  originAssociations      CASEAssociation[] @relation("OriginNode")
  destinationAssociations CASEAssociation[] @relation("DestinationNode")
  mappings                CASEItemMapping[]

  @@unique([frameworkId, identifier])
  @@index([frameworkId])
  @@index([humanCodingScheme])
}

/// CASE association between items
model CASEAssociation {
  id          String        @id @default(cuid())
  frameworkId String?
  framework   CASEFramework? @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  identifier      String
  associationType String // isChildOf, isPartOf, precedes, isRelatedTo, replacedBy, exemplar
  sequenceNumber  Int?

  originNodeId      String
  originNode        CASEItem @relation("OriginNode", fields: [originNodeId], references: [id])
  destinationNodeId String
  destinationNode   CASEItem @relation("DestinationNode", fields: [destinationNodeId], references: [id])

  lastChangeDateTime DateTime @default(now())

  @@index([frameworkId])
  @@index([originNodeId])
  @@index([destinationNodeId])
  @@index([associationType])
}

/// Mapping between CASE items and knowledge graph nodes
model CASEItemMapping {
  id          String        @id @default(cuid())
  tenantId    String
  frameworkId String
  framework   CASEFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  caseItemId  String
  caseItem    CASEItem      @relation(fields: [caseItemId], references: [id])

  knowledgeGraphNodeId String
  confidence           Float
  mappedBy             String @default("auto") // auto, manual

  mappedAt DateTime @default(now())

  @@unique([caseItemId, knowledgeGraphNodeId])
  @@index([tenantId])
  @@index([frameworkId])
}

// ============================================================================
// CLR 2.0 / OPEN BADGES 3.0
// ============================================================================

/// Achievement/badge definition template
model AchievementDefinition {
  id       String @id @default(cuid())
  tenantId String

  name            String
  description     String @db.Text
  achievementType String
  image           String?

  criteriaType      String  // narrative, id_based
  criteriaNarrative String? @db.Text
  criteriaId        String?

  alignment Json @default("[]") // AchievementAlignment[]
  tags      String[] @default([])

  evidenceRequired    Boolean @default(false)
  evidenceDescription String?
  resultDescriptions  Json    @default("[]") // ResultDescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assertions BadgeAssertion[]

  @@index([tenantId])
  @@index([achievementType])
}

/// Issued badge/credential assertion
model BadgeAssertion {
  id                      String                @id @default(cuid())
  tenantId                String
  achievementDefinitionId String
  achievementDefinition   AchievementDefinition @relation(fields: [achievementDefinitionId], references: [id])

  recipientId          String
  recipientEmail       String?
  recipientIdentityHash String?
  issuerId             String

  credential    Json // Full OpenBadgeCredential JSON-LD
  verificationType String // HostedBadge, SignedBadge
  verificationUrl  String?
  signatureJws     String? @db.Text

  status    String @default("active") // draft, active, revoked, expired

  issuedAt        DateTime  @default(now())
  expiresAt       DateTime?
  revokedAt       DateTime?
  revocationReason String?

  nftTokenId        String?
  nftTransactionHash String?

  evidence Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([recipientId])
  @@index([issuerId])
  @@index([status])
}

/// Badge revocation list
model BadgeRevocation {
  id          String @id @default(cuid())
  tenantId    String
  assertionId String @unique

  revokedAt DateTime @default(now())
  reason    String

  @@index([tenantId])
}

// ============================================================================
// ED-FI ODS/API v7 INTEGRATION
// ============================================================================

/// Ed-Fi district connection configuration
model EdFiConnection {
  id       String @id @default(cuid())
  tenantId String

  name         String
  districtName String
  baseUrl      String
  oauthUrl     String
  clientId     String
  clientSecret String

  schoolYear       Int
  namespace        String
  apiVersion       String    @default("v7.0")
  pageSize         Int       @default(100)
  rateLimitPerMin  Int       @default(300)
  syncDirection    String    @default("inbound") // inbound, outbound, bidirectional
  enabledResources String[]  @default([])

  accessToken  String?   @db.Text
  tokenExpiry  DateTime?
  lastSyncVersion Int?

  status String @default("active") // active, inactive, error

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  syncJobs      EdFiSyncJob[]
  fieldMappings EdFiFieldMapping[]
  conflicts     EdFiSyncConflict[]
  changeTrackers EdFiChangeTracker[]

  @@index([tenantId])
  @@index([tenantId, status])
}

/// Ed-Fi sync job execution tracking
model EdFiSyncJob {
  id           String         @id @default(cuid())
  tenantId     String
  connectionId String
  connection   EdFiConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  direction    String // inbound, outbound, bidirectional
  resourceType String // students, staff, grades, attendance, etc.
  status       String @default("pending") // pending, running, completed, failed, cancelled

  totalRecords     Int @default(0)
  processedRecords Int @default(0)
  createdRecords   Int @default(0)
  updatedRecords   Int @default(0)
  errorRecords     Int @default(0)
  skippedRecords   Int @default(0)

  lastChangeVersion Int?
  errors            Json @default("[]")

  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  conflicts EdFiSyncConflict[]

  @@index([tenantId])
  @@index([connectionId, status])
  @@index([createdAt])
}

/// Ed-Fi per-district field transform configuration
model EdFiFieldMapping {
  id           String         @id @default(cuid())
  tenantId     String
  connectionId String
  connection   EdFiConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  resourceType   String
  scholarlyField String
  edfiField      String
  direction      String  @default("inbound") // inbound, outbound, bidirectional

  transform       String? // direct, uppercase, lowercase, date_format, lookup, custom
  transformConfig Json?
  isRequired      Boolean @default(false)
  defaultValue    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, resourceType, scholarlyField, edfiField])
  @@index([tenantId])
  @@index([connectionId, resourceType])
}

/// Ed-Fi sync conflicts requiring manual resolution
model EdFiSyncConflict {
  id           String         @id @default(cuid())
  tenantId     String
  connectionId String
  connection   EdFiConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  syncJobId    String
  syncJob      EdFiSyncJob    @relation(fields: [syncJobId], references: [id], onDelete: Cascade)

  resourceType   String
  resourceId     String
  scholarlyData  Json
  edfiData       Json
  conflictFields String[] @default([])

  resolution   String? // scholarly_wins, edfi_wins, manual_merge
  resolvedData Json?
  resolvedBy   String?
  resolvedAt   DateTime?

  status String @default("pending") // pending, resolved, ignored

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([connectionId, status])
  @@index([syncJobId])
}

/// Ed-Fi local change tracking for outbound sync
model EdFiChangeTracker {
  id           String         @id @default(cuid())
  tenantId     String
  connectionId String
  connection   EdFiConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  entityType     String
  entityId       String
  operation      String // create, update, delete
  changedFields  String[] @default([])
  previousValues Json     @default("{}")
  newValues      Json     @default("{}")

  synced    Boolean @default(false)
  syncJobId String?

  trackedAt DateTime @default(now())

  @@index([tenantId])
  @@index([connectionId, synced])
  @@index([entityType, entityId])
}

// ============================================================================
// GOLDEN PATH - ADAPTATION ENGINE
// ============================================================================

/// Learner adaptation profile with BKT states and EMA signals
model AdaptationProfile {
  id       String @id @default(cuid())
  tenantId String

  learnerId String @unique

  // EMA state (exponential moving average signals)
  emaAccuracy     Float @default(0.5)
  emaResponseTime Float @default(5000)
  emaEngagement   Float @default(0.5)
  emaHintUsage    Float @default(0)
  emaSkipRate     Float @default(0)

  currentDifficulty Float @default(0.5)
  targetSuccessRate Float @default(0.8)

  sessionCount     Int   @default(0)
  totalTimeMinutes Float @default(0)

  lastSessionAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  competencyStates BKTCompetencyState[]
  adaptationEvents AdaptationEvent[]

  @@index([tenantId])
  @@index([learnerId])
}

/// Per-competency BKT mastery state
model BKTCompetencyState {
  id        String            @id @default(cuid())
  profileId String
  profile   AdaptationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  competencyId String
  domain       String

  // BKT parameters
  pLearn Float @default(0.1)
  pGuess Float @default(0.2)
  pSlip  Float @default(0.1)
  pKnown Float @default(0.5)

  observations       Int      @default(0)
  lastObservationAt   DateTime?
  masteryHistory     Json     @default("[]") // MasterySnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, competencyId])
  @@index([profileId])
  @@index([competencyId])
  @@index([domain])
}

/// Adaptation rule for decision gates
model AdaptationRule {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String
  scope       String  // global, domain, competency
  scopeId     String? // domain or competency ID

  priority       Int
  conditions     Json   // AdaptationRuleCondition[]
  conditionLogic String @default("AND") // AND, OR
  action         Json   // AdaptationRuleAction

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, scope, isActive])
  @@index([priority])
}

/// Log of adaptation decisions made
model AdaptationEvent {
  id        String            @id @default(cuid())
  tenantId  String
  profileId String
  profile   AdaptationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  learnerId      String
  ruleId         String?
  triggerSignals Json   // AdaptationSignal[]
  action         Json   // AdaptationRuleAction
  outcome        String?

  timestamp DateTime @default(now())

  @@index([tenantId, learnerId])
  @@index([profileId])
  @@index([timestamp])
}

// ============================================================================
// GOLDEN PATH - CURIOSITY ENGINE
// ============================================================================

/// Individual curiosity signal from learner activity
model CuriositySignal {
  id       String @id @default(cuid())
  tenantId String

  learnerId  String
  signalType String // voluntary_exploration, question_asking, topic_deep_dive, etc.
  topicId    String
  topicName  String
  domain     String
  strength   Float  @default(0.5)

  context Json @default("{}") // session, content, dwell time, etc.

  recordedAt DateTime @default(now())

  @@index([tenantId, learnerId])
  @@index([learnerId, topicId])
  @@index([learnerId, signalType])
  @@index([recordedAt])
}

/// Cached curiosity profile for a learner
model CuriosityProfileCache {
  id       String @id @default(cuid())
  tenantId String

  learnerId String @unique

  overallScore       Float @default(0)
  signalCount        Int   @default(0)
  breadthScore       Float @default(0)
  depthScore         Float @default(0)
  questionFrequency  Float @default(0)
  explorationRate    Float @default(0)

  clusters          Json @default("[]") // InterestCluster[]
  emergingInterests Json @default("[]") // EmergingInterest[]

  lastUpdated DateTime @default(now())

  @@index([tenantId])
  @@index([learnerId])
}

// ============================================================================
// GOLDEN PATH - MULTI-OBJECTIVE OPTIMIZATION
// ============================================================================

/// Objective weights configuration (per-learner, per-cohort, or per-institution)
model ObjectiveWeightsConfig {
  id       String @id @default(cuid())
  tenantId String

  learnerId     String?
  cohortId      String?
  institutionId String?

  // 7 objectives (must sum to 1.0)
  mastery    Float @default(0.25)
  engagement Float @default(0.20)
  efficiency Float @default(0.15)
  curiosity  Float @default(0.15)
  wellBeing  Float @default(0.10)
  breadth    Float @default(0.08)
  depth      Float @default(0.07)

  source String @default("default") // learner, cohort, institution, default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, learnerId])
  @@index([tenantId])
  @@index([learnerId])
  @@index([cohortId])
  @@index([institutionId])
}

/// Log of optimization runs
model OptimizationEvent {
  id       String @id @default(cuid())
  tenantId String

  learnerId         String
  weightsUsed       Json // ObjectiveWeights
  constraintsApplied Json // OptimizationConstraints
  paretoFrontSize   Int
  selectedPathId    String
  computeTimeMs     Int

  result Json // Full OptimizationResult

  timestamp DateTime @default(now())

  @@index([tenantId, learnerId])
  @@index([timestamp])
}

// ============================================================================
// PHASE 1: SELF-SOVEREIGN IDENTITY & VERIFIABLE CREDENTIALS
// ============================================================================

/// Decentralized Identifier record (W3C DID Core 1.0)
model DecentralizedIdentifier {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  userId           String    @map("user_id")
  did              String    @unique
  method           String
  methodSpecificId String    @map("method_specific_id")
  controller       String
  isPrimary        Boolean   @default(false) @map("is_primary")
  status           DIDStatus @default(ACTIVE)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deactivatedAt    DateTime? @map("deactivated_at")

  keyPairs          KeyPair[]
  wallet            DigitalWallet?              @relation(fields: [walletId], references: [id])
  walletId          String?                     @map("wallet_id")
  credentials       VerifiableCredentialRecord[] @relation("CredentialSubject")
  issuedCredentials VerifiableCredentialRecord[] @relation("CredentialIssuer")

  @@index([tenantId, userId])
  @@index([tenantId, did])
  @@index([tenantId, isPrimary])
  @@map("decentralized_identifiers")
}

enum DIDStatus {
  ACTIVE
  DEACTIVATED
  REVOKED
}

/// Cached DID Document resolution
model DIDDocument {
  id           String   @id @default(cuid())
  did          String   @unique
  document     Json
  documentHash String   @map("document_hash")
  fetchedAt    DateTime @default(now()) @map("fetched_at")
  expiresAt    DateTime @map("expires_at")

  @@map("did_documents")
}

/// Cryptographic key pair associated with a DID
model KeyPair {
  id                   String    @id @default(cuid())
  tenantId             String    @map("tenant_id")
  did                  String
  didRecord            DecentralizedIdentifier @relation(fields: [did], references: [did])
  keyType              KeyType   @map("key_type")
  publicKey            String    @map("public_key")
  encryptedPrivateKey  String    @map("encrypted_private_key") @db.Text
  privateKeyEncryption String    @default("AES-256-GCM") @map("private_key_encryption")
  kdf                  String    @default("Argon2id")
  purposes             Json
  isPrimary            Boolean   @default(false) @map("is_primary")
  status               KeyStatus @default(KEY_ACTIVE)
  createdAt            DateTime  @default(now()) @map("created_at")
  expiresAt            DateTime? @map("expires_at")
  revokedAt            DateTime? @map("revoked_at")
  rotatedAt            DateTime? @map("rotated_at")
  rotatedToKeyId       String?   @map("rotated_to_key_id")

  @@index([tenantId, did])
  @@index([did, isPrimary])
  @@map("key_pairs")
}

enum KeyType {
  Ed25519
  secp256k1
  P256
}

enum KeyStatus {
  KEY_ACTIVE
  ROTATED
  KEY_REVOKED
  KEY_EXPIRED
}

/// Key rotation audit log
model KeyRotationLog {
  id            String            @id @default(cuid())
  tenantId      String            @map("tenant_id")
  did           String
  previousKeyId String            @map("previous_key_id")
  newKeyId      String            @map("new_key_id")
  reason        KeyRotationReason
  rotatedBy     String            @map("rotated_by")
  rotatedAt     DateTime          @default(now()) @map("rotated_at")
  metadata      Json?

  @@index([tenantId, did])
  @@map("key_rotation_logs")
}

enum KeyRotationReason {
  SCHEDULED
  COMPROMISE_SUSPECTED
  USER_REQUESTED
  POLICY
}

/// User's digital identity wallet
model DigitalWallet {
  id              String       @id @default(cuid())
  tenantId        String       @map("tenant_id")
  userId          String       @unique @map("user_id")
  primaryDid      String       @map("primary_did")
  dids            DecentralizedIdentifier[]
  credentials     VerifiableCredentialRecord[]
  recoveryConfig  Json         @map("recovery_config")
  encryptionKeyId String       @map("encryption_key_id")
  status          WalletStatus @default(WALLET_ACTIVE)
  createdAt       DateTime     @default(now()) @map("created_at")
  lastAccessedAt  DateTime     @default(now()) @map("last_accessed_at")
  lockedAt        DateTime?    @map("locked_at")
  deactivatedAt   DateTime?    @map("deactivated_at")
  backups         WalletBackup[]

  @@index([tenantId, userId])
  @@index([tenantId, primaryDid])
  @@map("digital_wallets")
}

enum WalletStatus {
  WALLET_ACTIVE
  WALLET_LOCKED
  RECOVERING
  WALLET_DEACTIVATED
}

/// Encrypted wallet backup
model WalletBackup {
  id               String        @id @default(cuid())
  tenantId         String        @map("tenant_id")
  walletId         String        @map("wallet_id")
  wallet           DigitalWallet @relation(fields: [walletId], references: [id])
  version          String
  encryptedPayload String        @map("encrypted_payload") @db.Text
  encryptionParams Json          @map("encryption_params")
  checksum         String
  createdAt        DateTime      @default(now()) @map("created_at")

  @@index([tenantId, walletId])
  @@map("wallet_backups")
}

/// Verifiable Credential storage (W3C VC Data Model v2.0)
model VerifiableCredentialRecord {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  credentialId     String    @unique @map("credential_id")
  types            Json
  issuerDid        String    @map("issuer_did")
  issuer           DecentralizedIdentifier @relation("CredentialIssuer", fields: [issuerDid], references: [did])
  subjectDid       String    @map("subject_did")
  subject          DecentralizedIdentifier @relation("CredentialSubject", fields: [subjectDid], references: [did])
  walletId         String?   @map("wallet_id")
  wallet           DigitalWallet? @relation(fields: [walletId], references: [id])
  credential       Json
  subjectData      Json      @map("subject_data")
  statusListIndex  Int?      @map("status_list_index")
  issuanceDate     DateTime  @map("issuance_date")
  expirationDate   DateTime? @map("expiration_date")
  isRevoked        Boolean   @default(false) @map("is_revoked")
  revokedAt        DateTime? @map("revoked_at")
  revocationReason String?   @map("revocation_reason")
  revokedBy        String?   @map("revoked_by")
  schemaId         String?   @map("schema_id")
  schema           CredentialSchema? @relation(fields: [schemaId], references: [id])
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, subjectDid])
  @@index([tenantId, issuerDid])
  @@index([tenantId, isRevoked])
  @@index([credentialId])
  @@map("verifiable_credentials")
}

/// Credential schema definitions
model CredentialSchema {
  id                 String    @id @default(cuid())
  name               String
  version            String
  credentialType     String    @map("credential_type")
  schema             Json
  author             String
  isDefault          Boolean   @default(false) @map("is_default")
  validJurisdictions Json?     @map("valid_jurisdictions")
  createdAt          DateTime  @default(now()) @map("created_at")
  credentials        VerifiableCredentialRecord[]

  @@unique([credentialType, version])
  @@index([credentialType, isDefault])
  @@map("credential_schemas")
}

/// Status list for credential revocation (Status List 2021)
model CredentialStatusList {
  id            String            @id @default(cuid())
  tenantId      String            @map("tenant_id")
  statusListId  String            @unique @map("status_list_id")
  purpose       StatusListPurpose
  encodedList   String            @map("encoded_list") @db.Text
  currentIndex  Int               @default(0) @map("current_index")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("credential_status_lists")
}

enum StatusListPurpose {
  REVOCATION
  SUSPENSION
}

/// Verifiable Presentation records
model VerifiablePresentationRecord {
  id             String    @id @default(cuid())
  tenantId       String    @map("tenant_id")
  presentationId String    @unique @map("presentation_id")
  holderDid      String    @map("holder_did")
  presentation   Json
  credentialIds  Json      @map("credential_ids")
  challenge      String?
  domain         String?
  verified       Boolean?
  verifiedAt     DateTime? @map("verified_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([tenantId, holderDid])
  @@map("verifiable_presentations")
}

/// SSI event audit log
model SSIEventLog {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  eventType    String   @map("event_type")
  actorId      String   @map("actor_id")
  did          String?
  credentialId String?  @map("credential_id")
  walletId     String?  @map("wallet_id")
  payload      Json
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  requestId    String?  @map("request_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([tenantId, eventType])
  @@index([tenantId, actorId])
  @@index([tenantId, did])
  @@index([tenantId, createdAt])
  @@map("ssi_event_logs")
}

// ============================================================================
// PHASE 3: ADVANCED LEARNING FEATURES
// ============================================================================

/// Video recording for lesson coaching
model VideoRecording {
  id            String   @id @default(cuid())
  tenantId      String
  educatorId    String
  title         String
  description   String?
  videoUrl      String
  duration      Int
  fileSize      Int
  format        String
  visibility    String   @default("private")
  status        String   @default("processing")
  transcript    Json?
  aiAnalysis    Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  reviewCycles  VideoReviewCycle[]
  shares        VideoShare[]

  @@index([tenantId, educatorId])
  @@index([tenantId, status])
}

/// Share record for video recordings
model VideoShare {
  id           String         @id @default(cuid())
  tenantId     String
  recordingId  String
  recording    VideoRecording @relation(fields: [recordingId], references: [id])
  sharedWith   String
  permissions  Json
  createdAt    DateTime       @default(now())

  @@unique([recordingId, sharedWith])
  @@index([tenantId, sharedWith])
}

/// Review cycle for video coaching
model VideoReviewCycle {
  id           String         @id @default(cuid())
  tenantId     String
  recordingId  String
  recording    VideoRecording @relation(fields: [recordingId], references: [id])
  reviewerId   String
  reviewType   String
  status       String         @default("in_progress")
  comments     Json           @default("[]")
  feedback     Json?
  selfReflection Json?
  createdAt    DateTime       @default(now())
  completedAt  DateTime?

  @@index([tenantId, recordingId])
  @@index([tenantId, reviewerId])
}

/// Peer review session
model PeerReviewSession {
  id              String   @id @default(cuid())
  tenantId        String
  creatorId       String
  title           String
  description     String?
  config          Json
  status          String   @default("draft")
  submissionCount Int      @default(0)
  reviewCount     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  submissions     PeerSubmission[]
  reviewAssignments ReviewAssignment[]

  @@index([tenantId, status])
  @@index([tenantId, creatorId])
}

/// Peer review submission
model PeerSubmission {
  id          String            @id @default(cuid())
  tenantId    String
  sessionId   String
  session     PeerReviewSession @relation(fields: [sessionId], references: [id])
  submitterId String
  content     Json
  isAnonymous Boolean           @default(false)
  submittedAt DateTime          @default(now())

  @@index([tenantId, sessionId])
  @@index([tenantId, submitterId])
}

/// Review assignment mapping reviewers to submissions
model ReviewAssignment {
  id           String            @id @default(cuid())
  tenantId     String
  sessionId    String
  session      PeerReviewSession @relation(fields: [sessionId], references: [id])
  reviewerId   String
  submissionId String
  review       Json?
  status       String            @default("pending")
  completedAt  DateTime?

  @@unique([sessionId, reviewerId, submissionId])
  @@index([tenantId, reviewerId])
}

/// Industry partner organization
model IndustryPartner {
  id                String   @id @default(cuid())
  tenantId          String
  name              String
  industry          String
  contactInfo       Json
  safeguardingCheck Json?
  insuranceDetails  Json?
  tier              String   @default("standard")
  status            String   @default("prospective")
  totalPlacements   Int      @default(0)
  averageRating     Float    @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  opportunities IndustryOpportunity[]

  @@index([tenantId, status])
  @@index([tenantId, industry])
}

/// Industry opportunity/placement posting
model IndustryOpportunity {
  id           String          @id @default(cuid())
  tenantId     String
  partnerId    String
  partner      IndustryPartner @relation(fields: [partnerId], references: [id])
  title        String
  type         String
  description  String
  requirements Json
  schedule     Json
  compensation Json?
  maxPositions Int             @default(1)
  status       String          @default("draft")
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  applications ExperienceApplication[]

  @@index([tenantId, status])
  @@index([tenantId, type])
}

/// Application for industry experience
model ExperienceApplication {
  id            String              @id @default(cuid())
  tenantId      String
  opportunityId String
  opportunity   IndustryOpportunity @relation(fields: [opportunityId], references: [id])
  applicantId   String
  coverLetter   String?
  resume        Json?
  portfolio     Json?
  status        String              @default("draft")
  statusHistory Json                @default("[]")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  placement ExperiencePlacement?

  @@unique([opportunityId, applicantId])
  @@index([tenantId, applicantId])
  @@index([tenantId, status])
}

/// Active industry experience placement
model ExperiencePlacement {
  id            String                @id @default(cuid())
  tenantId      String
  applicationId String                @unique
  application   ExperienceApplication @relation(fields: [applicationId], references: [id])
  learningPlan  Json?
  progressLogs  Json                  @default("[]")
  evaluations   Json                  @default("[]")
  totalHours    Float                 @default(0)
  status        String                @default("pending_start")
  startedAt     DateTime?
  completedAt   DateTime?
  credentialId  String?

  @@index([tenantId, status])
}

/// Professional development course
model PDCourse {
  id             String   @id @default(cuid())
  tenantId       String
  creatorId      String
  title          String
  description    String
  category       String
  level          String
  estimatedHours Float
  pdCredits      Float
  modules        Json
  status         String   @default("draft")
  rating         Float    @default(0)
  ratingCount    Int      @default(0)
  completionRate Float    @default(0)
  enrollmentCount Int     @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  enrollments PDEnrollment[]

  @@index([tenantId, status])
  @@index([tenantId, category])
}

/// Educator enrollment in PD course
model PDEnrollment {
  id             String    @id @default(cuid())
  tenantId       String
  courseId        String
  course         PDCourse  @relation(fields: [courseId], references: [id])
  educatorId     String
  status         String    @default("enrolled")
  progress       Float     @default(0)
  moduleProgress Json      @default("[]")
  enrolledAt     DateTime  @default(now())
  completedAt    DateTime?
  credentialId   String?

  @@unique([courseId, educatorId])
  @@index([tenantId, educatorId])
  @@index([tenantId, status])
}

/// PBL project template
model PBLProject {
  id               String   @id @default(cuid())
  tenantId         String
  creatorId        String
  title            String
  description      String
  drivingQuestion  String
  subjectAreas     String[]
  gradeLevel       String
  estimatedDuration String
  goldStandard     Json
  milestones       Json
  resources        Json     @default("[]")
  assessmentPlan   Json?
  status           String   @default("draft")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  instances PBLProjectInstance[]

  @@index([tenantId, status])
}

/// Student/team instance of a PBL project
model PBLProjectInstance {
  id              String      @id @default(cuid())
  tenantId        String
  projectId       String
  project         PBLProject  @relation(fields: [projectId], references: [id])
  facilitatorId   String
  teamMembers     Json
  currentPhase    String      @default("launch")
  milestoneStatus Json
  reflections     Json        @default("[]")
  status          String      @default("active")
  startedAt       DateTime    @default(now())
  targetEndDate   DateTime?
  completedAt     DateTime?
  finalAssessment Json?

  pitchSubmissions PitchSubmission[]

  @@index([tenantId, status])
  @@index([tenantId, facilitatorId])
}

/// Pitch submission for PBL project
model PitchSubmission {
  id           String             @id @default(cuid())
  tenantId     String
  instanceId   String
  instance     PBLProjectInstance @relation(fields: [instanceId], references: [id])
  pitchType    String
  duration     Int?
  audience     String[]
  panelists    String[]
  recordingUrl String?
  slidesUrl    String?
  practiceData Json               @default("[]")
  assessments  Json               @default("[]")
  status       String             @default("scheduled")
  createdAt    DateTime           @default(now())

  @@index([tenantId, instanceId])
}

// ============================================================================
// PHASE 4: GOVERNANCE & IMMERSION
// ============================================================================

/// DAO governance proposal
model GovernanceProposal {
  id           String   @id @default(cuid())
  tenantId     String
  proposalId   BigInt   @unique
  proposer     String
  title        String
  description  String   @db.Text
  category     String
  actions      Json     @default("[]")
  state        String
  forVotes     BigInt   @default(0)
  againstVotes BigInt   @default(0)
  abstainVotes BigInt   @default(0)
  quorum       BigInt   @default(0)
  eta          DateTime?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  votes GovernanceVote[]

  @@index([tenantId, state])
  @@index([tenantId, proposer])
  @@index([tenantId, category])
}

/// Individual vote on a governance proposal
model GovernanceVote {
  id         String             @id @default(cuid())
  tenantId   String
  proposalId String
  proposal   GovernanceProposal @relation(fields: [proposalId], references: [id])
  voter      String
  support    String
  weight     BigInt
  reason     String?
  txHash     String?
  votedAt    DateTime           @default(now())

  @@unique([proposalId, voter])
  @@index([tenantId, voter])
}

/// Voting power delegation
model VoteDelegation {
  id              String   @id @default(cuid())
  tenantId        String
  delegator       String
  delegateAddress String
  amount          BigInt
  isActive        Boolean  @default(true)
  txHash          String?
  createdAt       DateTime @default(now())
  revokedAt       DateTime?

  @@index([tenantId, delegator])
  @@index([tenantId, delegateAddress])
}

/// Public delegate profile
model DelegateProfile {
  id              String   @id @default(cuid())
  tenantId        String
  delegateAddress String   @unique
  name            String
  bio             String?  @db.Text
  focusAreas      String[]
  votingPower     BigInt   @default(0)
  delegatorCount  Int      @default(0)
  proposalsVoted  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, votingPower(sort: Desc)])
}

/// Token staking pool
model StakingPool {
  id             String   @id @default(cuid())
  tenantId       String
  name           String
  purpose        String
  minimumStake   BigInt
  lockPeriodDays Int
  apr            Float
  totalStaked    BigInt   @default(0)
  capacity       BigInt?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  positions StakingPosition[]

  @@index([tenantId, purpose])
}

/// User staking position
model StakingPosition {
  id            String      @id @default(cuid())
  tenantId      String
  userId        String
  poolId        String
  pool          StakingPool @relation(fields: [poolId], references: [id])
  stakedAmount  BigInt
  earnedRewards BigInt      @default(0)
  status        String      @default("active")
  stakedAt      DateTime    @default(now())
  lockUntil     DateTime
  unstakedAt    DateTime?

  @@index([tenantId, userId])
  @@index([tenantId, poolId])
}

/// Publisher NFT for educational content
model PublisherNFT {
  id               String   @id @default(cuid())
  tenantId         String
  tokenId          BigInt
  creator          String
  contentType      String
  contentId        String
  title            String
  metadataUri      String?
  validationStatus String   @default("pending")
  validationScores Json     @default("[]")
  isListed         Boolean  @default(false)
  listPrice        BigInt?
  totalSales       Int      @default(0)
  totalRevenue     BigInt   @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([tenantId, tokenId])
  @@index([tenantId, creator])
  @@index([tenantId, validationStatus])
}

/// Developer account for marketplace
model DeveloperAccount {
  id                 String   @id @default(cuid())
  tenantId           String
  userId             String   @unique
  name               String
  accountType        String
  supportEmail       String
  website            String?
  verificationStatus String   @default("unverified")
  revenueShare       Float    @default(0.7)
  status             String   @default("pending_review")
  totalEarnings      BigInt   @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  apps MarketplaceApp[]

  @@index([tenantId, status])
}

/// Marketplace application
model MarketplaceApp {
  id          String           @id @default(cuid())
  tenantId    String
  developerId String
  developer   DeveloperAccount @relation(fields: [developerId], references: [id])
  name        String
  slug        String           @unique
  description String?          @db.Text
  category    String
  appType     String
  version     String           @default("1.0.0")
  status      String           @default("draft")
  rating      Float            @default(0)
  ratingCount Int              @default(0)
  installs    Int              @default(0)
  pricing     Json?
  permissions String[]
  isFeatured  Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  installations AppInstallation[]
  reviews       AppReview[]

  @@index([tenantId, status])
  @@index([tenantId, category])
}

/// App installation record
model AppInstallation {
  id                 String         @id @default(cuid())
  tenantId           String
  appId              String
  app                MarketplaceApp @relation(fields: [appId], references: [id])
  userId             String
  installScope       String
  grantedPermissions String[]
  status             String         @default("active")
  installedAt        DateTime       @default(now())
  uninstalledAt      DateTime?

  @@unique([appId, userId])
  @@index([tenantId, userId])
}

/// User review for marketplace app
model AppReview {
  id        String         @id @default(cuid())
  tenantId  String
  appId     String
  app       MarketplaceApp @relation(fields: [appId], references: [id])
  userId    String
  rating    Int
  title     String?
  body      String?        @db.Text
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([appId, userId])
  @@index([tenantId, appId])
}

/// Community feature request with crowdfunding
model CommunityRequest {
  id             String   @id @default(cuid())
  tenantId       String
  requesterId    String
  title          String
  description    String   @db.Text
  requirements   Json     @default("[]")
  category       String?
  fundingGoal    BigInt
  currentFunding BigInt   @default(0)
  voteCount      Int      @default(0)
  bountyStatus   String   @default("open")
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  pledges FundingPledge[]
  claims  BountyClaim[]

  @@index([tenantId, status])
  @@index([tenantId, bountyStatus])
}

/// Funding pledge for community request
model FundingPledge {
  id        String           @id @default(cuid())
  tenantId  String
  requestId String
  request   CommunityRequest @relation(fields: [requestId], references: [id])
  pledgerId String
  amount    BigInt
  status    String           @default("active")
  createdAt DateTime         @default(now())

  @@index([tenantId, pledgerId])
}

/// Developer claim on bounty request
model BountyClaim {
  id          String           @id @default(cuid())
  tenantId    String
  requestId   String
  request     CommunityRequest @relation(fields: [requestId], references: [id])
  developerId String
  proposal    String           @db.Text
  milestones  Json
  status      String           @default("proposed")
  totalPaid   BigInt           @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId, developerId])
}

/// Immersion learning scenario
model ImmersionScenario {
  id              String   @id @default(cuid())
  tenantId        String
  title           String
  description     String?
  targetLanguage  String
  nativeLanguage  String   @default("en")
  cefrLevel       String
  category        String
  supportedTiers  String[]
  scenes          Json
  characters      Json     @default("[]")
  estimatedMinutes Int     @default(15)
  completionCount Int      @default(0)
  averageScore    Float    @default(0)
  status          String   @default("draft")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessions ImmersionSession[]

  @@index([tenantId, targetLanguage])
  @@index([tenantId, cefrLevel])
  @@index([tenantId, status])
}

/// Active language immersion session
model ImmersionSession {
  id              String            @id @default(cuid())
  tenantId        String
  learnerId       String
  scenarioId      String
  scenario        ImmersionScenario @relation(fields: [scenarioId], references: [id])
  activeTier      String
  currentSceneId  String?
  currentNodeId   String?
  dialogueHistory Json              @default("[]")
  hintsUsed       Int               @default(0)
  currentScore    Int               @default(0)
  pronunciations  Json              @default("[]")
  vocabularyMet   String[]
  status          String            @default("active")
  startedAt       DateTime          @default(now())
  completedAt     DateTime?
  result          Json?

  @@index([tenantId, learnerId])
  @@index([tenantId, status])
}

/// Language exchange session between peers
model LanguageExchangeSession {
  id           String   @id @default(cuid())
  tenantId     String
  participants Json
  scheduledAt  DateTime
  duration     Int
  tier         String
  status       String   @default("scheduled")
  feedback     Json?
  createdAt    DateTime @default(now())

  @@index([tenantId, status])
  @@index([tenantId, scheduledAt])
}

// ============================================================================
// SCHOLARLY HOSTING - Educational Provider Web Hosting Platform
// ============================================================================

/// Educational provider (school, tutor, micro-school, etc.)
model HostingProvider {
  id       String @id @default(cuid())
  tenantId String

  // Provider type
  type String // school, micro_school, tutoring_centre, solo_tutor, homeschool_coop, curriculum_provider, enrichment, online_academy

  // Identity
  displayName String
  legalName   String?
  description String  @db.Text
  tagline     String?

  // Branding
  logoUrl    String?
  faviconUrl String?
  theme      Json    @default("{}")

  // Location(s) - stored as JSON array
  locations   Json @default("[]")
  serviceArea Json? // Geographic service area

  // Primary contact
  primaryContact Json

  // Primary domain (denormalized for quick lookup)
  primaryDomain String?

  // Quality profile (embedded for performance)
  qualityProfile Json @default("{}")

  // Features enabled for this provider
  features Json @default("{}")

  // SEO configuration
  seoConfig Json @default("{}")

  // Agent API configuration
  agentConfig Json @default("{}")

  // LIS integration identifiers
  lisIdentifiers Json?

  // Link back to Scholarly tenant
  scholarlyTenantId String?

  // Status
  status String @default("pending_setup") // pending_setup, active, suspended, archived

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  domains       HostingDomain[]
  enquiries     HostingEnquiry[]
  tourBookings  HostingTourBooking[]
  reviews       HostingReview[]
  offerings     HostingOffering[]
  qualityEvents HostingQualityEvent[]

  @@unique([tenantId, primaryDomain])
  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([primaryDomain])
  @@index([status])
}

/// Domain configuration for a provider
model HostingDomain {
  id         String @id @default(cuid())
  providerId String

  domain String @unique // e.g., school.scholarly.io or www.school.edu.au
  type   String // subdomain, custom, alias

  status            String // pending_verification, verified, failed_verification, suspended
  sslStatus         String @default("pending") // pending, provisioning, active, expiring_soon, expired, failed
  sslExpiresAt      DateTime?
  verificationToken String?
  verifiedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([domain])
  @@index([status])
}

/// Educational offering (course, tutoring package, workshop, etc.)
model HostingOffering {
  id         String @id @default(cuid())
  providerId String

  // Offering details
  type             String // school_program, course, tutoring_package, tutoring_session, workshop, camp, curriculum, assessment, enrichment_program
  name             String
  shortDescription String
  description      String  @db.Text
  slug             String

  // Target audience
  yearLevels   String[] // early_years, foundation, year_1, etc.
  subjectAreas String[]
  prerequisites String?

  // Delivery
  deliveryModes String[] // in_person, online_live, online_self_paced, hybrid, home_visit
  duration      Json? // { value: number, unit: string }
  schedule      Json? // Scheduling details

  // Pricing
  pricing Json // { type, amount, currency, inclusions, etc. }

  // Capacity
  capacity Json? // { min, max, spotsAvailable, etc. }

  // Content
  curriculum     Json? // Curriculum alignment
  learningOutcomes String[]
  materials      Json?

  // Media
  featuredImage String?
  gallery       String[]
  videoUrl      String?

  // Status
  status    String   @default("draft") // draft, published, archived
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, slug])
  @@index([providerId, status])
  @@index([providerId, type])
  @@index([status])
}

/// Enquiry from prospective parent/student
model HostingEnquiry {
  id         String @id @default(cuid())
  providerId String
  offeringId String?

  // Contact details
  contactName      String
  contactEmail     String
  contactPhone     String?
  preferredContact String @default("email")

  // Student details (optional)
  studentName      String?
  studentAge       Int?
  studentYearLevel String?

  // Enquiry details
  enquiryType String // general, enrollment, tour, pricing, availability
  message     String @db.Text

  // Source tracking
  source  String @default("website") // website, agent_api, referral, other
  agentId String? // If via agent API

  // Response
  status          String    @default("new") // new, in_progress, responded, closed
  responseMessage String?   @db.Text
  respondedAt     DateTime?
  respondedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, status])
  @@index([providerId, createdAt])
  @@index([contactEmail])
}

/// Tour/visit booking
model HostingTourBooking {
  id         String @id @default(cuid())
  providerId String
  locationId String

  // Contact details
  contactName  String
  contactEmail String
  contactPhone String?

  // Booking details
  scheduledAt   DateTime
  duration      Int      @default(60) // minutes
  tourType      String // in_person, virtual
  attendeeCount Int      @default(1)
  studentNames  String[]

  // Request details
  specialRequests String? @db.Text

  // Status
  status             String    @default("pending") // pending, confirmed, completed, cancelled, no_show
  confirmedAt        DateTime?
  completedAt        DateTime?
  cancellationReason String?

  // Provider notes
  providerNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, status])
  @@index([providerId, scheduledAt])
  @@index([contactEmail])
}

/// Review/testimonial from parent/student/alumni
model HostingReview {
  id         String @id @default(cuid())
  providerId String
  authorId   String? // If linked to a user

  // Author details
  authorType String // parent, student, staff, alumni
  authorName String?

  // Rating
  overallRating   Float // 1-5
  categoryRatings Json  @default("[]") // Array of { category, rating, weight }

  // Review content
  title   String?
  content String  @db.Text

  // Recommendation
  wouldRecommend Boolean @default(true)

  // Verification
  isVerified     Boolean   @default(false)
  verificationMethod String?
  verifiedAt     DateTime?

  // Provider response
  providerResponse    String?   @db.Text
  providerRespondedAt DateTime?

  // Engagement
  helpfulCount Int @default(0)

  // Moderation
  status         String    @default("pending") // pending, published, rejected, flagged
  moderatedAt    DateTime?
  moderationNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, status])
  @@index([providerId, overallRating])
  @@index([status])
}

/// Quality events (outcomes, accreditations, compliance records)
model HostingQualityEvent {
  id         String @id @default(cuid())
  providerId String

  eventType String // outcome, accreditation, compliance, registration, staff_qualification

  // Event data (structure depends on eventType)
  data Json

  // Verification
  isVerified     Boolean   @default(false)
  verifiedAt     DateTime?
  verifiedBy     String?
  verificationMethod String?
  supportingDocumentUrl String?

  // Validity
  validFrom DateTime?
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provider HostingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId, eventType])
  @@index([providerId, isVerified])
}

// ============================================================================
// KYC/KYB VERIFICATION MODELS
// ============================================================================

/// Identity verification record (KYC)
/// Provider-agnostic design supporting Stripe Identity, Onfido, Persona, etc.
model IdentityVerification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Provider configuration (supports multiple providers)
  provider        String // stripe_identity, onfido, persona, jumio, veriff, manual
  providerSessionId String? @unique // Provider's session/workflow ID
  providerIntentId  String? // Provider's verification intent ID
  providerAccountId String? // For multi-tenant provider accounts

  // Verification type
  verificationType String // document_only, document_and_selfie, document_and_video, enhanced

  // Personal details (captured during verification)
  firstName       String?
  lastName        String?
  dateOfBirth     DateTime?
  idNumber        String? // Encrypted/hashed
  idNumberType    String? // drivers_license, passport, national_id

  // Address details
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Document details
  documentType      String? // passport, drivers_license, id_card
  documentCountry   String?
  documentNumber    String? // Encrypted/hashed
  documentExpiresAt DateTime?
  documentFrontUrl  String? // Secure URL to document image
  documentBackUrl   String?

  // Biometric details
  selfieUrl     String?
  selfieScore   Float? // Confidence score 0-1
  livenessScore Float? // Liveness detection score 0-1

  // Verification outcome
  status       String @default("pending") // pending, processing, requires_input, verified, failed, expired
  verifiedAt   DateTime?
  failureCode  String? // document_expired, selfie_mismatch, etc.
  failureMessage String?

  // Risk assessment
  riskScore    Float? // 0-100 risk score
  riskSignals  Json   @default("[]") // Array of risk signals detected

  // Audit trail
  ipAddress    String?
  userAgent    String?
  deviceInfo   Json? // Device fingerprint data

  // Metadata
  metadata Json @default("{}")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Verification expiry (annual re-verification)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([provider, providerSessionId])
  @@index([userId, status])
}

/// Working With Children Check verification
/// Supports Australian state-based WWCC systems
model WWCCVerification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // WWCC details
  wwccNumber String  // The WWCC/Blue Card number
  state      String  // NSW, VIC, QLD, WA, SA, TAS, NT, ACT
  cardType   String? // employee, volunteer, both

  // Holder details (for verification)
  firstName   String
  lastName    String
  dateOfBirth DateTime

  // Verification status
  status             String @default("pending") // pending, checking, verified, failed, expired, revoked
  registryStatus     String? // Current status from registry (current, expired, barred, etc.)
  registryLastChecked DateTime?

  // Verification details
  verifiedAt       DateTime?
  verificationMethod String? // api_check, manual_check, employer_portal
  verifierNotes    String?

  // Validity period
  issuedAt  DateTime?
  expiresAt DateTime?

  // Employer/Organisation registration (required by some states)
  employerRegistrationNumber String?
  organisationName           String?

  // Document storage
  cardFrontUrl String? // Secure URL to card image
  cardBackUrl  String?

  // Ongoing monitoring
  lastMonitoredAt      DateTime?
  monitoringEnabled    Boolean @default(true)
  alertOnStatusChange  Boolean @default(true)

  // Failure details
  failureCode    String?
  failureMessage String?

  // Audit
  ipAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, state])
  @@index([tenantId, status])
  @@index([wwccNumber, state])
  @@index([userId, status])
  @@index([expiresAt])
}

/// Business verification (KYB) for schools, micro-schools, organisations
model BusinessVerification {
  id       String @id @default(cuid())
  tenantId String

  // Entity being verified (polymorphic)
  entityType String // micro_school, school, coop, hosting_provider, organisation
  entityId   String

  // Business identifiers (Australian)
  abn               String? // Australian Business Number
  acn               String? // Australian Company Number
  abnStatus         String? // active, cancelled
  abnStatusDate     DateTime?
  gstRegistered     Boolean?

  // Business details (from ABR/ASIC)
  legalName         String?
  tradingName       String?
  businessType      String? // sole_trader, partnership, company, trust, etc.
  businessAddress   Json?   // Full registered address
  businessStartDate DateTime?

  // ASIC details (for companies)
  asicStatus         String? // registered, deregistered, etc.
  asicRegistrationDate DateTime?
  asicReviewDate     DateTime?

  // Directors/Principals (for companies)
  directors Json @default("[]") // Array of { name, appointedDate, role }

  // Education-specific verification
  registrationAuthority String? // NESA, VRQA, QCAA, etc.
  registrationNumber    String?
  registrationStatus    String?
  registrationExpiresAt DateTime?

  // Verification outcome
  status       String @default("pending") // pending, checking, verified, failed, requires_review
  verifiedAt   DateTime?
  verifierNotes String?

  // Risk assessment
  riskLevel    String? // low, medium, high
  riskSignals  Json    @default("[]")

  // Document storage
  documents Json @default("[]") // Array of { type, url, uploadedAt }

  // Failure details
  failureCode    String?
  failureMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, entityType, entityId])
  @@index([tenantId, status])
  @@index([abn])
  @@index([entityType, entityId])
}

/// Verification document storage
/// Stores metadata for all verification-related documents
model VerificationDocument {
  id       String @id @default(cuid())
  tenantId String

  // Document ownership (polymorphic)
  ownerType String // user, organisation, identity_verification, wwcc_verification, business_verification
  ownerId   String

  // Document details
  documentType   String // passport, drivers_license, wwcc_card, abn_certificate, registration_cert, etc.
  fileName       String
  mimeType       String
  fileSize       Int    // bytes

  // Storage
  storageProvider String @default("azure") // azure, s3, gcs
  storagePath     String // Encrypted path to document
  storageUrl      String? // Temporary signed URL (expires)

  // Document metadata
  extractedData Json    @default("{}") // OCR/extracted data
  metadata      Json    @default("{}")

  // Verification
  isVerified    Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?

  // Expiry tracking
  documentExpiresAt DateTime?

  // Retention
  retentionPolicy String    @default("standard") // standard, extended, legal_hold
  deleteAfter     DateTime? // Auto-delete after this date

  // Audit
  uploadedBy    String?
  uploadedAt    DateTime @default(now())
  lastAccessedAt DateTime?
  accessCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, ownerType, ownerId])
  @@index([documentType])
  @@index([deleteAfter])
}

/// Verification audit log
/// Tracks all verification-related events for compliance
model VerificationAuditLog {
  id       String @id @default(cuid())
  tenantId String

  // Event details
  eventType    String // verification_started, document_uploaded, check_initiated, status_changed, etc.
  verificationType String // kyc, wwcc, kyb
  verificationId String // ID of the verification record

  // Actor
  actorType String // user, system, admin, api
  actorId   String?

  // Event data
  previousStatus String?
  newStatus      String?
  eventData      Json    @default("{}")
  errorDetails   Json?

  // Request context
  ipAddress String?
  userAgent String?
  requestId String?

  timestamp DateTime @default(now())

  @@index([tenantId, verificationId])
  @@index([tenantId, verificationType, timestamp])
  @@index([actorId, timestamp])
}
