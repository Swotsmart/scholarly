// ============================================================================
// SCHOLARLY DATABASE SCHEMA - ENHANCED VERSION
// PostgreSQL with Prisma ORM
// 
// ENHANCEMENTS FROM ORIGINAL:
// ✓ Added AuditLog model for compliance tracking
// ✓ Added soft delete (deletedAt) to key entities
// ✓ Extracted high-churn JSON fields into proper models:
//   - TutorAvailabilitySlot (from TutorProfile.availability)
//   - TutorPricingTier (from TutorProfile.pricing)
//   - Address (shared across entities)
// ✓ Added Subject reference table to prevent data drift
// ✓ Added missing unique constraints (ContentReview, LearningAssetRequest)
// ✓ Added LearningAssetVote model (extracted from JSON)
// ✓ Added composite indexes for common query patterns
// ✓ Fixed attentionSpan typo in LearnerProfile
// ✓ Added EduScrum models for agile learning
// ✓ Added Notification models
// ✓ Added Analytics models
// ✓ Added FeatureFlag and TenantConfiguration
// ============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUDIT & COMPLIANCE INFRASTRUCTURE
// ============================================================================

/// Comprehensive audit log for compliance with GDPR, child safety regulations,
/// and general security best practices. Every sensitive operation should be logged.
model AuditLog {
  id       String @id @default(cuid())
  tenantId String

  // Who performed the action
  userId    String? // Null for system actions
  userEmail String? // Denormalized for historical accuracy
  userRole  String? // Role at time of action

  // What happened
  action     String // create, read, update, delete, export, login, logout, permission_change
  entityType String // User, LearnerProfile, TutoringSession, etc.
  entityId   String

  // Change details
  changes  Json? // { before: {...}, after: {...} } for updates
  metadata Json? // Additional context

  // Request context
  ipAddress String?
  userAgent String?
  requestId String? // For correlating distributed operations

  // Classification
  sensitivity String @default("normal") // normal, sensitive, pii, child_data

  timestamp DateTime @default(now())

  @@index([tenantId, timestamp])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId, timestamp])
  @@index([tenantId, action, timestamp])
  @@index([sensitivity, timestamp])
}

// ============================================================================
// SHARED REFERENCE TABLES
// ============================================================================

/// Canonical subject definitions to prevent data drift between bookings and sessions
model Subject {
  id       String @id @default(cuid())
  tenantId String

  code        String // e.g., "MATH", "ENG", "SCI"
  name        String // e.g., "Mathematics", "English", "Science"
  description String?

  learningArea String? // e.g., "STEM", "Humanities", "Arts"
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tutorSubjects   TutorSubject[]
  learnerSubjects LearnerSubject[]
  bookings        Booking[]
  sessions        TutoringSession[]
  content         Content[]
  Tenant          Tenant            @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@index([learningArea])
}

/// Reusable address structure for families, schools, venues
model Address {
  id       String @id @default(cuid())
  tenantId String

  streetAddress String?
  suburb        String?
  city          String?
  state         String?
  postcode      String?
  country       String  @default("Australia")

  // Geolocation for proximity searches
  latitude  Float?
  longitude Float?

  type  String  @default("primary") // primary, mailing, venue
  label String? // "Home", "Work", etc.

  // Polymorphic ownership (only one should be set)
  homeschoolFamilyId String?           @unique
  homeschoolFamily   HomeschoolFamily? @relation(fields: [homeschoolFamilyId], references: [id], onDelete: Cascade)

  microSchoolId String?      @unique
  microSchool   MicroSchool? @relation(fields: [microSchoolId], references: [id], onDelete: Cascade)

  homeschoolCoopId String?         @unique
  homeschoolCoop   HomeschoolCoop? @relation("CoopPrimaryLocation", fields: [homeschoolCoopId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([latitude, longitude])
  @@index([postcode])
}

// ============================================================================
// TENANT & USER MODELS
// ============================================================================

model Tenant {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  domain    String?
  settings  Json      @default("{}")
  status    String    @default("active") // active, suspended, cancelled
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  subjects     Subject[]
  bookings     Booking[]
  sessions     TutoringSession[]
  content      Content[]
  standards    CurriculumStandard[]
  families     HomeschoolFamily[]
  coops        HomeschoolCoop[]
  microSchools MicroSchool[]
  reliefPools  ReliefPool[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
}

model User {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  externalId   String?
  email        String
  phone        String?
  passwordHash String?
  displayName  String
  firstName    String
  lastName     String
  avatarUrl    String?
  bio          String?

  roles        String[] @default([])
  jurisdiction String   @default("AU_NSW")

  emailVerified    Boolean @default(false)
  phoneVerified    Boolean @default(false)
  identityVerified Boolean @default(false)

  trustScore   Float @default(50)
  tokenBalance Float @default(0)

  walletAddress    String?   @unique
  walletVerifiedAt DateTime?

  status    String    @default("active")
  deletedAt DateTime?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastActiveAt DateTime?
  lastLoginAt  DateTime?

  // Profiles
  learnerProfile LearnerProfile?
  parentProfile  ParentProfile?
  tutorProfile   TutorProfile?
  creatorProfile CreatorProfile?
  reliefTeacher  ReliefTeacher?

  // Relations
  bookingsAsBooker      Booking[]              @relation("BookedBy")
  sessionsAsTutor       TutoringSession[]      @relation("SessionTutor")
  createdContent        Content[]              @relation("ContentCreator")
  contentPurchases      ContentPurchase[]      @relation("ContentBuyer")
  contentReviews        ContentReview[]
  learningAssetRequests LearningAssetRequest[] @relation("Requester")
  learningAssetVotes    LearningAssetVote[]

  refreshTokens     RefreshToken[]
  credentialNFTs    CredentialNFT[]
  onChainReputation OnChainReputation?
  tokenTransactions TokenTransaction[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([email])
  @@index([walletAddress])
  @@index([deletedAt])
}

// ============================================================================
// PROFILE MODELS
// ============================================================================

model LearnerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateOfBirth  DateTime
  yearLevel    String
  parentIds    String[] @default([])
  specialNeeds String[] @default([])

  // Learning preferences (structured - fixed typo from original)
  preferredSessionLength Int?
  preferredTimeOfDay     String?
  preferredDays          Int[]    @default([])
  learningPace           String?
  attentionSpan          String? // FIXED: was "attention span" with space
  bestMotivators         String[] @default([])

  lisProfileSharing     Json    @default("{}")
  lisProfileId          String?
  lisIntegrationEnabled Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subjects              LearnerSubject[]
  sessionParticipations SessionParticipant[]

  @@index([yearLevel])
}

model LearnerSubject {
  id        String         @id @default(cuid())
  profileId String
  profile   LearnerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject        @relation(fields: [subjectId], references: [id])

  currentLevel  String
  needsHelp     Boolean @default(false)
  canHelpOthers Boolean @default(false)

  @@unique([profileId, subjectId])
  @@index([subjectId])
}

model ParentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  childIds                String[] @default([])
  approvedTutorIds        String[] @default([])
  paymentMethodOnFile     Boolean  @default(false)
  monthlyBudget           Float?
  isHomeschoolParent      Boolean  @default(false)
  notificationPreferences Json     @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TutorProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tutorType           String    @default("professional")
  verificationStatus  String    @default("pending")
  verifiedAt          DateTime?
  profileCompleteness Float     @default(0)

  yearLevelsTeaching  String[] @default([])
  languages           String[] @default([])
  sessionTypes        String[] @default([])
  maxStudentsPerGroup Int      @default(1)

  teachingStyle Json      @default("{}")
  metrics       Json      @default("{}")
  deletedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Extracted from JSON
  availabilitySlots TutorAvailabilitySlot[]
  pricingTiers      TutorPricingTier[]

  qualifications     TutorQualification[]
  safeguardingChecks SafeguardingCheck[]
  subjects           TutorSubject[]
  bookings           Booking[]
  sessions           TutoringSession[]    @relation("SessionTutor")

  @@index([verificationStatus])
  @@index([tutorType])
  @@index([deletedAt])
}

/// Extracted from TutorProfile.availability JSON
model TutorAvailabilitySlot {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  dayOfWeek     Int // 0-6
  startTime     String // "09:00"
  endTime       String // "17:00"
  timezone      String    @default("Australia/Sydney")
  isRecurring   Boolean   @default(true)
  effectiveFrom DateTime?
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([profileId, dayOfWeek])
}

/// Extracted from TutorProfile.pricing JSON
model TutorPricingTier {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  sessionType   String
  duration      Int // minutes
  baseRate      Float
  currency      String  @default("AUD")
  groupDiscount Float   @default(0)
  maxGroupSize  Int     @default(1)
  introRate     Float?
  packageRate   Json?
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, sessionType, duration])
  @@index([profileId, isActive])
}

model TutorSubject {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject      @relation(fields: [subjectId], references: [id])

  yearLevels      String[] @default([])
  confidenceLevel Int      @default(3)
  specializations String[] @default([])
  examBoardsKnown String[] @default([])
  curriculumCodes String[] @default([])

  @@unique([profileId, subjectId])
  @@index([subjectId])
}

model TutorQualification {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type               String
  title              String
  institution        String?
  dateObtained       DateTime?
  verified           Boolean   @default(false)
  verificationMethod String?
  documentUrl        String?

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([type, verified])
}

model SafeguardingCheck {
  id        String       @id @default(cuid())
  profileId String
  profile   TutorProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type               String
  jurisdiction       String
  checkNumber        String
  verifiedAt         DateTime
  expiresAt          DateTime?
  status             String    @default("pending")
  verificationMethod String    @default("manual")
  documentUrl        String?

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([status, expiresAt])
  @@index([jurisdiction, type])
}

model CreatorProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  bio         String?
  avatarUrl   String?
  websiteUrl  String?

  totalContent   Int   @default(0)
  totalSales     Int   @default(0)
  totalDownloads Int   @default(0)
  averageRating  Float @default(0)
  totalReviews   Int   @default(0)
  totalEarnings  Float @default(0)

  level         String    @default("new")
  badges        String[]  @default([])
  featuredSince DateTime?

  subjects   String[] @default([])
  yearLevels String[] @default([])

  verificationStatus String    @default("pending")
  verifiedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([level])
  @@index([verificationStatus])
}

// ============================================================================
// BOOKING & SESSION MODELS
// ============================================================================

model Booking {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  tutorId        String
  tutor          TutorProfile @relation(fields: [tutorId], references: [id])
  bookedByUserId String
  bookedByUser   User         @relation("BookedBy", fields: [bookedByUserId], references: [id])

  learnerIds     String[] @default([])
  scheduledStart DateTime
  scheduledEnd   DateTime
  timezone       String   @default("Australia/Sydney")

  sessionType String
  subjectId   String
  subject     Subject @relation(fields: [subjectId], references: [id])

  topicsNeedingHelp String[] @default([])
  curriculumCodes   String[] @default([])
  learnerNotes      String?

  isGroupSession Boolean @default(false)
  openToOthers   Boolean @default(false)
  maxGroupSize   Int     @default(1)

  pricing Json

  status             String    @default("pending")
  cancellationReason String?
  cancelledBy        String?
  cancelledAt        DateTime?

  paymentStatus String  @default("pending")
  paymentId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session           TutoringSession?
  escrowTransaction EscrowTransaction?

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tutorId])
  @@index([tutorId, scheduledStart])
  @@index([scheduledStart])
  @@index([tenantId, status, scheduledStart])
}

model TutoringSession {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  tutorProfileId String
  tutorProfile   TutorProfile @relation("SessionTutor", fields: [tutorProfileId], references: [id])
  tutorUserId    String
  tutorUser      User         @relation("SessionTutor", fields: [tutorUserId], references: [id])

  scheduledStart DateTime
  scheduledEnd   DateTime
  actualStart    DateTime?
  actualEnd      DateTime?
  timezone       String

  sessionType    String
  isGroupSession Boolean @default(false)
  location       Json?
  videoRoomUrl   String?

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  topicsFocus     String[] @default([])
  curriculumCodes String[] @default([])

  status String @default("scheduled")

  preworkAssigned  String?
  sessionNotes     String?  @db.Text
  homeworkAssigned String?
  resourcesShared  String[] @default([])

  tutorFeedback    Json?
  learnerFeedback  Json?
  parentFeedback   Json?
  lisSessionReport Json?

  billingStatus      String @default("pending")
  amountCharged      Float  @default(0)
  tutorEarnings      Float  @default(0)
  platformCommission Float  @default(0)
  tokenRewards       Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants SessionParticipant[]

  @@index([tenantId])
  @@index([tutorProfileId])
  @@index([tutorProfileId, scheduledStart, status])
  @@index([scheduledStart])
  @@index([status])
}

model SessionParticipant {
  id               String          @id @default(cuid())
  sessionId        String
  session          TutoringSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  learnerProfileId String
  learnerProfile   LearnerProfile  @relation(fields: [learnerProfileId], references: [id])

  attended Boolean @default(false)
  feedback Json?

  @@unique([sessionId, learnerProfileId])
  @@index([learnerProfileId])
}

// ============================================================================
// CURRICULUM MODELS
// ============================================================================

model CurriculumStandard {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  framework  String
  code       String
  externalId String?
  uri        String?

  type         String
  learningArea String
  subject      String
  strand       String?
  substrand    String?

  yearLevels     String[] @default([])
  bandDescriptor String?

  title               String
  description         String   @db.Text
  elaborations        String[] @default([])
  contentDescriptions String[] @default([])

  bloomsLevel    String?
  cognitiveVerbs String[] @default([])
  skills         String[] @default([])
  concepts       String[] @default([])
  keywords       String[] @default([])

  prerequisites             String[] @default([])
  relatedStandards          String[] @default([])
  crossCurricularLinks      Json     @default("[]")
  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  embedding Float[] @default([])

  source        String
  version       String
  effectiveFrom DateTime?
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alignments  ContentAlignment[]
  lessonPlans LessonPlanStandard[]

  @@unique([tenantId, framework, code])
  @@index([tenantId])
  @@index([framework])
  @@index([learningArea])
  @@index([subject])
  @@index([yearLevels])
}

model LessonPlan {
  id       String @id @default(cuid())
  tenantId String

  title       String
  description String @db.Text
  yearLevel   String
  subject     String
  duration    Int

  learningIntentions        String[] @default([])
  successCriteria           String[] @default([])
  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  sections                   Json
  differentiation            Json
  resources                  Json @default("[]")
  assessmentOpportunities    Json @default("[]")
  crossCurricularConnections Json @default("[]")

  generatedBy      String  @default("ai")
  generationPrompt String?
  qualityScore     Float?

  status    String @default("draft")
  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  standards LessonPlanStandard[]

  @@index([tenantId])
  @@index([subject])
  @@index([yearLevel])
  @@index([status])
}

model LessonPlanStandard {
  id           String             @id @default(cuid())
  lessonPlanId String
  lessonPlan   LessonPlan         @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  standardId   String
  standard     CurriculumStandard @relation(fields: [standardId], references: [id])

  @@unique([lessonPlanId, standardId])
}

// ============================================================================
// CONTENT MARKETPLACE MODELS
// ============================================================================

model Content {
  id        String @id @default(cuid())
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creatorId String
  creator   User   @relation("ContentCreator", fields: [creatorId], references: [id])

  title       String
  description String @db.Text
  type        String

  thumbnailUrl String?
  previewUrl   String?

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  subjects             String[] @default([])
  yearLevels           String[] @default([])
  curriculumFrameworks String[] @default([])
  curriculumCodes      String[] @default([])
  generalCapabilities  String[] @default([])

  format    String
  fileSize  Int?
  pageCount Int?
  duration  Int?

  pricing Json
  license Json

  qualityScore  Float @default(0)
  reviewCount   Int   @default(0)
  averageRating Float @default(0)
  downloadCount Int   @default(0)
  purchaseCount Int   @default(0)

  tags           String[] @default([])
  keywords       String[] @default([])
  searchableText String   @db.Text
  embedding      Float[]  @default([])

  status      String    @default("draft")
  publishedAt DateTime?
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alignments ContentAlignment[]
  reviews    ContentReview[]
  purchases  ContentPurchase[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, status, subjects])
  @@index([tenantId, status, yearLevels])
  @@index([creatorId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
}

model ContentAlignment {
  id         String             @id @default(cuid())
  contentId  String
  content    Content            @relation(fields: [contentId], references: [id], onDelete: Cascade)
  standardId String
  standard   CurriculumStandard @relation(fields: [standardId], references: [id])

  alignmentScore  Float
  alignmentMethod String
  conceptsMatched String[] @default([])
  skillsMatched   String[] @default([])
  confidence      Float

  verifiedBy String?
  verifiedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([contentId, standardId])
}

model ContentReview {
  id         String  @id @default(cuid())
  contentId  String
  content    Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User    @relation(fields: [reviewerId], references: [id])

  rating  Int
  title   String?
  comment String? @db.Text

  // NEW: Structured feedback aligned with service
  topicsWellCovered  String[] @default([])
  topicsNeedMoreWork String[] @default([])
  wouldRecommend     Boolean  @default(true)

  helpfulCount    Int     @default(0)
  notHelpfulCount Int     @default(0)
  verified        Boolean @default(false)
  yearLevelUsed   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contentId, reviewerId]) // ADDED: Prevent duplicate reviews
  @@index([contentId])
  @@index([reviewerId])
  @@index([rating])
}

model ContentPurchase {
  id        String  @id @default(cuid())
  tenantId  String
  contentId String
  content   Content @relation(fields: [contentId], references: [id])
  buyerId   String
  buyer     User    @relation("ContentBuyer", fields: [buyerId], references: [id])

  price           Float
  currency        String
  tokenAmount     Float  @default(0)
  platformFee     Float
  creatorEarnings Float
  tokenRewards    Float  @default(0)

  downloadCount Int @default(0)
  maxDownloads  Int @default(5)

  status String @default("completed")

  purchasedAt      DateTime  @default(now())
  lastDownloadedAt DateTime?

  @@unique([contentId, buyerId]) // ADDED: One purchase per user
  @@index([tenantId])
  @@index([buyerId])
  @@index([contentId])
}

model LearningAssetRequest {
  id          String @id @default(cuid())
  tenantId    String
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  title           String
  description     String    @db.Text
  type            String
  subjects        String[]  @default([])
  yearLevels      String[]  @default([])
  curriculumCodes String[]  @default([])
  specifications  String[]  @default([])
  preferredFormat String?
  budgetMin       Float?
  budgetMax       Float?
  deadline        DateTime?

  voteCount Int @default(0)

  status                String    @default("open")
  fulfilledByContentIds String[]  @default([])
  fulfilledAt           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes LearningAssetVote[]

  @@unique([tenantId, requesterId, title]) // ADDED: Prevent duplicates
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([status])
}

/// NEW: Extracted from LearningAssetRequest.votes JSON
model LearningAssetVote {
  id        String               @id @default(cuid())
  requestId String
  request   LearningAssetRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  userId    String
  user      User                 @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([requestId, userId])
  @@index([requestId])
  @@index([userId])
}

// ============================================================================
// HOMESCHOOL MODELS
// ============================================================================

model HomeschoolFamily {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  primaryContactUserId String
  primaryContactName   String
  primaryContactEmail  String
  primaryContactPhone  String?

  additionalContacts Json @default("[]")

  educationalPhilosophy String?
  curriculumApproach    String?
  teachingCapabilities  Json    @default("[]")

  coopPreferences Json @default("{}")
  compliance      Json @default("{}")
  aiProfile       Json @default("{}")

  status       String    @default("active")
  joinedAt     DateTime  @default(now())
  lastActiveAt DateTime  @default(now())
  deletedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location               Address?
  children               HomeschoolChild[]
  coopMemberships        CoopMember[]
  excursionRegistrations ExcursionRegistration[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model HomeschoolChild {
  id       String           @id @default(cuid())
  familyId String
  family   HomeschoolFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)

  name             String
  dateOfBirth      DateTime
  currentYearLevel String

  learningStyle  String?
  interests      String[] @default([])
  strengths      String[] @default([])
  challengeAreas String[] @default([])
  specialNeeds   String[] @default([])

  curriculumFramework String @default("ACARA")
  subjectProgress     Json   @default("[]")

  lisProfileId          String?
  lisIntegrationEnabled Boolean @default(false)

  friendConnections String[] @default([])
  coopParticipation String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([familyId])
  @@index([currentYearLevel])
}

model HomeschoolCoop {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String @db.Text
  philosophy  String

  meetingLocations Json @default("[]")

  maxFamilies   Int    @default(10)
  membershipFee Float?

  meetingSchedule       Json
  subjects              String[] @default([])
  ageRange              Json
  educationalApproaches String[] @default([])

  structure Json
  roles     Json @default("[]")

  status    String    @default("forming")
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  primaryLocation Address?     @relation("CoopPrimaryLocation")
  members         CoopMember[]
  excursions      Excursion[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model CoopMember {
  id       String           @id @default(cuid())
  coopId   String
  coop     HomeschoolCoop   @relation(fields: [coopId], references: [id], onDelete: Cascade)
  familyId String
  family   HomeschoolFamily @relation(fields: [familyId], references: [id])

  role             String   @default("member")
  teachingSubjects String[] @default([])
  joinedAt         DateTime @default(now())
  status           String   @default("active")

  @@unique([coopId, familyId])
  @@index([familyId])
}

model Excursion {
  id          String          @id @default(cuid())
  tenantId    String
  organizerId String
  coopId      String?
  coop        HomeschoolCoop? @relation(fields: [coopId], references: [id])

  title                 String
  description           String   @db.Text
  venue                 Json
  curriculumConnections Json     @default("[]")
  learningObjectives    String[] @default([])

  date           DateTime
  startTime      String
  endTime        String
  meetingPoint   String
  transportation String

  minParticipants Int
  maxParticipants Int
  costPerChild    Float     @default(0)
  costPerAdult    Float     @default(0)
  paymentDeadline DateTime?

  waitlist String[] @default([])

  preActivities  String[] @default([])
  postActivities String[] @default([])

  status String @default("planning")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  registrations ExcursionRegistration[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([date])
  @@index([coopId])
}

model ExcursionRegistration {
  id          String           @id @default(cuid())
  excursionId String
  excursion   Excursion        @relation(fields: [excursionId], references: [id], onDelete: Cascade)
  familyId    String
  family      HomeschoolFamily @relation(fields: [familyId], references: [id])

  childrenIds         String[] @default([])
  adultsAttending     Int      @default(1)
  dietaryRequirements String?
  medicalNotes        String?
  emergencyContact    String

  paymentStatus String   @default("pending")
  registeredAt  DateTime @default(now())

  @@unique([excursionId, familyId])
  @@index([familyId])
}

// ============================================================================
// MICRO-SCHOOL MODELS
// ============================================================================

model MicroSchool {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name             String
  description      String @db.Text
  philosophy       String
  educationalModel String

  facilities  Json  @default("[]")
  legalEntity Json?
  compliance  Json

  founderId          String
  enrollmentCapacity Int    @default(20)

  curriculumFramework String   @default("ACARA")
  subjects            String[] @default([])
  yearLevelsOffered   String[] @default([])

  schedule    Json
  termDates   Json @default("[]")
  tuitionFees Json

  healthAnalysis Json?

  status      String    @default("forming")
  foundedDate DateTime?
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location     Address?
  staff        MicroSchoolStaff[]
  students     MicroSchoolStudent[]
  applications EnrollmentApplication[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([deletedAt])
}

model MicroSchoolStaff {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userId   String

  name           String
  email          String
  phone          String?
  role           String
  employmentType String

  qualifications        Json     @default("[]")
  teachingSubjects      String[] @default([])
  yearLevelCapabilities String[] @default([])

  safeguardingCheck     Json?
  firstAidCertification Json?
  teachingRegistration  Json?

  status    String    @default("active")
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, userId])
  @@index([schoolId])
  @@index([schoolId, status])
}

model MicroSchoolStudent {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  familyId String

  name        String
  dateOfBirth DateTime
  yearLevel   String

  enrollmentStatus String    @default("enrolled")
  enrollmentDate   DateTime?
  withdrawalDate   DateTime?

  learningProfile    Json?
  medicalInformation Json?
  emergencyContacts  Json  @default("[]")

  lisProfileId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, familyId, name])
  @@index([schoolId])
  @@index([schoolId, enrollmentStatus])
}

model EnrollmentApplication {
  id       String      @id @default(cuid())
  schoolId String
  school   MicroSchool @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  familyId String

  studentName        String
  studentDob         DateTime
  requestedYearLevel String
  requestedStartDate DateTime

  reasonForEnrolling String  @db.Text
  previousSchooling  String  @db.Text
  learningNeeds      String?
  additionalInfo     String?

  parentConsent    Boolean   @default(false)
  consentTimestamp DateTime?
  documents        Json      @default("[]")

  status      String    @default("submitted")
  reviewNotes String?   @db.Text
  reviewedBy  String?
  reviewedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, familyId, studentName])
  @@index([schoolId])
  @@index([schoolId, status])
}

// ============================================================================
// RELIEF MARKETPLACE MODELS
// ============================================================================

model ReliefTeacher {
  id       String @id @default(cuid())
  tenantId String
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  email       String
  phone       String?
  avatarUrl   String?

  location             Json
  qualifications       Json @default("[]")
  teachingRegistration Json
  safeguardingCheck    Json

  subjects        String[] @default([])
  yearLevels      String[] @default([])
  specializations String[] @default([])

  availability     Json
  preferredSchools String[] @default([])
  excludedSchools  String[] @default([])

  metrics   Json   @default("{}")
  tier      String @default("standard")
  aiProfile Json   @default("{}")

  status     String    @default("pending_verification")
  verifiedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poolMemberships ReliefPoolMember[]
  assignments     ReliefAssignment[]
  bookings        ReliefBooking[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tier])
  @@index([deletedAt])
}

model ReliefPool {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolId String

  name              String
  config            Json
  autonomousActions Json   @default("{}")
  statistics        Json   @default("{}")

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members ReliefPoolMember[]

  @@unique([tenantId, schoolId])
  @@index([tenantId])
}

model ReliefPoolMember {
  id              String        @id @default(cuid())
  poolId          String
  pool            ReliefPool    @relation(fields: [poolId], references: [id], onDelete: Cascade)
  reliefTeacherId String
  reliefTeacher   ReliefTeacher @relation(fields: [reliefTeacherId], references: [id])

  tier         String    @default("standard")
  priority     Int       @default(1)
  schoolRating Float?
  lastBookedAt DateTime?
  joinedAt     DateTime  @default(now())

  @@unique([poolId, reliefTeacherId])
  @@index([reliefTeacherId])
}

model TeacherAbsence {
  id          String @id @default(cuid())
  tenantId    String
  schoolId    String
  teacherId   String
  teacherName String

  date      DateTime
  startTime String
  endTime   String
  isFullDay Boolean  @default(true)
  reason    String
  notes     String?

  coverageRequired Json   @default("[]")
  status           String @default("reported")

  wasPredicted         Boolean @default(false)
  predictionConfidence Float?

  reportedAt DateTime @default(now())
  reportedBy String
  updatedAt  DateTime @updatedAt

  assignments   ReliefAssignment[]
  notifications AbsenceNotification[]

  @@index([tenantId])
  @@index([tenantId, schoolId])
  @@index([schoolId])
  @@index([date])
  @@index([tenantId, date, status])
}

model ReliefAssignment {
  id              String         @id @default(cuid())
  absenceId       String
  absence         TeacherAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)
  reliefTeacherId String
  reliefTeacher   ReliefTeacher  @relation(fields: [reliefTeacherId], references: [id])

  coverageRequirementIds String[] @default([])

  status      String    @default("offered")
  offeredAt   DateTime  @default(now())
  respondedAt DateTime?
  confirmedAt DateTime?
  completedAt DateTime?

  rating   Int?
  feedback String?

  @@index([absenceId])
  @@index([reliefTeacherId])
  @@index([status])
}

model ReliefBooking {
  id              String        @id @default(cuid())
  tenantId        String
  schoolId        String
  absenceId       String
  reliefTeacherId String
  reliefTeacher   ReliefTeacher @relation(fields: [reliefTeacherId], references: [id])

  date       DateTime
  periods    Json
  totalHours Float

  hourlyRate    Float
  totalAmount   Float
  paymentStatus String @default("pending")

  status String @default("confirmed")

  schoolRating    Int?
  schoolFeedback  String?
  teacherRating   Int?
  teacherFeedback String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([date])
  @@index([reliefTeacherId])
}

model AbsenceNotification {
  id        String         @id @default(cuid())
  absenceId String
  absence   TeacherAbsence @relation(fields: [absenceId], references: [id], onDelete: Cascade)

  recipientId   String
  recipientType String
  channel       String
  type          String

  status      String    @default("sent")
  sentAt      DateTime  @default(now())
  deliveredAt DateTime?
  readAt      DateTime?

  @@index([absenceId])
  @@index([recipientId])
}

model AbsencePrediction {
  id       String   @id @default(cuid())
  tenantId String
  schoolId String
  date     DateTime

  predictedAbsences Json
  totalPredicted    Int
  confidence        Float
  factors           Json  @default("[]")
  recommendations   Json  @default("[]")

  generatedAt DateTime @default(now())

  @@unique([tenantId, schoolId, date])
  @@index([date])
}

// ============================================================================
// AUTHENTICATION MODELS
// ============================================================================

model RefreshToken {
  id          String @id @default(cuid())
  tokenFamily String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  hashedToken String    @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  replacedBy  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenFamily])
  @@index([hashedToken])
  @@index([expiresAt])
}

// ============================================================================
// BLOCKCHAIN MODELS
// ============================================================================

model CredentialNFT {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenId         BigInt @unique
  contractAddress String
  credentialType  String

  metadata Json
  dataHash String

  issuedAt         DateTime  @default(now())
  expiresAt        DateTime?
  revokedAt        DateTime?
  revocationReason String?

  mintTxHash   String
  revokeTxHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([credentialType])
  @@index([tokenId])
  @@index([contractAddress])
}

model EscrowTransaction {
  id       String @id @default(cuid())
  tenantId String

  escrowId  String  @unique
  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  learnerId     String
  tutorId       String
  learnerWallet String
  tutorWallet   String

  amount         Decimal @db.Decimal(36, 18)
  platformFeeBps Int     @default(500)
  platformFee    Decimal @db.Decimal(36, 18)
  tutorAmount    Decimal @db.Decimal(36, 18)

  status String @default("created")

  createTxHash  String?
  fundTxHash    String?
  releaseTxHash String?
  refundTxHash  String?

  disputeReason     String?
  disputeRaisedAt   DateTime?
  disputeResolvedAt DateTime?
  disputeResolution Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([learnerId])
  @@index([tutorId])
  @@index([status])
}

model OnChainReputation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  walletAddress String @unique

  onChainScore      Int @default(0)
  totalSessions     Int @default(0)
  completedSessions Int @default(0)
  totalRatings      Int @default(0)
  ratingSum         Int @default(0)
  disputesWon       Int @default(0)
  disputesLost      Int @default(0)

  completionRate Float   @default(0)
  averageRating  Decimal @default(0) @db.Decimal(3, 2)

  lastSyncedAt   DateTime @default(now())
  lastSyncTxHash String?
  syncErrorCount Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletAddress])
  @@index([onChainScore])
}

model TokenTransaction {
  id       String @id @default(cuid())
  tenantId String
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  type        String
  amount      Decimal @db.Decimal(36, 18)
  fromAddress String?
  toAddress   String

  referenceType String?
  referenceId   String?

  txHash      String  @unique
  blockNumber Int?
  gasUsed     String?

  status String @default("pending")

  createdAt   DateTime  @default(now())
  confirmedAt DateTime?

  @@index([userId])
  @@index([txHash])
  @@index([type])
  @@index([status])
  @@index([tenantId, type, createdAt])
}

// ============================================================================
// Continue in Part 2...
// ============================================================================

// ============================================================================
// AI BUDDY MODELS
// ============================================================================

model AIBuddyConversation {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  role     String
  title    String
  messages Json
  context  Json

  status String @default("active")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([userId])
  @@index([status])
  @@index([lastMessageAt])
}

model AIBuddySettings {
  id       String @id @default(cuid())
  userId   String
  tenantId String

  responseStyle       String  @default("encouraging")
  verbosityLevel      String  @default("concise")
  useEmojis           Boolean @default(true)
  includeExamples     Boolean @default(true)
  provideChallenges   Boolean @default(true)
  reminderFrequency   String  @default("none")
  parentNotifications Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
}

// ============================================================================
// DIGITAL PORTFOLIO MODELS
// ============================================================================

model Portfolio {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  displayName   String
  bio           String?
  avatarUrl     String?
  coverImageUrl String?

  visibility String @default("private")
  theme      Json
  sections   Json
  stats      Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  artifacts    Artifact[]
  goals        LearningGoal[]
  achievements Achievement[]
  journeys     LearningJourney[]

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([visibility])
}

model Artifact {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String? @db.Text
  type        String

  content             Json
  metadata            Json
  reflection          Json?
  curriculumAlignment Json?
  feedback            Json  @default("[]")

  tags       String[] @default([])
  status     String   @default("draft")
  visibility String   @default("private")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([status])
}

model LearningGoal {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String    @db.Text
  category    String
  subject     String?
  targetDate  DateTime?

  status   String @default("not_started")
  progress Int    @default(0)

  milestones       Json     @default("[]")
  relatedArtifacts String[] @default([])
  curriculumCodes  String[] @default([])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model Achievement {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  type        String
  title       String
  description String
  imageUrl    String

  earnedAt DateTime
  issuedBy String
  criteria String
  evidence String[] @default([])

  blockchain Json?

  createdAt DateTime @default(now())

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([type])
}

model LearningJourney {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  tenantId    String
  userId      String

  title       String
  description String  @db.Text
  subject     String?

  startDate DateTime
  endDate   DateTime?
  status    String    @default("active")

  path              Json
  currentNode       String
  aiRecommendations Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portfolioId])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// ============================================================================
// EDUSCRUM / AGILE LEARNING MODELS (NEW)
// ============================================================================

model EduScrumTeam {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?

  scrumMasterId  String
  productOwnerId String?
  memberIds      String[] @default([])

  velocity      Float  @default(0)
  maturityLevel String @default("forming")
  healthScore   Float  @default(0)

  sprintDuration  Int   @default(14)
  standupSchedule Json?

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sprints        EduScrumSprint[]
  retrospectives EduScrumRetrospective[]

  @@index([tenantId])
  @@index([tenantId, status])
}

model EduScrumSprint {
  id       String       @id @default(cuid())
  tenantId String
  teamId   String
  team     EduScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  name         String
  goal         String @db.Text
  sprintNumber Int

  startDate DateTime
  endDate   DateTime

  backlogItems     Json @default("[]")
  totalStoryPoints Int  @default(0)
  completedPoints  Int  @default(0)

  standups     Json  @default("[]")
  burndownData Json  @default("[]")
  aiInsights   Json?

  status String @default("planning")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, sprintNumber])
  @@index([tenantId])
  @@index([teamId])
  @@index([status])
}

model EduScrumRetrospective {
  id       String       @id @default(cuid())
  tenantId String
  teamId   String
  team     EduScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sprintId String?

  wentWell    Json @default("[]")
  toImprove   Json @default("[]")
  actionItems Json @default("[]")

  participantIds String[] @default([])
  facilitatorId  String

  aiSummary         String? @db.Text
  aiRecommendations Json    @default("[]")
  teamDynamicsScore Float?

  conductedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([teamId])
  @@index([sprintId])
}

// ============================================================================
// COMPLIANCE MODELS
// ============================================================================

model ComplianceCheck {
  id       String @id @default(cuid())
  tenantId String

  entityType String
  entityId   String
  framework  String
  ruleId     String

  status   String
  details  String @db.Text
  evidence Json?

  checkedAt           DateTime  @default(now())
  checkedBy           String
  remediationRequired Boolean   @default(false)
  remediationDeadline DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([entityType, entityId])
  @@index([framework])
  @@index([status])
}

model ComplianceReport {
  id       String @id @default(cuid())
  tenantId String

  reportType String
  period     Json
  frameworks String[] @default([])

  summary         Json
  checkIds        String[] @default([])
  recommendations Json     @default("[]")
  certifications  Json     @default("[]")

  generatedAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, generatedAt])
}

model ACARACurriculumCode {
  id           String  @id @default(cuid())
  code         String  @unique
  learningArea String
  subject      String
  yearLevel    String
  strand       String
  subStrand    String?

  description         String   @db.Text
  elaborations        String[] @default([])
  achievementStandard String   @db.Text

  generalCapabilities       String[] @default([])
  crossCurriculumPriorities String[] @default([])

  source        String    @default("ACARA")
  version       String
  effectiveFrom DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([learningArea])
  @@index([subject])
  @@index([yearLevel])
  @@index([strand])
}

// ============================================================================
// NOTIFICATION MODELS (NEW)
// ============================================================================

model Notification {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  type  String
  title String
  body  String @db.Text
  data  Json?

  channels String[] @default(["in_app"])
  priority String   @default("normal")

  inAppStatus String  @default("unread")
  emailStatus String?
  smsStatus   String?
  pushStatus  String?

  scheduledFor DateTime?
  sentAt       DateTime?
  readAt       DateTime?

  groupKey String?

  createdAt DateTime @default(now())

  @@index([tenantId, userId])
  @@index([userId, inAppStatus])
  @@index([userId, createdAt])
  @@index([type])
  @@index([scheduledFor])
}

model NotificationPreference {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  categoryPreferences Json @default("{}")

  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  timezone          String  @default("Australia/Sydney")

  digestEnabled   Boolean @default(false)
  digestFrequency String?
  digestTime      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, userId])
  @@index([userId])
}

// ============================================================================
// ANALYTICS MODELS (NEW)
// ============================================================================

model AnalyticsEvent {
  id       String @id @default(cuid())
  tenantId String

  eventType String
  eventName String

  userId    String?
  sessionId String?

  entityType String?
  entityId   String?

  properties Json @default("{}")

  deviceType String?
  browser    String?
  os         String?

  country String?
  region  String?

  timestamp DateTime @default(now())

  @@index([tenantId, timestamp])
  @@index([tenantId, eventType, timestamp])
  @@index([tenantId, userId, timestamp])
  @@index([entityType, entityId])
}

model ReportDefinition {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?

  reportType String
  parameters Json
  filters    Json   @default("{}")
  columns    Json

  isScheduled Boolean  @default(false)
  schedule    Json?
  recipients  String[] @default([])

  createdBy  String
  isPublic   Boolean  @default(false)
  sharedWith String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  executions ReportExecution[]

  @@index([tenantId])
  @@index([tenantId, reportType])
  @@index([createdBy])
}

model ReportExecution {
  id       String           @id @default(cuid())
  tenantId String
  reportId String
  report   ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)

  parameters Json
  filters    Json

  status        String  @default("pending")
  resultSummary Json?
  resultFileUrl String?
  rowCount      Int?

  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?

  errorMessage String?

  executedBy String?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([reportId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// FEATURE FLAGS & CONFIGURATION (NEW)
// ============================================================================

model FeatureFlag {
  id String @id @default(cuid())

  key         String  @unique
  name        String
  description String?

  isEnabled         Boolean @default(false)
  rules             Json    @default("[]")
  rolloutPercentage Int     @default(0)

  category String?
  owner    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isEnabled])
  @@index([category])
}

model TenantConfiguration {
  id       String @id @default(cuid())
  tenantId String @unique

  branding         Json     @default("{}")
  enabledFeatures  String[] @default([])
  disabledFeatures String[] @default([])
  limits           Json     @default("{}")
  integrations     Json     @default("{}")

  dataRetentionDays Int     @default(2555)
  gdprEnabled       Boolean @default(true)

  billingPlan  String @default("free")
  billingCycle String @default("monthly")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([billingPlan])
}

// ============================================================================
// DATA MIGRATION TRACKING
// ============================================================================

model DataMigration {
  id String @id @default(cuid())

  name        String  @unique
  description String?

  status      String    @default("pending")
  startedAt   DateTime?
  completedAt DateTime?

  totalRecords     Int?
  processedRecords Int  @default(0)
  failedRecords    Int  @default(0)

  resultSummary Json?
  errorLog      Json  @default("[]")

  isReversible Boolean @default(false)
  rollbackData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}
